<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AbSgram 7.0 PROüî• - –†–ê–ë–û–ß–ò–ï –ó–í–û–ù–ö–ò</title>
    <style>
        /* ========== –°–¢–ò–õ–ò –ü–û–õ–ù–û–°–¢–¨–Æ (–û—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞) ========== */
        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --primary-light: #FF8E53;
            --dark: #1A1A1A;
            --sidebar: #252525;
            --message-out: #FF6B35;
            --message-in: #333333;
            --text: #F5F5F5;
            --text-secondary: #AAAAAA;
            --success: #4CAF50;
            --error: #F44336;
            --warning: #FF9800;
            --info: #2196F3;
            --group: #FFB347;
            --voice: #9C27B0;
            --call: #00BCD4;
            --video-call: #E91E63;
            --channel: #8BC34A;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--dark);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, #1A1A1A 0%, #2D1B0E 100%);
        }
        
        .screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .hidden {
            display: none !important;
        }
        
        .header {
            background: var(--sidebar);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255,107,53,0.2);
            background: linear-gradient(90deg, #252525 0%, #2A1E16 100%);
        }
        
        .header-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
            flex: 1;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(255,107,53,0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,107,53,0.4);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(255,107,53,0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background: rgba(255,107,53,0.1);
            color: var(--primary);
        }
        
        .search-container {
            padding: 15px;
            background: var(--sidebar);
            border-bottom: 1px solid rgba(255,107,53,0.1);
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 20px 14px 45px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,107,53,0.3);
            border-radius: 30px;
            color: var(--text);
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            border-color: var(--primary);
            background: rgba(255,107,53,0.05);
            box-shadow: 0 0 0 3px rgba(255,107,53,0.1);
        }
        
        .search-input::placeholder {
            color: var(--text-secondary);
        }
        
        .search-icon {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 18px;
            z-index: 1;
        }
        
        .users-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: transparent;
        }
        
        .users-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .users-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        
        .users-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        .user-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            align-items: center;
            transition: all 0.3s;
            border-radius: 15px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.03);
        }
        
        .user-item:hover {
            background: rgba(255,107,53,0.1);
            transform: translateX(5px);
        }
        
        .user-item:active {
            transform: translateX(5px) scale(0.98);
        }
        
        .user-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 22px;
            margin-right: 15px;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .user-info {
            flex: 1;
            min-width: 0;
        }
        
        .user-name {
            font-weight: 700;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 16px;
            color: var(--text);
        }
        
        .user-username {
            color: var(--primary-light);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }
        
        .user-status {
            font-size: 13px;
            font-weight: 600;
        }
        
        .user-status.online {
            color: var(--success);
        }
        
        .user-status.offline {
            color: var(--text-secondary);
        }
        
        .auth-form {
            background: linear-gradient(135deg, var(--sidebar) 0%, #2A1E16 100%);
            padding: 40px;
            border-radius: 25px;
            width: 90%;
            max-width: 420px;
            margin: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,107,53,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .auth-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        }
        
        .logo {
            text-align: center;
            margin-bottom: 35px;
        }
        
        .logo-icon {
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 800;
            margin: 0 auto 20px;
            color: white;
            box-shadow: 0 10px 30px rgba(255,107,53,0.4);
        }
        
        .logo h2 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        
        .logo p {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 300;
        }
        
        .input-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }
        
        .input-group input {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            color: var(--text);
            font-size: 16px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255,107,53,0.05);
            box-shadow: 0 0 0 4px rgba(255,107,53,0.1);
        }
        
        .input-group input::placeholder {
            color: rgba(255,255,255,0.3);
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 25px;
            color: var(--text-secondary);
            font-size: 15px;
        }
        
        .auth-toggle a {
            color: var(--primary);
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .auth-toggle a:hover {
            text-decoration: underline;
            color: var(--primary-light);
        }
        
        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: transparent;
        }
        
        .chats-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .chats-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        
        .chats-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        .chat-item {
            display: flex;
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            align-items: center;
            transition: all 0.3s;
            border-radius: 15px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.03);
            position: relative;
        }
        
        .chat-item:hover {
            background: rgba(255,107,53,0.1);
            transform: translateX(5px);
        }
        
        .chat-item:active {
            transform: translateX(5px) scale(0.98);
        }
        
        .chat-item.active {
            background: rgba(255,107,53,0.15);
            border-left: 4px solid var(--primary);
            box-shadow: 0 5px 15px rgba(255,107,53,0.2);
        }
        
        .chat-item.group-chat {
            border-left: 4px solid var(--group);
        }

        .chat-item.channel {
            border-left: 4px solid var(--channel);
        }
        
        .chat-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 22px;
            margin-right: 15px;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .group-avatar {
            background: var(--group);
            border-color: var(--group);
        }

        .channel-avatar {
            background: var(--channel);
            border-color: var(--channel);
        }
        
        .chat-info {
            flex: 1;
            min-width: 0;
        }
        
        .chat-name {
            font-weight: 700;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 16px;
            color: var(--text);
        }
        
        .chat-last {
            color: var(--text-secondary);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .chat-time {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .chat-unread-badge {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            margin-left: auto;
            margin-right: 10px;
            box-shadow: 0 2px 5px rgba(255,107,53,0.3);
        }
        
        .chat-unread-mention {
            background: linear-gradient(135deg, var(--error) 0%, #D32F2F 100%);
        }
        
        .new-chat-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(255,107,53,0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            color: white;
            z-index: 100;
            font-weight: bold;
        }
        
        .new-chat-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 30px rgba(255,107,53,0.6);
        }
        
        .messages-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: linear-gradient(135deg, #1A1A1A 0%, #2D1B0E 100%);
        }
        
        .messages-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .messages-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        
        .messages-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        .message {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: 20px;
            word-wrap: break-word;
            position: relative;
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            line-height: 1.5;
            transition: opacity 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-out {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--message-out) 0%, var(--primary-dark) 100%);
            border-bottom-right-radius: 5px;
            color: white;
            box-shadow: 0 4px 15px rgba(255,107,53,0.3);
        }
        
        .message-in {
            align-self: flex-start;
            background: var(--message-in);
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(255,107,53,0.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .message-time {
            font-size: 11px;
            text-align: right;
            margin-top: 8px;
            opacity: 0.8;
            font-weight: 500;
        }
        
        .message-in .message-time {
            color: var(--text-secondary);
        }
        
        .message-out .message-time {
            color: rgba(255,255,255,0.8);
        }
        
        .message-sender {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
            color: var(--primary-light);
        }
        
        .message-status {
            display: inline-block;
            margin-left: 6px;
            font-size: 12px;
        }
        
        .status-sent {
            opacity: 0.6;
        }
        
        .status-read {
            color: #4CAF50;
        }
        
        .file-message {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-top: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .file-message:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }
        
        .file-icon {
            font-size: 24px;
            margin-right: 10px;
            color: var(--primary);
        }
        
        .file-info {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-size {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .image-message {
            max-width: 100%;
            margin-top: 8px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
            position: relative;
        }
        
        .image-message:hover {
            transform: scale(1.02);
            border-color: var(--primary);
        }
        
        .image-message img {
            width: 100%;
            height: auto;
            display: block;
            max-height: 400px;
            object-fit: contain;
            background: #000;
        }
        
        .video-message {
            max-width: 100%;
            margin-top: 8px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
            position: relative;
            background: #000;
        }
        
        .video-message:hover {
            transform: scale(1.02);
            border-color: var(--primary);
        }
        
        .video-message video {
            width: 100%;
            height: auto;
            display: block;
            max-height: 400px;
            object-fit: contain;
        }
        
        .video-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid white;
        }
        
        .video-play-btn:hover {
            background: rgba(255, 107, 53, 0.8);
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        .voice-message {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-top: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .voice-message:hover {
            background: rgba(255,255,255,0.15);
        }
        
        .voice-icon {
            font-size: 24px;
            margin-right: 10px;
            color: var(--voice);
        }
        
        .voice-duration {
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
        }
        
        .voice-wave {
            flex: 1;
            height: 20px;
            background: linear-gradient(90deg, var(--voice) 0%, transparent 100%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .voice-wave::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            animation: wave 2s infinite linear;
        }
        
        @keyframes wave {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .message-input-container {
            padding: 12px 15px;
            background: var(--sidebar);
            display: flex;
            gap: 8px;
            align-items: center;
            border-top: 1px solid rgba(255,107,53,0.1);
            background: linear-gradient(90deg, #252525 0%, #2A1E16 100%);
        }
        
        .message-input {
            flex: 1;
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,107,53,0.3);
            border-radius: 20px;
            color: var(--text);
            font-size: 14px;
            resize: none;
            max-height: 80px;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.3s;
            min-height: 40px;
        }
        
        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255,107,53,0.05);
            box-shadow: 0 0 0 3px rgba(255,107,53,0.1);
        }
        
        .send-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(255,107,53,0.3);
        }
        
        .send-btn:hover:not(:disabled) {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 4px 15px rgba(255,107,53,0.5);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .attach-btn {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: var(--text);
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s;
            font-size: 18px;
        }
        
        .attach-btn:hover {
            background: rgba(255,107,53,0.2);
            color: var(--primary);
        }
        
        .voice-btn {
            width: 40px;
            height: 40px;
            background: rgba(156,39,176,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: var(--voice);
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s;
            font-size: 18px;
            position: relative;
        }
        
        .voice-btn:hover {
            background: rgba(156,39,176,0.3);
        }
        
        .voice-btn.recording {
            background: var(--error);
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .recording-time {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error);
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .profile-content {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: linear-gradient(135deg, #1A1A1A 0%, #2D1B0E 100%);
        }
        
        .profile-header {
            text-align: center;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(255,107,53,0.1);
        }
        
        .profile-avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .profile-avatar {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 52px;
            font-weight: 800;
            cursor: pointer;
            border: 4px solid var(--primary);
            background-size: cover;
            background-position: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 15px 35px rgba(255,107,53,0.3);
        }
        
        .profile-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 40px rgba(255,107,53,0.4);
        }
        
        .avatar-upload {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            border: 3px solid var(--sidebar);
            transition: all 0.3s;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .avatar-upload:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 8px 20px rgba(255,107,53,0.4);
        }
        
        .profile-name {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text);
        }
        
        .profile-username {
            color: var(--primary-light);
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .profile-status {
            display: inline-flex;
            align-items: center;
            background: rgba(76,175,80,0.1);
            padding: 6px 15px;
            border-radius: 20px;
            color: var(--success);
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .info-section {
            background: linear-gradient(135deg, var(--sidebar) 0%, #2A1E16 100%);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255,107,53,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .info-section h3 {
            color: var(--primary);
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-section h3::before {
            content: '';
            display: block;
            width: 4px;
            height: 20px;
            background: var(--primary);
            border-radius: 2px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            align-items: center;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
        }
        
        .info-value {
            color: var(--text);
            font-size: 16px;
            font-weight: 600;
            text-align: right;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: linear-gradient(135deg, var(--sidebar) 0%, #2A1E16 100%);
            border-radius: 25px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFade 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 25px 60px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,107,53,0.2);
            position: relative;
            overflow: hidden;
        }
        
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        }
        
        @keyframes modalFade {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 25px;
            text-align: center;
            color: var(--primary);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }
        
        .avatar-preview {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            margin: 0 auto 25px;
            background-size: cover;
            background-position: center;
            border: 4px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 70px;
            font-weight: 800;
            color: white;
            box-shadow: 0 15px 35px rgba(255,107,53,0.3);
        }
        
        .avatar-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .avatar-option {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 20px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .avatar-option:hover {
            transform: scale(1.15);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
        
        .avatar-option.selected {
            border-color: white;
            box-shadow: 0 0 0 4px var(--primary), 0 10px 25px rgba(255,107,53,0.5);
            transform: scale(1.1);
        }
        
        .avatar-upload-area {
            border: 3px dashed var(--primary);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 25px;
            transition: all 0.3s;
            background: rgba(255,107,53,0.05);
        }
        
        .avatar-upload-area:hover {
            background: rgba(255,107,53,0.1);
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 15px;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            max-width: 320px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            font-weight: 500;
            border-left: 5px solid var(--primary-light);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%) translateY(-20px); opacity: 0; }
            to { transform: translateX(0) translateY(0); opacity: 1; }
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--error) 0%, #D32F2F 100%);
            border-left-color: #FF5252;
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--success) 0%, #388E3C 100%);
            border-left-color: #81C784;
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--info) 0%, #1976D2 100%);
            border-left-color: #64B5F6;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
            padding: 40px;
        }
        
        .empty-state .icon {
            font-size: 70px;
            margin-bottom: 25px;
            opacity: 0.5;
        }
        
        .empty-state p {
            font-size: 17px;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #666 0%, #444 100%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #777 0%, #555 100%);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .loading {
            display: inline-block;
            width: 22px;
            height: 22px;
            border: 3px solid rgba(255,255,255,.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }
        
        .loading-overlay .loading {
            width: 60px;
            height: 60px;
            border-width: 6px;
        }
        
        .search-hint {
            color: var(--text-secondary);
            font-size: 13px;
            text-align: center;
            padding: 10px;
            font-style: italic;
            border-top: 1px solid rgba(255,107,53,0.1);
            background: rgba(255,255,255,0.02);
            border-radius: 0 0 10px 10px;
            margin-top: -5px;
        }
        
        .group-members {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
        }
        
        .member-tag {
            display: inline-flex;
            align-items: center;
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            margin: 5px;
            font-size: 14px;
        }
        
        .member-tag .remove {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .create-group-btn {
            margin-top: 20px;
        }
        
        .modal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
        }
        
        .modal-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .modal-tab.active {
            background: rgba(255,107,53,0.2);
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .group-info-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,107,53,0.1);
        }
        
        .group-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--group);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 800;
            margin: 0 auto 15px;
            color: white;
            border: 4px solid var(--group);
            box-shadow: 0 10px 25px rgba(255,179,71,0.3);
        }
        
        .group-members-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .group-member-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
        }
        
        .group-member-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 18px;
        }
        
        .group-member-name {
            font-size: 12px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        .admin-badge {
            background: var(--group);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* –Ø–†–ö–ò–ï –ö–ù–û–ü–ö–ò –ó–í–û–ù–ö–ê */
        .call-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #00BCD4 0%, #00838F 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s;
            font-size: 16px;
            box-shadow: 0 3px 10px rgba(0, 188, 212, 0.4);
        }
        
        .call-btn:hover {
            background: linear-gradient(135deg, #26C6DA 0%, #0097A7 100%);
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 188, 212, 0.6);
        }
        
        .call-btn.calling {
            background: linear-gradient(135deg, var(--call) 0%, #0097A7 100%);
            color: white;
            animation: pulse 1s infinite;
            box-shadow: 0 3px 10px rgba(0, 188, 212, 0.6);
        }
        
        .call-btn.active-call {
            background: linear-gradient(135deg, var(--error) 0%, #D32F2F 100%);
            color: white;
            box-shadow: 0 3px 10px rgba(244, 67, 54, 0.6);
        }
        
        .video-call-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s;
            font-size: 16px;
            box-shadow: 0 3px 10px rgba(233, 30, 99, 0.4);
        }
        
        .video-call-btn:hover {
            background: linear-gradient(135deg, #F06292 0%, #D81B60 100%);
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.6);
        }
        
        .video-call-btn.calling {
            background: linear-gradient(135deg, var(--video-call) 0%, #C2185B 100%);
            color: white;
            animation: pulse 1s infinite;
            box-shadow: 0 3px 10px rgba(233, 30, 99, 0.6);
        }
        
        .call-message {
            background: linear-gradient(135deg, var(--call) 0%, #0097A7 100%) !important;
            color: white !important;
            text-align: center;
            padding: 15px !important;
            cursor: default !important;
            border-radius: 20px !important;
            max-width: 85% !important;
        }
        
        .call-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .call-action-btn {
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 16px;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .call-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        
        .accept-call-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .accept-call-btn:hover {
            background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }
        
        .reject-call-btn {
            background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }
        
        .reject-call-btn:hover {
            background: linear-gradient(135deg, #EF5350 0%, #E53935 100%);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.6);
        }
        
        .end-call-btn {
            background: linear-gradient(135deg, var(--error) 0%, #D32F2F 100%);
        }
        
        .call-notification {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--call) 0%, #0097A7 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px;
            animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 15px 35px rgba(0,188,212,0.5);
            text-align: center;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .call-notification.video {
            background: linear-gradient(135deg, var(--video-call) 0%, #C2185B 100%);
            box-shadow: 0 15px 35px rgba(233, 30, 99, 0.5);
        }
        
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        .call-notification h4 {
            margin-bottom: 10px;
            font-size: 20px;
            font-weight: bold;
        }
        
        .call-notification p {
            margin-bottom: 20px;
            font-size: 16px;
            opacity: 0.9;
        }
        
        .notification-permission {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--warning) 0%, #F57C00 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            max-width: 300px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1500;
            animation: slideIn 0.5s ease;
        }
        
        .notification-permission p {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .notification-permission-buttons {
            display: flex;
            gap: 10px;
        }
        
        .notification-permission-btn {
            flex: 1;
            padding: 8px 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .allow-notifications-btn {
            background: white;
            color: var(--warning);
        }
        
        .later-notifications-btn {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .context-menu {
            position: fixed;
            background: linear-gradient(135deg, var(--sidebar) 0%, #2A1E16 100%);
            border-radius: 15px;
            padding: 10px;
            min-width: 200px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,107,53,0.2);
            z-index: 2000;
            animation: slideUp 0.2s ease;
            max-width: 300px;
        }
        
        .context-menu-item {
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .context-menu-item:hover {
            background: rgba(255,107,53,0.1);
        }
        
        .context-menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 5px 0;
        }
        
        .file-download-btn {
            background: rgba(255,107,53,0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 5px;
            display: inline-block;
            transition: all 0.3s;
        }
        
        .file-download-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .contact-options-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .contact-options-btn:hover {
            background: rgba(255,107,53,0.1);
            color: var(--primary);
        }
        
        .user-profile-view {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: linear-gradient(135deg, #1A1A1A 0%, #2D1B0E 100%);
        }
        
        .edit-nickname-input {
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--primary);
            border-radius: 10px;
            color: var(--text);
            padding: 8px 12px;
            font-size: 14px;
            width: 100%;
            margin-top: 5px;
        }
        
        .edit-nickname-btn {
            background: rgba(255,107,53,0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 5px;
            transition: all 0.3s;
        }
        
        .edit-nickname-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .download-progress {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .download-progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .call-active-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1A1A1A 0%, #2D1B0E 100%);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .call-active-header {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: var(--call);
        }
        
        .call-active-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--call) 0%, #0097A7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            margin-bottom: 30px;
            border: 5px solid var(--call);
            box-shadow: 0 15px 35px rgba(0,188,212,0.5);
        }
        
        .call-active-name {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .call-active-status {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }
        
        .call-active-timer {
            font-size: 48px;
            font-family: monospace;
            font-weight: bold;
            margin-bottom: 40px;
            color: var(--call);
        }
        
        .call-active-actions {
            display: flex;
            gap: 20px;
        }
        
        .call-active-action-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .end-call-active-btn {
            background: linear-gradient(135deg, var(--error) 0%, #D32F2F 100%);
            color: white;
        }
        
        .mute-call-btn {
            background: linear-gradient(135deg, #666 0%, #444 100%);
            color: white;
        }
        
        .speaker-call-btn {
            background: linear-gradient(135deg, #666 0%, #444 100%);
            color: white;
        }
        
        .call-active-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
        
        .join-call-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            min-width: 160px;
            justify-content: center;
        }
        
        .join-call-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }
        
        .user-status.real-online {
            color: var(--success);
            position: relative;
        }
        
        .user-status.real-online::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--success);
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }
        
        .user-status.real-offline {
            color: var(--text-secondary);
        }
        
        .user-status.recently-active {
            color: var(--warning);
        }
        
        .message-sending {
            opacity: 0.8;
            animation: sendingPulse 0.6s infinite alternate;
        }
        
        @keyframes sendingPulse {
            from { opacity: 0.8; }
            to { opacity: 0.4; }
        }
        
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            backdrop-filter: blur(10px);
        }
        
        .image-preview-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        
        .image-preview-content img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        .image-preview-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∑–≤–æ–Ω–∫–∞ */
        .call-type-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }
        
        .call-type-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
            border: 2px solid transparent;
        }
        
        .call-type-option:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-5px);
        }
        
        .call-type-option.selected {
            background: rgba(255,107,53,0.1);
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(255,107,53,0.3);
        }
        
        .call-type-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .call-type-name {
            font-size: 16px;
            font-weight: 600;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            height: 500px;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        
        .local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 180px;
            height: 135px;
            border-radius: 10px;
            border: 3px solid white;
            background: #000;
            object-fit: cover;
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .remote-video {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            background: #000;
            object-fit: cover;
        }
        
        .call-controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 20;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∑–≤–æ–Ω–∫—É –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ */
        .join-call-message-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .join-call-message-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }

        /* –ó–ï–õ–ï–ù–´–ô –ò–ù–î–ò–ö–ê–¢–û–† –ì–û–í–û–†–ï–ù–ò–Ø –í –ó–í–û–ù–ö–ï */
        .speaking-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            background-color: #4CAF50;
            border-radius: 50%;
            box-shadow: 0 0 10px #4CAF50;
            animation: speakingPulse 1s infinite alternate;
            display: none;
            z-index: 30;
        }

        @keyframes speakingPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 10px #4CAF50;
            }
            100% {
                transform: scale(1.5);
                box-shadow: 0 0 20px #4CAF50;
            }
        }

        .speaking-active {
            display: block;
        }

        /* –ö–ù–û–ü–ö–ê –û–¢–ö–õ–Æ–ß–ï–ù–ò–Ø –ó–í–û–ù–ö–ê */
        .disable-call-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #666 0%, #444 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: white;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s;
            font-size: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            margin-left: 5px;
        }

        .disable-call-btn:hover {
            background: linear-gradient(135deg, #777 0%, #555 100%);
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        .disable-call-btn.active {
            background: linear-gradient(135deg, var(--error) 0%, #D32F2F 100%);
            color: white;
        }

        .call-disabled-message {
            background: linear-gradient(135deg, #666 0%, #444 100%) !important;
            color: white !important;
            text-align: center;
            padding: 15px !important;
            cursor: default !important;
            border-radius: 20px !important;
            max-width: 85% !important;
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–µ–æ-–ø—Ä–µ–≤—å—é */
        .video-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4001;
            backdrop-filter: blur(10px);
        }
        
        .video-preview-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
        }
        
        .video-preview-content video {
            width: 100%;
            height: auto;
            max-height: 80vh;
            display: block;
        }
        
        .video-preview-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .video-preview-play-btn {
            background: var(--primary);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }
        
        .video-preview-progress {
            flex: 1;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
        }
        
        .video-preview-progress-filled {
            height: 100%;
            background: var(--primary);
            width: 0%;
        }
        
        .video-preview-time {
            color: white;
            font-size: 14px;
            min-width: 80px;
            text-align: center;
        }
        
        .video-preview-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        /* –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è */
        .connection-quality {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 15;
        }
        
        .connection-quality.good {
            color: #4CAF50;
        }
        
        .connection-quality.fair {
            color: #FF9800;
        }
        
        .connection-quality.poor {
            color: #F44336;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–∞—Ö */
        .file-size-warning {
            color: var(--warning);
            font-size: 12px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∂–∞—Ç–∏—è */
        .compression-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--primary);
            font-size: 12px;
            margin-top: 5px;
        }

        /* –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ —Å –∏–∫–æ–Ω–∫–æ–π */
        .custom-file-input {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }

        .custom-file-input input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ */
        .upload-progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px;
            border-radius: 0 0 8px 8px;
            z-index: 10;
        }

        .upload-progress {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            transition: width 0.3s ease;
            position: relative;
        }

        .upload-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            animation: uploading 1.5s infinite linear;
        }

        @keyframes uploading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .upload-progress-text {
            font-size: 11px;
            color: white;
            text-align: center;
            font-weight: 600;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .sending-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sending-indicator .loading {
            width: 12px;
            height: 12px;
            border-width: 2px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–≤–æ–Ω–∫–æ–≤ */
        .call-blocked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 20px;
        }

        .call-blocked-text {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–π (–∫—Ä—É–∂–∫–∏) */
        .video-circle-message {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            overflow: hidden;
            background: #000;
            position: relative;
            cursor: pointer;
            margin-top: 10px;
            border: 4px solid rgba(255,107,53,0.3);
            transition: all 0.3s;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .video-circle-message:hover {
            transform: scale(1.03);
            border-color: var(--primary);
            box-shadow: 0 12px 30px rgba(255,107,53,0.2);
        }

        .video-circle-message video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-circle-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            background: rgba(255,107,53,0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid white;
            z-index: 2;
        }

        .video-circle-play-btn:hover {
            background: rgba(255,107,53,0.9);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .video-circle-duration {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            z-index: 2;
        }

        .video-circle-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255,255,255,0.2);
            z-index: 2;
        }

        .video-circle-progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.1s;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–ø–∏—Å–∏ –≤–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏—è */
        .video-recording-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            backdrop-filter: blur(10px);
        }

        .video-recording-content {
            background: linear-gradient(135deg, var(--sidebar) 0%, #2A1E16 100%);
            border-radius: 20px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            width: 600px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,107,53,0.3);
            display: flex;
            flex-direction: column;
        }

        .video-recording-preview {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }

        .video-recording-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-recording-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .video-recording-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .record-start-btn {
            background: linear-gradient(135deg, var(--error) 0%, #D32F2F 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }

        .record-start-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.6);
        }

        .record-start-btn.recording {
            animation: pulse 1.5s infinite;
        }

        .record-stop-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255,107,53,0.4);
        }

        .record-stop-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255,107,53,0.6);
        }

        .camera-switch-btn {
            background: linear-gradient(135deg, #666 0%, #444 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .camera-switch-btn:hover {
            background: linear-gradient(135deg, #777 0%, #555 100%);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .video-recording-timer {
            font-size: 32px;
            font-family: monospace;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .video-recording-max-time {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ */
        .recording-indicator {
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--error);
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 2;
        }

        .recording-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        /* –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–π */
        .video-message-btn {
            width: 40px;
            height: 40px;
            background: rgba(233,30,99,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            color: var(--video-call);
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s;
            font-size: 16px;
            position: relative;
        }

        .video-message-btn:hover {
            background: rgba(233,30,99,0.3);
            color: #F06292;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å—à–∏—Ö –≤–∏–¥–µ–æ */
        .video-chunk-info {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .video-chunk-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .video-chunk-progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .video-chunk-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            transition: width 0.3s;
        }

        .video-chunk-text {
            font-size: 11px;
            color: var(--primary);
            font-weight: 600;
        }

        /* –ö–Ω–æ–ø–∫–∏ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ */
        .compact-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .compact-controls .attach-btn,
        .compact-controls .voice-btn,
        .compact-controls .video-message-btn,
        .compact-controls .send-btn,
        .compact-controls .call-btn,
        .compact-controls .video-call-btn,
        .compact-controls .disable-call-btn {
            width: 36px;
            height: 36px;
            font-size: 15px;
        }

        .compact-controls .message-input {
            padding: 8px 12px;
            font-size: 13px;
            min-height: 36px;
            border-radius: 18px;
        }

        /* –í–∏–¥–µ–æ-–ø—Ä–µ–≤—å—é —Å –∫—Ä–µ—Å—Ç–∏–∫–æ–º */
        .video-message-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            backdrop-filter: blur(10px);
        }

        .video-message-preview-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            background: #000;
        }

        .video-message-preview-content video {
            width: 100%;
            height: auto;
            max-height: 80vh;
            display: block;
        }

        .video-message-preview-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .video-message-preview-close:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞ */
        .download-notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, var(--success) 0%, #388E3C 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            max-width: 300px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1500;
            animation: slideInLeft 0.5s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .download-notification-icon {
            font-size: 24px;
        }

        .download-notification-text {
            flex: 1;
            font-size: 14px;
        }

        /* Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .push-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            max-width: 300px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1500;
            animation: slideInRight 0.5s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 5px solid var(--primary-light);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .push-notification-icon {
            font-size: 24px;
        }

        .push-notification-content {
            flex: 1;
        }

        .push-notification-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .push-notification-message {
            font-size: 13px;
            opacity: 0.9;
        }

        .push-notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .push-notification-close:hover {
            background: rgba(255,255,255,0.2);
        }

        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø, –†–ï–ê–ö–¶–ò–ô --- */
        .message-actions {
            position: absolute;
            top: -20px;
            right: 10px;
            display: flex;
            gap: 5px;
            background: var(--sidebar);
            border-radius: 20px;
            padding: 4px 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            border: 1px solid rgba(255,107,53,0.3);
        }
        .message:hover .message-actions {
            opacity: 1;
            pointer-events: all;
        }
        .message-action-btn {
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s;
        }
        .message-action-btn:hover {
            background: rgba(255,107,53,0.3);
            color: var(--primary);
            transform: scale(1.1);
        }
        .message-reactions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .reaction-badge {
            background: rgba(255,255,255,0.1);
            border-radius: 30px;
            padding: 2px 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .reaction-badge:hover {
            background: rgba(255,107,53,0.3);
            border-color: var(--primary);
            transform: scale(1.05);
        }
        .reaction-badge.own-reaction {
            background: rgba(255,107,53,0.4);
            border-color: var(--primary);
        }
        .edit-message-input {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--primary);
            border-radius: 15px;
            color: var(--text);
            font-size: 14px;
            margin: 8px 0;
        }
        .edit-message-actions {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }

        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò: –ü–û–ò–°–ö –°–û–û–ë–©–ï–ù–ò–ô --- */
        .search-messages-container {
            padding: 10px 15px;
            background: rgba(255,107,53,0.05);
            border-bottom: 1px solid rgba(255,107,53,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-messages-input {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,107,53,0.3);
            border-radius: 30px;
            color: var(--text);
            font-size: 14px;
            outline: none;
        }
        .search-messages-input:focus {
            border-color: var(--primary);
        }
        .search-messages-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
        }
        .search-messages-count {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò: –ö–ê–ù–ê–õ–´ --- */
        .channel-info-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,107,53,0.1);
        }
        .channel-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--channel);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 800;
            margin: 0 auto 15px;
            color: white;
            border: 4px solid var(--channel);
            box-shadow: 0 10px 25px rgba(139,195,74,0.3);
        }
        .channel-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .channel-subscribe-btn {
            background: linear-gradient(135deg, var(--channel) 0%, #7CB342 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .channel-subscribe-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139,195,74,0.4);
        }
        .channel-unsubscribe-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid var(--channel);
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .channel-unsubscribe-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        /* –î–æ–ø. —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π –Ω–∞ –∫–∞–Ω–∞–ª–∞—Ö */
        .message.channel-message {
            border-left: 4px solid var(--channel);
        }

        /* === –ù–û–í–´–ï –°–¢–ò–õ–ò: –ò–ù–î–ò–ö–ê–¢–û–†–´ –ù–ê–ë–û–†–ê –¢–ï–ö–°–¢–ê –ò –ó–í–û–ù–ö–û–í === */
        .typing-indicator {
            font-size: 13px;
            color: var(--primary-light);
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 0;
        }
        .typing-dots {
            display: inline-flex;
            gap: 3px;
        }
        .typing-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: var(--primary-light);
            animation: typingPulse 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingPulse {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        .call-ringing-indicator {
            font-size: 13px;
            color: var(--call);
            display: flex;
            align-items: center;
            gap: 5px;
            animation: ringingPulse 1s infinite;
        }
        @keyframes ringingPulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.7; }
        }
        /* ===== –ö–û–ù–ï–¶ –°–¢–ò–õ–ï–ô ===== */
    </style>
</head>
<body>
    <!-- –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
    <div id="authScreen" class="screen hidden">
        <div class="auth-form">
            <div class="logo">
                <div class="logo-icon">A</div>
                <h2>AbSgram 7.0</h2>
                <p>–ê–±—Å–æ–ª—é—Ç–Ω—ã–π —á–µ–º–ø–∏–æ–Ω</p>
            </div>
            
            <div id="loginForm">
                <h3 style="text-align: center; margin-bottom: 25px;">–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h3>
                <div class="input-group">
                    <label for="loginUsername">–ù–∏–∫–Ω–µ–π–º</label>
                    <input type="text" id="loginUsername" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º">
                </div>
                <div class="input-group">
                    <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn" style="width: 100%; margin-top: 10px;" id="loginBtn">
                    <span>–í–æ–π—Ç–∏</span>
                </button>
                <div class="auth-toggle">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a id="showRegisterBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                </div>
            </div>
            
            <div id="registerForm" class="hidden">
                <h3 style="text-align: center; margin-bottom: 25px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                <div class="input-group">
                    <label for="registerName">–ò–º—è</label>
                    <input type="text" id="registerName" placeholder="–í–∞—à–µ –∏–º—è">
                </div>
                <div class="input-group">
                    <label for="registerUsername">–ù–∏–∫–Ω–µ–π–º</label>
                    <input type="text" id="registerUsername" placeholder="–õ–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _">
                </div>
                <div class="input-group">
                    <label for="registerPassword">–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)</label>
                    <input type="password" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn" style="width: 100%; margin-top: 10px;" id="registerBtn">
                    <span>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
                </button>
                <div class="auth-toggle">
                    –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a id="showLoginBtn">–í–æ–π—Ç–∏</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –°–ü–ò–°–û–ö –ß–ê–¢–û–í -->
    <div id="chatsScreen" class="screen hidden">
        <div class="header">
            <div class="header-title">AbSgram</div>
            <button class="btn" id="profileBtn">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>
        
        <!-- –ü–û–ò–°–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô -->
        <div class="search-container">
            <input type="text" class="search-input" id="searchUsersInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." autocomplete="off">
        </div>
        
        <div class="chats-list" id="chatsList">
            <div class="empty-state">
                <div class="icon">üí¨</div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
            </div>
        </div>
        <button class="new-chat-btn" id="newChatBtn">+</button>
    </div>
    
    <!-- –≠–ö–†–ê–ù –ß–ê–¢–ê -->
    <div id="chatScreen" class="screen hidden">
        <div class="header">
            <button class="back-btn" id="backToChatsBtn">‚Üê</button>
            <div style="flex: 1; padding: 0 10px;">
                <div id="chatTitle" style="font-weight: bold; font-size: 16px;"></div>
                <div id="chatStatus" style="font-size: 13px;"></div>
                <div id="typingStatus" class="typing-indicator hidden">
                    <span>–ø–µ—á–∞—Ç–∞–µ—Ç</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
                <div id="callRingingStatus" class="call-ringing-indicator hidden">
                    üîî –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...
                </div>
            </div>
            <button class="btn" id="groupInfoBtn" style="display: none;">üë• –ò–Ω—Ñ–æ</button>
            <button class="btn" id="channelInfoBtn" style="display: none;">üì¢ –ò–Ω—Ñ–æ</button>
            <div class="compact-controls">
                <button class="video-call-btn" id="videoCallBtn" title="–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫" style="display: none;">üìπ</button>
                <button class="call-btn" id="callBtn" title="–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫" style="display: none;">üìû</button>
                <button class="disable-call-btn" id="disableCallBtn" title="–û—Ç–∫–ª—é—á–∏—Ç—å –∑–≤–æ–Ω–∫–∏" style="display: none;">üîï</button>
                <button class="contact-options-btn" id="contactOptionsBtn" title="–û–ø—Ü–∏–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞" style="display: none;">‚ãÆ</button>
            </div>
        </div>
        
        <!-- –ü–û–ò–°–ö –ü–û –°–û–û–ë–©–ï–ù–ò–Ø–ú -->
        <div class="search-messages-container" id="searchMessagesContainer">
            <input type="text" class="search-messages-input" id="searchMessagesInput" placeholder="üîç –ü–æ–∏—Å–∫ –≤ —á–∞—Ç–µ...">
            <span class="search-messages-count" id="searchMessagesCount"></span>
            <button class="search-messages-btn" id="prevSearchBtn">‚ñ≤</button>
            <button class="search-messages-btn" id="nextSearchBtn">‚ñº</button>
        </div>
        
        <div class="messages-container" id="messagesContainer">
            <div class="empty-state">
                <div class="icon">üí≠</div>
                <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</p>
                <p style="font-size: 14px; margin-top: 10px;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</p>
            </div>
        </div>
        <div class="message-input-container">
            <div class="compact-controls">
                <button class="attach-btn" id="attachBtn">üìé</button>
                <button class="voice-btn" id="voiceBtn">
                    üé§
                    <div class="recording-time" id="recordingTime" style="display: none;">0:00</div>
                </button>
                <button class="video-message-btn" id="videoMessageBtn" title="–í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ">
                    üìπ
                </button>
                <textarea class="message-input" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                <button class="send-btn" id="sendMessageBtn" disabled>‚û§</button>
            </div>
        </div>
    </div>
    
    <!-- –ü–†–û–§–ò–õ–¨ -->
    <div id="profileScreen" class="screen hidden">
        <div class="header">
            <button class="back-btn" id="backToChatsBtn2">‚Üê</button>
            <div class="header-title">–ü—Ä–æ—Ñ–∏–ª—å</div>
            <div style="width: 40px;"></div>
        </div>
        <div class="profile-content">
            <div class="profile-header">
                <div class="profile-avatar-container">
                    <div class="profile-avatar" id="profileAvatar"></div>
                    <div class="avatar-upload" id="showAvatarModalBtn" title="–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É">‚úé</div>
                </div>
                <div class="profile-name" id="profileName"></div>
                <div class="profile-username" id="profileUsername"></div>
                <div class="profile-status" id="profileStatus">
                    <span class="status-dot"></span>
                    <span>online</span>
                </div>
            </div>
            
            <div class="info-section">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <div class="info-item">
                    <div class="info-label">–ù–∏–∫–Ω–µ–π–º</div>
                    <div class="info-value" id="profileUsernameValue"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                    <div class="info-value" id="profileId"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
                    <div class="info-value" id="profileDate"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">–í—Å–µ–≥–æ —á–∞—Ç–æ–≤</div>
                    <div class="info-value" id="profileChatsCount">0</div>
                </div>
            </div>
            
            <button class="btn" style="width: 100%; margin-top: 20px;" id="editNameBtn">
                ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è
            </button>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" id="logoutBtn">
                üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
            </button>
        </div>
    </div>
    
    <!-- –ü–†–û–°–ú–û–¢–† –ü–†–û–§–ò–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø -->
    <div id="userProfileScreen" class="screen hidden">
        <div class="header">
            <button class="back-btn" id="backFromUserProfileBtn">‚Üê</button>
            <div class="header-title">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            <div style="width: 40px;"></div>
        </div>
        <div class="user-profile-view" id="userProfileContent">
            <div class="empty-state">
                <div class="loading"></div>
                <p style="margin-top: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</p>
            </div>
        </div>
    </div>
    
    <!-- –≠–ö–†–ê–ù –í–´–ë–û–†–ê –¢–ò–ü–ê –ó–í–û–ù–ö–ê -->
    <div id="callTypeModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–≤–æ–Ω–∫–∞</div>
            
            <div class="call-type-selector">
                <div class="call-type-option" id="audioCallOption" data-type="audio">
                    <div class="call-type-icon">üìû</div>
                    <div class="call-type-name">–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">–¢–æ–ª—å–∫–æ –∑–≤—É–∫</div>
                </div>
                <div class="call-type-option" id="videoCallOption" data-type="video">
                    <div class="call-type-icon">üìπ</div>
                    <div class="call-type-name">–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">–ó–≤—É–∫ + –≤–∏–¥–µ–æ</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" style="flex: 1;" id="cancelCallTypeBtn">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn" style="flex: 1;" id="startCallWithTypeBtn">–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            </div>
        </div>
    </div>
    
    <!-- –≠–ö–†–ê–ù –ê–ö–¢–ò–í–ù–û–ì–û –ó–í–û–ù–ö–ê -->
    <div id="callActiveScreen" class="call-active-screen hidden">
        <div class="call-active-header">
            <span id="callTypeIcon">üìû</span> –ó–≤–æ–Ω–æ–∫
            <div class="speaking-indicator" id="speakingIndicator"></div>
            <div class="connection-quality" id="connectionQuality">üì∂ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</div>
        </div>
        
        <div class="video-container" id="videoContainer" style="display: none;">
            <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
            <video id="localVideo" class="local-video" autoplay playsinline muted></video>
            <div class="call-controls">
                <button class="call-active-action-btn mute-call-btn" id="muteCallBtnVideo" title="–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω">
                    üé§
                </button>
                <button class="call-active-action-btn end-call-active-btn" id="endCallActiveBtnVideo" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">
                    üìû
                </button>
                <button class="call-active-action-btn speaker-call-btn" id="speakerCallBtnVideo" title="–í–∫–ª—é—á–∏—Ç—å –≥—Ä–æ–º–∫—É—é —Å–≤—è–∑—å">
                    üîä
                </button>
                <button class="call-active-action-btn" id="videoToggleBtn" title="–í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ">
                    üìπ
                </button>
            </div>
        </div>
        
        <div id="audioCallContainer">
            <div class="call-active-avatar" id="callActiveAvatar">
                üë§
            </div>
            <div class="call-active-name" id="callActiveName">
                –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤
            </div>
            <div class="call-active-status" id="callActiveStatus">
                –ò–¥–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä...
            </div>
            <div class="call-active-timer" id="callActiveTimer">
                00:00
            </div>
            <div class="call-active-actions">
                <button class="call-active-action-btn mute-call-btn" id="muteCallBtnAudio" title="–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω">
                    üé§
                </button>
                <button class="call-active-action-btn end-call-active-btn" id="endCallActiveBtnAudio" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">
                    üìû
                </button>
                <button class="call-active-action-btn speaker-call-btn" id="speakerCallBtnAudio" title="–í–∫–ª—é—á–∏—Ç—å –≥—Ä–æ–º–∫—É—é —Å–≤—è–∑—å">
                    üîä
                </button>
            </div>
        </div>
    </div>
    
    <!-- –ú–û–î–ê–õ–ö–ê –î–õ–Ø –ê–í–ê–¢–ê–†–ö–ò -->
    <div id="avatarModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-title">–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É</div>
            
            <div class="avatar-preview" id="avatarPreview"></div>
            
            <div class="avatar-options">
                <div class="avatar-option" style="background: #FF6B35;" data-color="#FF6B35" title="–û—Ä–∞–Ω–∂–µ–≤—ã–π">A</div>
                <div class="avatar-option" style="background: #FF8E53;" data-color="#FF8E53" title="–°–≤–µ—Ç–ª–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π">B</div>
                <div class="avatar-option" style="background: #FFB347;" data-color="#FFB347" title="–ñ–µ–ª—Ç–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π">C</div>
                <div class="avatar-option" style="background: #FF7043;" data-color="#FF7043" title="–¢–µ—Ä—Ä–∞–∫–æ—Ç–æ–≤—ã–π">D</div>
                <div class="avatar-option" style="background: #FF9E6D;" data-color="#FF9E6D" title="–ü–µ—Ä—Å–∏–∫–æ–≤—ã–π">E</div>
                <div class="avatar-option" style="background: #FFCC99;" data-color="#FFCC99" title="–ü–µ—Å–æ—á–Ω—ã–π">F</div>
            </div>
            
            <div class="avatar-upload-area" id="uploadAvatarBtn">
                <div style="font-size: 30px; margin-bottom: 10px;">üìÅ</div>
                <div>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</div>
                <div style="font-size: 12px; color: #aaa; margin-top: 5px;">JPG, PNG –¥–æ 10MB</div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" style="flex: 1;" id="cancelAvatarBtn">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn" style="flex: 1;" id="saveAvatarBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–û–î–ê–õ–ö–ê –î–õ–Ø –ù–û–í–û–ì–û –ß–ê–¢–ê/–ì–†–£–ü–ü–´/–ö–ê–ù–ê–õ–ê -->
    <div id="newChatModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-title">–ù–æ–≤—ã–π —á–∞—Ç</div>
            
            <div class="modal-tabs">
                <div class="modal-tab active" data-tab="single">–õ–∏—á–Ω—ã–π</div>
                <div class="modal-tab" data-tab="group">–ì—Ä—É–ø–ø–∞</div>
                <div class="modal-tab" data-tab="channel">–ö–∞–Ω–∞–ª</div>
            </div>
            
            <!-- –í–ö–õ–ê–î–ö–ê –õ–ò–ß–ù–û–ì–û –ß–ê–¢–ê -->
            <div id="singleTab" class="tab-content active">
                <div class="search-container" style="border: none; padding: 0 0 15px 0;">
                    <input type="text" class="search-input" id="singleSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." autocomplete="off">
                </div>
                <div id="singleSearchResults" class="users-list" style="padding: 0; max-height: 300px;"></div>
            </div>
            
            <!-- –í–ö–õ–ê–î–ö–ê –°–û–ó–î–ê–ù–ò–Ø –ì–†–£–ü–ü–´ -->
            <div id="groupTab" class="tab-content">
                <div class="input-group">
                    <label for="groupName">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
                    <input type="text" id="groupName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
                </div>
                
                <div class="input-group">
                    <label>–ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                    <input type="text" class="search-input" id="groupSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." autocomplete="off">
                </div>
                
                <div id="groupSearchResults" class="users-list" style="padding: 0; max-height: 200px; margin-bottom: 15px;"></div>
                
                <div class="input-group">
                    <label>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="memberCount">0</span>)</label>
                    <div class="group-members" id="groupMembersList">
                        <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            –î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ
                        </div>
                    </div>
                </div>
                
                <button class="btn create-group-btn" id="createGroupBtn" disabled>
                    üë• –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                </button>
            </div>
            
            <!-- –í–ö–õ–ê–î–ö–ê –°–û–ó–î–ê–ù–ò–Ø –ö–ê–ù–ê–õ–ê -->
            <div id="channelTab" class="tab-content">
                <div class="input-group">
                    <label for="channelName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞</label>
                    <input type="text" id="channelName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞">
                </div>
                <div class="input-group">
                    <label for="channelDescription">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="text" id="channelDescription" placeholder="–û —á–µ–º –≤–∞—à –∫–∞–Ω–∞–ª?">
                </div>
                <div class="input-group">
                    <label>–¢–∏–ø –∫–∞–Ω–∞–ª–∞</label>
                    <select id="channelType" class="search-input" style="padding: 12px;">
                        <option value="public">üîì –ü—É–±–ª–∏—á–Ω—ã–π (–≤—Å–µ –º–æ–≥—É—Ç –Ω–∞–π—Ç–∏)</option>
                        <option value="private">üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π (—Ç–æ–ª—å–∫–æ –ø–æ —Å—Å—ã–ª–∫–µ)</option>
                    </select>
                </div>
                <button class="btn create-group-btn" id="createChannelBtn" style="margin-top: 20px;">
                    üì¢ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª
                </button>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" style="flex: 1;" id="cancelGroupBtn">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–û–î–ê–õ–ö–ê –î–õ–Ø –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ì–†–£–ü–ü–ï -->
    <div id="groupInfoModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ</div>
            
            <div class="group-info-header">
                <div class="group-avatar-large" id="groupInfoAvatar">üë•</div>
                <h3 id="groupInfoName"></h3>
                <div style="color: var(--text-secondary); margin-top: 5px;" id="groupInfoMembers"></div>
            </div>
            
            <div class="info-section">
                <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                <div class="group-members-list" id="groupInfoMembersList">
                    <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" style="flex: 1;" id="closeGroupInfoBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–û–î–ê–õ–ö–ê –î–õ–Ø –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ö–ê–ù–ê–õ–ï -->
    <div id="channelInfoModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–Ω–∞–ª–µ</div>
            
            <div class="channel-info-header">
                <div class="channel-avatar-large" id="channelInfoAvatar">üì¢</div>
                <h3 id="channelInfoName"></h3>
                <div style="color: var(--text-secondary); margin-top: 5px;" id="channelInfoDescription"></div>
                <div class="channel-stats">
                    <span id="channelInfoSubscribers">üë• 0 –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</span>
                    <span id="channelInfoPosts">üìù 0 –ø–æ—Å—Ç–æ–≤</span>
                </div>
                <div>
                    <button class="channel-subscribe-btn" id="channelSubscribeBtn">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
                    <button class="channel-unsubscribe-btn" id="channelUnsubscribeBtn" style="display: none;">–û—Ç–ø–∏—Å–∞—Ç—å—Å—è</button>
                </div>
            </div>
            
            <div class="info-section" id="channelAdminSection" style="display: none;">
                <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                <button class="btn" style="width: 100%; margin-bottom: 10px;" id="editChannelBtn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª</button>
                <button class="btn btn-secondary" style="width: 100%;" id="deleteChannelBtn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª</button>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" style="flex: 1;" id="closeChannelInfoBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –ó–ê–ü–ò–°–ò –í–ò–î–ï–û–°–û–û–ë–©–ï–ù–ò–ô (–ò–°–ü–†–ê–í–õ–ï–ù–û) -->
    <div id="videoRecordingModal" class="video-recording-modal hidden">
        <div class="video-recording-content">
            <div class="modal-title">–ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏—è</div>
            
            <div class="video-recording-max-time">
                –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 60 —Å–µ–∫—É–Ω–¥
            </div>
            
            <div class="video-recording-timer" id="videoRecordingTimer">00:00</div>
            
            <div class="video-recording-preview">
                <video id="videoRecordingPreview" autoplay muted></video>
                <div id="recordingIndicator" class="recording-indicator" style="display: none;">
                    <div class="recording-dot"></div>
                    –ó–∞–ø–∏—Å—å...
                </div>
            </div>
            
            <div class="video-recording-controls">
                <button class="camera-switch-btn video-recording-btn" id="cameraSwitchBtn" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É">
                    üîÑ
                </button>
                <button class="record-start-btn video-recording-btn" id="recordStartBtn">
                    ‚è∫Ô∏è
                </button>
                <button class="record-stop-btn video-recording-btn" id="recordStopBtn" style="display: none;">
                    ‚èπÔ∏è
                </button>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" style="flex: 1;" id="cancelVideoRecordingBtn">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn" style="flex: 1;" id="sendVideoMessageBtn">‚û§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ -->
    <div id="contextMenu" class="context-menu hidden">
        <div class="context-menu-item" id="viewProfileBtn">
            <span>üëÅÔ∏è</span>
            <span>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</span>
        </div>
        <div class="context-menu-item" id="editNicknameBtn">
            <span>‚úèÔ∏è</span>
            <span>–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="clearChatBtn">
            <span>üóëÔ∏è</span>
            <span>–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</span>
        </div>
        <div class="context-menu-item" id="deleteChatBtn">
            <span>‚ùå</span>
            <span>–£–¥–∞–ª–∏—Ç—å —á–∞—Ç</span>
        </div>
    </div>
    
    <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ó–í–û–ù–ö–ï -->
    <div id="callNotification" class="call-notification hidden">
        <h4 id="callNotificationIcon">üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</h4>
        <p id="callerName">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–±–æ–Ω–µ–Ω—Ç</p>
        <p id="callTypeText" style="font-size: 14px; opacity: 0.8;">–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫</p>
        <div class="call-actions">
            <button class="call-action-btn accept-call-btn" id="acceptCallBtn">üìû –ü—Ä–∏–Ω—è—Ç—å</button>
            <button class="call-action-btn reject-call-btn" id="rejectCallBtn">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>
    </div>
    
    <!-- –ó–ê–ü–†–û–° –†–ê–ó–†–ï–®–ï–ù–ò–Ø –ù–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
    <div id="notificationPermission" class="notification-permission hidden">
        <p>üîî –†–∞–∑—Ä–µ—à–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏ –∑–≤–æ–Ω–∫–∞—Ö?</p>
        <div class="notification-permission-buttons">
            <button class="notification-permission-btn allow-notifications-btn" id="allowNotificationsBtn">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
            <button class="notification-permission-btn later-notifications-btn" id="laterNotificationsBtn">–ü–æ–∑–∂–µ</button>
        </div>
    </div>
    
    <!-- –ü–†–ï–í–¨–Æ –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô -->
    <div id="imagePreviewModal" class="image-preview-modal hidden">
        <div class="image-preview-content">
            <img id="previewedImage" src="" alt="">
            <button class="image-preview-close" id="closeImagePreviewBtn">√ó</button>
        </div>
    </div>
    
    <!-- –ü–†–ï–í–¨–Æ –í–ò–î–ï–û -->
    <div id="videoPreviewModal" class="video-preview-modal hidden">
        <div class="video-preview-content">
            <video id="previewedVideo" controls>
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ.
            </video>
            <button class="video-preview-close" id="closeVideoPreviewBtn">√ó</button>
        </div>
    </div>

    <!-- –ü–†–ï–í–¨–Æ –í–ò–î–ï–û–°–û–û–ë–©–ï–ù–ò–ô –° –ö–†–ï–°–¢–ò–ö–û–ú -->
    <div id="videoMessagePreviewModal" class="video-message-preview-modal hidden">
        <div class="video-message-preview-content">
            <video id="videoMessagePreview" controls>
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ.
            </video>
            <button class="video-message-preview-close" id="closeVideoMessagePreviewBtn">√ó</button>
        </div>
    </div>
    
    <!-- –°–ö–†–´–¢–´–ï –ò–ù–ü–£–¢–´ -->
    <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
    <input type="file" id="fileUpload" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar" style="display: none;" multiple>
    
    <!-- –û–í–ï–†–õ–ï–ô –ó–ê–ì–†–£–ó–ö–ò -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading"></div>
    </div>
    
    <!-- –ê–£–î–ò–û –≠–õ–ï–ú–ï–ù–¢ –î–õ–Ø –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–Ø –ì–û–õ–û–°–û–í–´–• -->
    <audio id="audioPlayer" style="display: none;"></audio>
    <audio id="ringtone" loop style="display: none;">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-phone-call-ringing-1106.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
    // ==================== –ò–ú–ü–û–†–¢ FIREBASE v9 ====================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut, 
        onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        doc, 
        setDoc, 
        getDoc, 
        getDocs, 
        updateDoc, 
        addDoc, 
        deleteDoc,
        query, 
        where, 
        orderBy, 
        onSnapshot, 
        serverTimestamp,
        limit,
        arrayUnion,
        arrayRemove,
        increment,
        writeBatch
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ====================
    const firebaseConfig = {
        apiKey: "AIzaSyBRNl0xA5ie8EGcZ4UIdP0e1IJuacoMarE",
        authDomain: "gocklain-bf553.firebaseapp.com",
        projectId: "gocklain-bf553",
        storageBucket: "gocklain-bf553.firebasestorage.app",
        messagingSenderId: "747181228665",
        appId: "1:747181228665:web:bd9dd2cd60b1cd5bb8caa8",
        measurementId: "G-1LBP6KFPL9"
    };

    // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ====================
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
    let currentUser = null;
    let currentChat = null;
    let selectedAvatar = null;
    let selectedAvatarColor = null;
    let unsubscribeChats = null;
    let unsubscribeMessages = null;
    let allUsers = new Map();
    let searchTimeout = null;
    let allUsersCache = new Map();
    let groupMembers = new Map();
    let isSendingMessage = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let recordingStartTime = null;
    let recordingTimer = null;
    let activeCall = null;
    let callTimer = null;
    let callStartTime = null;
    let notificationPermissionAsked = false;
    let userNicknames = new Map();
    let viewedUserProfile = null;
    let contextMenuTarget = null;
    let notificationCheckInterval = null;
    let onlineStatusInterval = null;
    let selectedCallType = 'audio';
    let unreadCounts = new Map();
    let currentMessageSearch = { index: 0, results: [] };
    
    // WebRTC –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let peerConnection = null;
    let localStream = null;
    let remoteStream = null;
    let isMuted = false;
    let isSpeakerOn = false;
    let isVideoOn = true;
    let currentCallId = null;
    let isCallDisabled = false;
    let speakingIndicatorInterval = null;
    let authError = false;
    let callListeners = new Map(); // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è unsubscribe —Ñ—É–Ω–∫—Ü–∏–π –∑–≤–æ–Ω–∫–æ–≤
    let typingTimeouts = new Map();
    let incomingCallData = null;
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–π
    let videoMediaRecorder = null;
    let videoChunks = [];
    let isVideoRecording = false;
    let videoRecordingStartTime = null;
    let videoRecordingTimer = null;
    let currentCamera = 'user';
    let videoStream = null;
    let maxVideoDuration = 60;
    let maxVideoSize = 50 * 1024 * 1024; // 50MB
    let currentFileUploads = new Map(); // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤

    // ==================== –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
    let messageReactions = new Map(); // messageId -> { count, users }
    let currentlyEditingMessage = null;
    let channels = new Map(); // channelId -> channel data
    let userSubscriptions = new Set(); // channel IDs, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    let typingListeners = new Map(); // –°–ª—É—à–∞—Ç–µ–ª–∏ –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
    let callRingingListeners = new Map(); // –°–ª—É—à–∞—Ç–µ–ª–∏ –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤

    // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
    function showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.toggle('hidden', !show);
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    function showPushNotification(title, message) {
        if (!("Notification" in window)) {
            showNotification(message, 'info');
            return;
        }

        if (Notification.permission === "granted") {
            const pushNotification = document.createElement('div');
            pushNotification.className = 'push-notification';
            pushNotification.innerHTML = `
                <div class="push-notification-icon">üîî</div>
                <div class="push-notification-content">
                    <div class="push-notification-title">${title}</div>
                    <div class="push-notification-message">${message}</div>
                </div>
                <button class="push-notification-close">√ó</button>
            `;
            document.body.appendChild(pushNotification);
            
            pushNotification.querySelector('.push-notification-close').onclick = () => {
                pushNotification.remove();
            };
            
            setTimeout(() => {
                if (pushNotification.parentNode) {
                    pushNotification.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => pushNotification.remove(), 300);
                }
            }, 5000);
        } else {
            showNotification(`${title}: ${message}`, 'info');
        }
    }

    function showDownloadNotification(fileName) {
        const notification = document.createElement('div');
        notification.className = 'download-notification';
        notification.innerHTML = `
            <div class="download-notification-icon">‚úÖ</div>
            <div class="download-notification-text">–§–∞–π–ª "${fileName}" —Å–∫–∞—á–∞–Ω</div>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideInLeft 0.3s ease reverse';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(screenId).classList.remove('hidden');
    }

    function getRandomColor() {
        const colors = ['#FF6B35', '#FF8E53', '#FF9E6D', '#FFB347', '#FFCC99', '#FF7043'];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    function formatDate(date) {
        if (!date) return '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
        const d = date.toDate ? date.toDate() : new Date(date);
        return d.toLocaleDateString('ru-RU', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    function formatTime(date) {
        if (!date) return '';
        const d = date.toDate ? date.toDate() : new Date(date);
        return d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getFileIcon(fileType) {
        if (fileType.startsWith('image/')) return 'üñºÔ∏è';
        if (fileType.startsWith('video/')) return 'üé¨';
        if (fileType.includes('pdf')) return 'üìÑ';
        if (fileType.includes('zip') || fileType.includes('rar') || fileType.includes('7z')) return 'üì¶';
        if (fileType.includes('doc') || fileType.includes('txt') || fileType.includes('text')) return 'üìù';
        if (fileType.includes('audio') || fileType.includes('music') || fileType.includes('sound')) return 'üéµ';
        return 'üìé';
    }

    function formatLastSeen(date) {
        const now = new Date();
        const diffMinutes = Math.floor((now - date) / (1000 * 60));
        
        if (diffMinutes < 1) {
            return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        } else if (diffMinutes < 60) {
            return `${diffMinutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
        } else if (diffMinutes < 1440) {
            const hours = Math.floor(diffMinutes / 60);
            return `${hours} —á –Ω–∞–∑–∞–¥`;
        } else {
            const days = Math.floor(diffMinutes / 1440);
            return `${days} –¥–Ω –Ω–∞–∑–∞–¥`;
        }
    }

    function getUserDisplayName(user) {
        if (!user) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
        const nickname = userNicknames.get(user.id);
        if (nickname) return nickname;
        return user.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
    }

    function saveUserNickname(userId, nickname) {
        if (!currentUser) return;
        
        try {
            const key = `absgram_nickname_${currentUser.id}_${userId}`;
            if (nickname) {
                localStorage.setItem(key, nickname);
                userNicknames.set(userId, nickname);
            } else {
                localStorage.removeItem(key);
                userNicknames.delete(userId);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∏–∫–Ω–µ–π–º–∞:', error);
        }
    }

    function loadAllNicknames() {
        if (!currentUser) return;
        
        try {
            userNicknames.clear();
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(`absgram_nickname_${currentUser.id}_`)) {
                    const userId = key.replace(`absgram_nickname_${currentUser.id}_`, '');
                    const nickname = localStorage.getItem(key);
                    userNicknames.set(userId, nickname);
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∏–∫–Ω–µ–π–º–æ–≤:', error);
        }
    }

    // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ù–î–ò–ö–ê–¢–û–†–û–í –ù–ê–ë–û–†–ê –¢–ï–ö–°–¢–ê ====================
    function setupTypingListener(chatId) {
        if (!chatId || typingListeners.has(chatId) || authError) return;
        
        try {
            const typingRef = collection(db, 'typing');
            const q = query(typingRef, where('chatId', '==', chatId));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    if (data.userId !== currentUser.id) {
                        if (change.type === 'added' || change.type === 'modified') {
                            showTypingIndicator(data.userId, data.isTyping);
                        } else if (change.type === 'removed') {
                            hideTypingIndicator(data.userId);
                        }
                    }
                });
            }, (error) => {
                console.warn('–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞:', error);
            });
            
            typingListeners.set(chatId, unsubscribe);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª—É—à–∞—Ç–µ–ª—è –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞:', error);
        }
    }

    function showTypingIndicator(userId, isTyping) {
        if (!currentChat || currentChat.isGroup || currentChat.isChannel) return;
        
        const typingEl = document.getElementById('typingStatus');
        if (isTyping) {
            const userName = getUserDisplayName({ id: userId, name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' });
            typingEl.querySelector('span').textContent = `${userName} –ø–µ—á–∞—Ç–∞–µ—Ç`;
            typingEl.classList.remove('hidden');
        } else {
            typingEl.classList.add('hidden');
        }
    }

    function hideTypingIndicator(userId) {
        const typingEl = document.getElementById('typingStatus');
        typingEl.classList.add('hidden');
    }

    async function updateTypingStatus(isTyping) {
        if (!currentChat || !currentUser || authError) return;
        
        try {
            const typingRef = collection(db, 'typing');
            const q = query(
                typingRef,
                where('chatId', '==', currentChat.id),
                where('userId', '==', currentUser.id)
            );
            
            const snapshot = await getDocs(q);
            
            if (isTyping) {
                if (snapshot.empty) {
                    await addDoc(typingRef, {
                        chatId: currentChat.id,
                        userId: currentUser.id,
                        isTyping: true,
                        timestamp: serverTimestamp()
                    });
                } else {
                    snapshot.forEach(async (doc) => {
                        await updateDoc(doc.ref, {
                            isTyping: true,
                            timestamp: serverTimestamp()
                        });
                    });
                }
            } else {
                snapshot.forEach(async (doc) => {
                    await deleteDoc(doc.ref);
                });
            }
        } catch (error) {
            console.warn('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞–±–æ—Ä–∞:', error);
        }
    }

    // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ù–î–ò–ö–ê–¢–û–†–û–í –ó–í–û–ù–ö–û–í ====================
    function setupCallRingingListener(chatId) {
        if (!chatId || callRingingListeners.has(chatId) || authError) return;
        
        try {
            const callsQuery = query(
                collection(db, 'messages'),
                where('chatId', '==', chatId),
                where('type', '==', 'call'),
                where('callActive', '==', true)
            );
            
            const unsubscribe = onSnapshot(callsQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const callData = change.doc.data();
                        if (callData.senderId !== currentUser.id && !activeCall) {
                            showCallRingingIndicator(callData);
                        }
                    } else if (change.type === 'removed' || change.type === 'modified') {
                        hideCallRingingIndicator();
                    }
                });
            }, (error) => {
                console.warn('–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –∑–≤–æ–Ω–∫–æ–≤:', error);
            });
            
            callRingingListeners.set(chatId, unsubscribe);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª—É—à–∞—Ç–µ–ª—è –∑–≤–æ–Ω–∫–æ–≤:', error);
        }
    }

    function showCallRingingIndicator(callData) {
        const ringingEl = document.getElementById('callRingingStatus');
        ringingEl.classList.remove('hidden');
    }

    function hideCallRingingIndicator() {
        const ringingEl = document.getElementById('callRingingStatus');
        ringingEl.classList.add('hidden');
    }

    // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–û–ò–°–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ====================
    function searchMessages(query) {
        if (!query.trim()) {
            currentMessageSearch = { index: 0, results: [] };
            document.getElementById('searchMessagesCount').textContent = '';
            return;
        }

        const container = document.getElementById('messagesContainer');
        const messages = Array.from(container.children).filter(el => 
            el.classList.contains('message') && !el.classList.contains('call-message')
        );

        const results = [];
        const queryLower = query.toLowerCase();

        messages.forEach((msg, idx) => {
            const textEl = msg.querySelector('div:first-child');
            if (textEl && textEl.textContent.toLowerCase().includes(queryLower)) {
                results.push(idx);
                const originalText = textEl.textContent;
                const regex = new RegExp(`(${query})`, 'gi');
                textEl.innerHTML = originalText.replace(regex, '<mark style="background: var(--primary); color: white; padding: 2px 4px; border-radius: 3px;">$1</mark>');
            } else {
                const originalText = textEl?.textContent;
                if (textEl && originalText) {
                    textEl.innerHTML = originalText;
                }
            }
        });

        currentMessageSearch = { index: 0, results };
        if (results.length > 0) {
            highlightSearchResult(results[0]);
        }
        document.getElementById('searchMessagesCount').textContent = results.length > 0 
            ? `${currentMessageSearch.index + 1}/${results.length}` 
            : '0';
    }

    function highlightSearchResult(index) {
        const container = document.getElementById('messagesContainer');
        const messages = Array.from(container.children).filter(el => el.classList.contains('message'));
        messages.forEach(msg => msg.classList.remove('search-highlight'));
        if (messages[index]) {
            messages[index].classList.add('search-highlight');
            messages[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function nextSearchResult() {
        if (currentMessageSearch.results.length === 0) return;
        currentMessageSearch.index = (currentMessageSearch.index + 1) % currentMessageSearch.results.length;
        highlightSearchResult(currentMessageSearch.results[currentMessageSearch.index]);
        document.getElementById('searchMessagesCount').textContent = 
            `${currentMessageSearch.index + 1}/${currentMessageSearch.results.length}`;
    }

    function prevSearchResult() {
        if (currentMessageSearch.results.length === 0) return;
        currentMessageSearch.index = (currentMessageSearch.index - 1 + currentMessageSearch.results.length) % currentMessageSearch.results.length;
        highlightSearchResult(currentMessageSearch.results[currentMessageSearch.index]);
        document.getElementById('searchMessagesCount').textContent = 
            `${currentMessageSearch.index + 1}/${currentMessageSearch.results.length}`;
    }

    // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–ê–ù–ê–õ–û–í ====================
    async function createChannel() {
        const channelName = document.getElementById('channelName').value.trim();
        const channelDesc = document.getElementById('channelDescription').value.trim();
        const channelType = document.getElementById('channelType').value;
        
        if (!channelName) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞', 'error');
            return;
        }
        
        showLoading(true);
        try {
            const channelData = {
                name: channelName,
                description: channelDesc || '',
                type: channelType,
                ownerId: currentUser.id,
                subscribers: [currentUser.id],
                subscriberCount: 1,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                isChannel: true
            };
            
            if (authError) {
                const channelId = 'channel_' + Date.now();
                const channel = {
                    id: channelId,
                    ...channelData,
                    subscribers: [currentUser.id],
                    subscriberCount: 1
                };
                
                const channels = JSON.parse(localStorage.getItem('absgram_channels') || '[]');
                channels.push(channel);
                localStorage.setItem('absgram_channels', JSON.stringify(channels));
                
                const chats = JSON.parse(localStorage.getItem('absgram_chats') || '[]');
                const chat = {
                    id: channelId,
                    participants: [currentUser.id],
                    isChannel: true,
                    channelName: channelName,
                    channelDesc: channelDesc,
                    channelOwner: currentUser.id,
                    channelType: channelType,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    lastMessage: '–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω',
                    subscriberCount: 1
                };
                chats.push(chat);
                localStorage.setItem('absgram_chats', JSON.stringify(chats));
                
                closeGroupModal();
                loadChats();
                showLoading(false);
                return;
            }
            
            const channelRef = await addDoc(collection(db, 'channels'), channelData);
            
            const chatData = {
                participants: [currentUser.id],
                isChannel: true,
                channelName: channelName,
                channelDesc: channelDesc,
                channelOwner: currentUser.id,
                channelType: channelType,
                channelId: channelRef.id,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                lastMessage: '–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω',
                subscriberCount: 1
            };
            
            const chatRef = await addDoc(collection(db, 'chats'), chatData);
            channels.set(channelRef.id, { id: channelRef.id, ...channelData });
            userSubscriptions.add(channelRef.id);
            
            showNotification('–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω!', 'success');
            closeGroupModal();
            loadChats();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞', 'error');
        } finally {
            showLoading(false);
        }
    }

    async function subscribeToChannel(channelId) {
        if (!currentUser) return;
        
        try {
            if (authError) {
                const channels = JSON.parse(localStorage.getItem('absgram_channels') || '[]');
                const channelIndex = channels.findIndex(c => c.id === channelId);
                if (channelIndex !== -1) {
                    channels[channelIndex].subscribers.push(currentUser.id);
                    channels[channelIndex].subscriberCount = channels[channelIndex].subscribers.length;
                    localStorage.setItem('absgram_channels', JSON.stringify(channels));
                }
                
                const chats = JSON.parse(localStorage.getItem('absgram_chats') || '[]');
                const chat = chats.find(c => c.id === channelId);
                if (chat) {
                    chat.participants.push(currentUser.id);
                    chat.subscriberCount = chat.participants.length;
                    localStorage.setItem('absgram_chats', JSON.stringify(chats));
                }
                
                userSubscriptions.add(channelId);
                showNotification('–í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª', 'success');
                return;
            }
            
            const channelRef = doc(db, 'channels', channelId);
            await updateDoc(channelRef, {
                subscribers: arrayUnion(currentUser.id),
                subscriberCount: increment(1),
                updatedAt: serverTimestamp()
            });
            
            const chatRef = doc(db, 'chats', channelId);
            await updateDoc(chatRef, {
                participants: arrayUnion(currentUser.id),
                subscriberCount: increment(1),
                updatedAt: serverTimestamp()
            });
            
            userSubscriptions.add(channelId);
            showNotification('–í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª', 'success');
            loadChats();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏', 'error');
        }
    }

    async function unsubscribeFromChannel(channelId) {
        if (!currentUser) return;
        
        try {
            if (authError) {
                const channels = JSON.parse(localStorage.getItem('absgram_channels') || '[]');
                const channelIndex = channels.findIndex(c => c.id === channelId);
                if (channelIndex !== -1) {
                    channels[channelIndex].subscribers = channels[channelIndex].subscribers.filter(id => id !== currentUser.id);
                    channels[channelIndex].subscriberCount = channels[channelIndex].subscribers.length;
                    localStorage.setItem('absgram_channels', JSON.stringify(channels));
                }
                
                const chats = JSON.parse(localStorage.getItem('absgram_chats') || '[]');
                const chatIndex = chats.findIndex(c => c.id === channelId);
                if (chatIndex !== -1) {
                    chats[chatIndex].participants = chats[chatIndex].participants.filter(id => id !== currentUser.id);
                    chats[chatIndex].subscriberCount = chats[chatIndex].participants.length;
                    localStorage.setItem('absgram_chats', JSON.stringify(chats));
                }
                
                userSubscriptions.delete(channelId);
                showNotification('–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –∫–∞–Ω–∞–ª–∞', 'info');
                return;
            }
            
            const channelRef = doc(db, 'channels', channelId);
            await updateDoc(channelRef, {
                subscribers: arrayRemove(currentUser.id),
                subscriberCount: increment(-1),
                updatedAt: serverTimestamp()
            });
            
            const chatRef = doc(db, 'chats', channelId);
            await updateDoc(chatRef, {
                participants: arrayRemove(currentUser.id),
                subscriberCount: increment(-1),
                updatedAt: serverTimestamp()
            });
            
            userSubscriptions.delete(channelId);
            showNotification('–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –∫–∞–Ω–∞–ª–∞', 'info');
            loadChats();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç –∫–∞–Ω–∞–ª–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø–∏—Å–∫–∏', 'error');
        }
    }

    // ==================== –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò ====================
    function showEditMessageModal(messageId, currentText) {
        currentlyEditingMessage = messageId;
        const newText = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:', currentText);
        if (newText && newText.trim() !== '') {
            editMessage(messageId, newText.trim());
        }
    }

    async function editMessage(messageId, newText) {
        if (!currentUser || !currentChat) return;
        
        try {
            if (authError) {
                const messages = JSON.parse(localStorage.getItem('absgram_messages') || '[]');
                const index = messages.findIndex(m => m.id === messageId);
                if (index !== -1) {
                    messages[index].text = newText;
                    messages[index].edited = true;
                    messages[index].editedAt = new Date();
                    localStorage.setItem('absgram_messages', JSON.stringify(messages));
                    loadMessages(currentChat.id);
                    showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ', 'success');
                }
                return;
            }
            
            const messageRef = doc(db, 'messages', messageId);
            await updateDoc(messageRef, {
                text: newText,
                edited: true,
                editedAt: serverTimestamp()
            });
            
            showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ', 'success');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
            showNotification('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
        }
        currentlyEditingMessage = null;
    }

    async function addReaction(messageId, reaction) {
        if (!currentUser) return;
        
        try {
            if (authError) {
                const messages = JSON.parse(localStorage.getItem('absgram_messages') || '[]');
                const index = messages.findIndex(m => m.id === messageId);
                if (index !== -1) {
                    if (!messages[index].reactions) messages[index].reactions = {};
                    if (!messages[index].reactions[reaction]) messages[index].reactions[reaction] = [];
                    
                    const userIndex = messages[index].reactions[reaction].indexOf(currentUser.id);
                    if (userIndex === -1) {
                        messages[index].reactions[reaction].push(currentUser.id);
                    } else {
                        messages[index].reactions[reaction].splice(userIndex, 1);
                        if (messages[index].reactions[reaction].length === 0) {
                            delete messages[index].reactions[reaction];
                        }
                    }
                    
                    localStorage.setItem('absgram_messages', JSON.stringify(messages));
                    loadMessages(currentChat.id);
                }
                return;
            }
            
            const messageRef = doc(db, 'messages', messageId);
            const messageDoc = await getDoc(messageRef);
            
            if (messageDoc.exists()) {
                const reactions = messageDoc.data().reactions || {};
                
                if (!reactions[reaction]) reactions[reaction] = [];
                
                const userIndex = reactions[reaction].indexOf(currentUser.id);
                if (userIndex === -1) {
                    reactions[reaction].push(currentUser.id);
                } else {
                    reactions[reaction].splice(userIndex, 1);
                    if (reactions[reaction].length === 0) {
                        delete reactions[reaction];
                    }
                }
                
                await updateDoc(messageRef, { reactions });
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏:', error);
        }
    }

    // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ù–ï–ü–†–û–ß–ò–¢–ê–ù–ù–´–• –°–û–û–ë–©–ï–ù–ò–ô ====================
    function updateUnreadCounts() {
        if (!currentUser) return;
        
        if (authError) {
            const messages = JSON.parse(localStorage.getItem('absgram_messages') || '[]');
            const unreadMap = new Map();
            
            messages.forEach(msg => {
                if (msg.senderId !== currentUser.id && !msg.read && msg.chatId) {
                    unreadMap.set(msg.chatId, (unreadMap.get(msg.chatId) || 0) + 1);
                }
            });
            
            unreadCounts = unreadMap;
            updateChatListUnreadBadges();
            return;
        }
        
        try {
            const messagesQuery = query(
                collection(db, 'messages'),
                where('read', '==', false)
            );
            
            onSnapshot(messagesQuery, (snapshot) => {
                const unreadMap = new Map();
                
                snapshot.forEach(doc => {
                    const message = doc.data();
                    if (message.senderId !== currentUser.id && message.chatId) {
                        unreadMap.set(message.chatId, (unreadMap.get(message.chatId) || 0) + 1);
                    }
                });
                
                unreadCounts = unreadMap;
                updateChatListUnreadBadges();
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
        }
    }

    function updateChatListUnreadBadges() {
        const chatItems = document.querySelectorAll('.chat-item');
        
        chatItems.forEach(item => {
            if (item.dataset.chatId) {
                const chatId = item.dataset.chatId;
                const unreadCount = unreadCounts.get(chatId) || 0;
                
                const oldBadge = item.querySelector('.chat-unread-badge');
                if (oldBadge) {
                    oldBadge.remove();
                }
                
                if (unreadCount > 0) {
                    const badge = document.createElement('div');
                    badge.className = 'chat-unread-badge';
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    const infoDiv = item.querySelector('.chat-info');
                    if (infoDiv) {
                        infoDiv.appendChild(badge);
                    }
                }
            }
        });
    }

    async function markMessagesAsRead(chatId) {
        if (!currentUser) return;
        
        try {
            if (authError) {
                const messages = JSON.parse(localStorage.getItem('absgram_messages') || '[]');
                let updated = false;
                
                const updatedMessages = messages.map(msg => {
                    if (msg.chatId === chatId && msg.senderId !== currentUser.id && !msg.read) {
                        msg.read = true;
                        updated = true;
                    }
                    return msg;
                });
                
                if (updated) {
                    localStorage.setItem('absgram_messages', JSON.stringify(updatedMessages));
                    unreadCounts.delete(chatId);
                    updateChatListUnreadBadges();
                }
                return;
            }
            
            const messagesQuery = query(
                collection(db, 'messages'),
                where('chatId', '==', chatId),
                where('senderId', '!=', currentUser.id),
                where('read', '==', false)
            );
            
            const snapshot = await getDocs(messagesQuery);
            const updatePromises = [];
            
            snapshot.forEach(doc => {
                updatePromises.push(updateDoc(doc.ref, { read: true }));
            });
            
            await Promise.all(updatePromises);
            
            unreadCounts.delete(chatId);
            updateChatListUnreadBadges();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–º–µ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:', error);
        }
    }

    // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–ò–î–ï–û–°–û–û–ë–©–ï–ù–ò–ô ====================
    async function startVideoRecording() {
        try {
            const constraints = {
                video: {
                    facingMode: currentCamera,
                    width: { ideal: 640 },
                    height: { ideal: 640 }
                },
                audio: true
            };
            
            videoStream = await navigator.mediaDevices.getUserMedia(constraints);
            
            const preview = document.getElementById('videoRecordingPreview');
            preview.srcObject = videoStream;
            
            const options = {
                mimeType: 'video/webm;codecs=vp9,opus',
                videoBitsPerSecond: 2000000
            };
            
            try {
                videoMediaRecorder = new MediaRecorder(videoStream, options);
            } catch (e) {
                console.log('–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è webm, –ø—Ä–æ–±—É–µ–º mp4:', e);
                videoMediaRecorder = new MediaRecorder(videoStream);
            }
            
            videoChunks = [];
            
            videoMediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    videoChunks.push(event.data);
                }
            };
            
            document.getElementById('videoRecordingModal').classList.remove('hidden');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ', 'error');
        }
    }

    function startRecordingVideo() {
        if (!videoMediaRecorder) return;
        
        videoMediaRecorder.start(100);
        isVideoRecording = true;
        videoRecordingStartTime = Date.now();
        
        document.getElementById('recordStartBtn').classList.add('recording');
        document.getElementById('recordStartBtn').style.display = 'none';
        document.getElementById('recordStopBtn').style.display = 'flex';
        document.getElementById('recordingIndicator').style.display = 'flex';
        
        videoRecordingTimer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - videoRecordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('videoRecordingTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (elapsed >= maxVideoDuration) {
                stopRecordingVideo();
            }
        }, 1000);
    }

    function stopRecordingVideo() {
        if (!isVideoRecording || !videoMediaRecorder) return;
        
        videoMediaRecorder.stop();
        isVideoRecording = false;
        
        if (videoRecordingTimer) {
            clearInterval(videoRecordingTimer);
            videoRecordingTimer = null;
        }
        
        document.getElementById('recordStartBtn').classList.remove('recording');
        document.getElementById('recordStartBtn').style.display = 'flex';
        document.getElementById('recordStopBtn').style.display = 'none';
        document.getElementById('recordingIndicator').style.display = 'none';
    }

    async function sendVideoMessage() {
        if (videoChunks.length === 0) {
            showNotification('–í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ', 'error');
            closeVideoRecordingModal();
            return;
        }
        
        showLoading(true);
        
        try {
            const videoBlob = new Blob(videoChunks, { type: 'video/webm' });
            const duration = Math.floor((Date.now() - videoRecordingStartTime) / 1000);
            
            if (videoBlob.size > maxVideoSize) {
                await sendLargeVideoMessage(videoBlob, duration);
            } else {
                await sendSingleVideoMessage(videoBlob, duration);
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
        } finally {
            showLoading(false);
            closeVideoRecordingModal();
        }
    }

    async function sendSingleVideoMessage(videoBlob, duration) {
        const reader = new FileReader();
        
        reader.onload = async function(event) {
            const base64Video = event.target.result;
            
            if (authError) {
                const messageId = 'msg_' + Date.now();
                const message = {
                    id: messageId,
                    chatId: currentChat.id,
                    senderId: currentUser.id,
                    text: '[–í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ]',
                    type: 'video',
                    fileData: base64Video,
                    fileName: `videomessage_${Date.now()}.webm`,
                    fileType: 'video/webm',
                    fileSize: videoBlob.size,
                    duration: duration,
                    createdAt: new Date(),
                    read: false,
                    senderName: currentUser.name,
                    isVideoCircle: true
                };
                
                const messages = JSON.parse(localStorage.getItem('absgram_messages') || '[]');
                messages.push(message);
                localStorage.setItem('absgram_messages', JSON.stringify(messages));
                
                const chats = JSON.parse(localStorage.getItem('absgram_chats') || '[]');
                const chatIndex = chats.findIndex(c => c.id === currentChat.id);
                if (chatIndex !== -1) {
                    chats[chatIndex].lastMessage = 'üé¨ –í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ';
                    chats[chatIndex].updatedAt = new Date();
                    localStorage.setItem('absgram_chats', JSON.stringify(chats));
                }
                
                addMessageToChat(message);
                loadChats();
                showNotification('–í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                return;
            }
            
            const messageData = {
                chatId: currentChat.id,
                senderId: currentUser.id,
                text: '[–í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ]',
                type: 'video',
                fileData: base64Video,
                fileName: `videomessage_${Date.now()}.webm`,
                fileType: 'video/webm',
                fileSize: videoBlob.size,
                duration: duration,
                createdAt: serverTimestamp(),
                read: false,
                isVideoCircle: true
            };
            
            await addDoc(collection(db, 'messages'), messageData);
            
            await updateDoc(doc(db, 'chats', currentChat.id), {
                lastMessage: 'üé¨ –í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ',
                updatedAt: serverTimestamp()
            });
            
            showNotification('–í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
            loadChats();
        };
        
        reader.readAsDataURL(videoBlob);
    }

    async function sendLargeVideoMessage(videoBlob, duration) {
        showNotification('–í–∏–¥–µ–æ –±–æ–ª—å—à–æ–µ, —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏...', 'info');
        
        const chunkSize = 500 * 1024; // 500KB —á–∞–Ω–∫–∏
        const totalChunks = Math.ceil(videoBlob.size / chunkSize);
        const fileId = 'video_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        const videoRecord = {
            fileId: fileId,
            fileName: `videomessage_${Date.now()}.webm`,
            fileType: 'video/webm',
            fileSize: videoBlob.size,
            duration: duration,
            totalChunks: totalChunks,
            uploadedChunks: 0,
            chatId: currentChat.id,
            senderId: currentUser.id,
            senderName: currentUser.name,
            isVideoCircle: true,
            createdAt: serverTimestamp(),
            status: 'uploading'
        };
        
        try {
            const fileRef = await addDoc(collection(db, 'large_videos'), videoRecord);
            
            for (let i = 0; i < totalChunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize, videoBlob.size);
                const chunk = videoBlob.slice(start, end);
                
                const reader = new FileReader();
                const chunkData = await new Promise((resolve, reject) => {
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(chunk);
                });
                
                await addDoc(collection(db, 'video_chunks'), {
                    fileId: fileId,
                    chunkIndex: i,
                    chunkData: chunkData,
                    totalChunks: totalChunks,
                    createdAt: serverTimestamp()
                });
                
                await updateDoc(fileRef, {
                    uploadedChunks: i + 1,
                    updatedAt: serverTimestamp()
                });
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            await updateDoc(fileRef, {
                status: 'completed',
                completedAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            });
            
            const messageData = {
                chatId: currentChat.id,
                senderId: currentUser.id,
                text: '[–í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ]',
                type: 'video',
                fileId: fileId,
                fileName: `videomessage_${Date.now()}.webm`,
                fileType: 'video/webm',
                fileSize: videoBlob.size,
                duration: duration,
                createdAt: serverTimestamp(),
                read: false,
                isVideoCircle: true
            };
            
            await addDoc(collection(db, 'messages'), messageData);
            
            await updateDoc(doc(db, 'chats', currentChat.id), {
                lastMessage: 'üé¨ –í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ (–±–æ–ª—å—à–æ–µ)',
                updatedAt: serverTimestamp()
            });
            
            showNotification('–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ —á–∞—Å—Ç—è–º', 'success');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–æ–ª—å—à–æ–≥–æ –≤–∏–¥–µ–æ:', error);
            throw error;
        }
    }

    async function downloadLargeVideo(fileId) {
        try {
            showLoading(true);
            
            const videosQuery = query(
                collection(db, 'large_videos'),
                where('fileId', '==', fileId),
                limit(1)
            );
            
            const snapshot = await getDocs(videosQuery);
            if (snapshot.empty) {
                throw new Error('–í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            }
            
            const videoData = snapshot.docs[0].data();
            
            showNotification(`–°–∫–∞—á–∏–≤–∞–µ–º –≤–∏–¥–µ–æ ${videoData.fileName}...`, 'info');
            
            const chunksQuery = query(
                collection(db, 'video_chunks'),
                where('fileId', '==', fileId),
                orderBy('chunkIndex', 'asc')
            );
            
            const chunksSnapshot = await getDocs(chunksQuery);
            
            if (chunksSnapshot.size === 0) {
                throw new Error('–ß–∞–Ω–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            }
            
            const chunks = [];
            chunksSnapshot.forEach(doc => {
                chunks.push(doc.data().chunkData);
            });
            
            if (chunks.length !== videoData.totalChunks) {
                showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${chunks.length} –∏–∑ ${videoData.totalChunks} —á–∞—Å—Ç–µ–π`, 'warning');
            }
            
            let base64Data = '';
            for (const chunk of chunks) {
                const base64Part = chunk.split(',')[1];
                base64Data += base64Part;
            }
            
            const fullBase64 = `data:${videoData.fileType};base64,${base64Data}`;
            
            const link = document.createElement('a');
            link.href = fullBase64;
            link.download = videoData.fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showDownloadNotification(videoData.fileName);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    function switchCamera() {
        currentCamera = currentCamera === 'user' ? 'environment' : 'user';
        
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
        }
        
        startVideoRecording();
    }

    function closeVideoRecordingModal() {
        document.getElementById('videoRecordingModal').classList.add('hidden');
        
        if (isVideoRecording) {
            stopRecordingVideo();
        }
        
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        
        if (videoRecordingTimer) {
            clearInterval(videoRecordingTimer);
            videoRecordingTimer = null;
        }
        
        document.getElementById('videoRecordingTimer').textContent = '00:00';
        document.getElementById('recordStartBtn').classList.remove('recording');
        document.getElementById('recordStartBtn').style.display = 'flex';
        document.getElementById('recordStopBtn').style.display = 'none';
        document.getElementById('recordingIndicator').style.display = 'none';
    }

    // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –§–ê–ô–õ–ê–ú–ò ====================
    async function compressVideo(file, maxSizeMB = 500) {
        return new Promise((resolve, reject) => {
            const maxSizeBytes = maxSizeMB * 1024 * 1024;
            
            if (file.size <= maxSizeBytes) {
                resolve(file);
                return;
            }
            
            showNotification(`–í–∏–¥–µ–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (${formatFileSize(file.size)}). –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 500MB.`, 'error');
            reject(new Error('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π'));
        });
    }

    async function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => resolve(event.target.result);
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
        });
    }

    // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–¢–ü–†–ê–í–ö–ò –ë–û–õ–¨–®–ò–• –§–ê–ô–õ–û–í ====================
    async function sendLargeFile(file, chatId, messageType) {
        try {
            const fileId = 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const chunkSize = 500 * 1024; // 500KB —á–∞–Ω–∫–∏
            const totalChunks = Math.ceil(file.size / chunkSize);
            
            showNotification(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª ${file.name} (${totalChunks} —á–∞—Å—Ç–µ–π)...`, 'info');
            
            const fileRecord = {
                fileId: fileId,
                fileName: file.name,
                fileType: file.type,
                fileSize: file.size,
                totalChunks: totalChunks,
                uploadedChunks: 0,
                chatId: chatId,
                senderId: currentUser.id,
                senderName: currentUser.name,
                messageType: messageType,
                createdAt: serverTimestamp(),
                status: 'uploading'
            };
            
            const fileRef = await addDoc(collection(db, 'large_files'), fileRecord);
            
            for (let i = 0; i < totalChunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);
                
                const reader = new FileReader();
                const chunkData = await new Promise((resolve, reject) => {
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(chunk);
                });
                
                await addDoc(collection(db, 'file_chunks'), {
                    fileId: fileId,
                    chunkIndex: i,
                    chunkData: chunkData,
                    totalChunks: totalChunks,
                    createdAt: serverTimestamp()
                });
                
                await updateDoc(fileRef, {
                    uploadedChunks: i + 1,
                    updatedAt: serverTimestamp()
                });
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            await updateDoc(fileRef, {
                status: 'completed',
                completedAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            });
            
            const messageData = {
                chatId: chatId,
                senderId: currentUser.id,
                text: messageType === 'image' ? '[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]' : 
                      messageType === 'video' ? '[–í–∏–¥–µ–æ]' : '[–§–∞–π–ª]',
                type: messageType,
                fileId: fileId,
                fileName: file.name,
                fileType: file.type,
                fileSize: file.size,
                createdAt: serverTimestamp(),
                read: false
            };
            
            await addDoc(collection(db, 'messages'), messageData);
            
            let lastMessage = messageType === 'image' ? 'üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' :
                            messageType === 'video' ? 'üé¨ –í–∏–¥–µ–æ' : 
                            `üìé ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}`;
            
            await updateDoc(doc(db, 'chats', chatId), {
                lastMessage: lastMessage,
                updatedAt: serverTimestamp()
            });
            
            showNotification('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
            return true;
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–æ–ª—å—à–æ–≥–æ —Ñ–∞–π–ª–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
            return false;
        }
    }

    async function downloadLargeFile(fileId) {
        try {
            showLoading(true);
            
            const filesQuery = query(
                collection(db, 'large_files'),
                where('fileId', '==', fileId),
                limit(1)
            );
            
            const snapshot = await getDocs(filesQuery);
            if (snapshot.empty) {
                throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            const fileData = snapshot.docs[0].data();
            
            showNotification(`–°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª ${fileData.fileName}...`, 'info');
            
            const chunksQuery = query(
                collection(db, 'file_chunks'),
                where('fileId', '==', fileId),
                orderBy('chunkIndex', 'asc')
            );
            
            const chunksSnapshot = await getDocs(chunksQuery);
            
            if (chunksSnapshot.size === 0) {
                throw new Error('–ß–∞–Ω–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            }
            
            const chunks = [];
            chunksSnapshot.forEach(doc => {
                chunks.push(doc.data().chunkData);
            });
            
            if (chunks.length !== fileData.totalChunks) {
                showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${chunks.length} –∏–∑ ${fileData.totalChunks} —á–∞—Å—Ç–µ–π`, 'warning');
            }
            
            let base64Data = '';
            for (const chunk of chunks) {
                const base64Part = chunk.split(',')[1];
                base64Data += base64Part;
            }
            
            const mimeType = fileData.fileType || 'application/octet-stream';
            const fullBase64 = `data:${mimeType};base64,${base64Data}`;
            
            const link = document.createElement('a');
            link.href = fullBase64;
            link.download = fileData.fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showDownloadNotification(fileData.fileName);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –§–ê–ô–õ–û–í ====================
    function downloadFileFromMessage(base64Data, fileName, fileType) {
        try {
            if (base64Data && base64Data.startsWith('file_')) {
                downloadLargeFile(base64Data);
                return;
            }
            
            if (base64Data && base64Data.startsWith('video_')) {
                downloadLargeVideo(base64Data);
                return;
            }
            
            if (base64Data.startsWith('http') || base64Data.startsWith('blob')) {
                window.open(base64Data, '_blank');
                return;
            }
            
            const byteString = atob(base64Data.split(',')[1]);
            const mimeString = base64Data.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            
            const blob = new Blob([ab], { type: mimeString });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName || 'file';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showDownloadNotification(fileName || '—Ñ–∞–π–ª');
            
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞:', error);
            try {
                window.open(base64Data, '_blank');
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞', 'error');
            }
        }
    }

    // ==================== –§–£–ù–ö–¶–ò–ò –ó–í–û–ù–ö–û–í (–ü–û–õ–ù–û–°–¢–¨–Æ –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–´) ====================
    function toggleCallsDisabled() {
        isCallDisabled = !isCallDisabled;
        const disableBtn = document.getElementById('disableCallBtn');
        
        if (isCallDisabled) {
            disableBtn.classList.add('active');
            disableBtn.innerHTML = 'üîï';
            disableBtn.title = '–í–∫–ª—é—á–∏—Ç—å –∑–≤–æ–Ω–∫–∏';
            showNotification('–ó–≤–æ–Ω–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã', 'warning');
            
            document.getElementById('callBtn').style.display = 'none';
            document.getElementById('videoCallBtn').style.display = 'none';
            
            if (activeCall) {
                endCall();
            }
        } else {
            disableBtn.classList.remove('active');
            disableBtn.innerHTML = 'üîî';
            disableBtn.title = '–û—Ç–∫–ª—é—á–∏—Ç—å –∑–≤–æ–Ω–∫–∏';
            showNotification('–ó–≤–æ–Ω–∫–∏ –≤–∫–ª—é—á–µ–Ω—ã', 'success');
            
            if (currentChat && !currentChat.isGroup && !currentChat.isChannel) {
                document.getElementById('callBtn').style.display = 'flex';
                document.getElementById('videoCallBtn').style.display = 'flex';
            }
        }
        
        saveCallsDisabledState();
    }

    function saveCallsDisabledState() {
        if (currentUser) {
            localStorage.setItem(`absgram_calls_disabled_${currentUser.id}`, isCallDisabled);
        }
    }

    function loadCallsDisabledState() {
        if (currentUser) {
            const saved = localStorage.getItem(`absgram_calls_disabled_${currentUser.id}`);
            if (saved !== null) {
                isCallDisabled = saved === 'true';
                const disableBtn = document.getElementById('disableCallBtn');
                
                if (isCallDisabled) {
                    disableBtn.classList.add('active');
                    disableBtn.innerHTML = 'üîï';
                    disableBtn.title = '–í–∫–ª—é—á–∏—Ç—å –∑–≤–æ–Ω–∫–∏';
                } else {
                    disableBtn.classList.remove('active');
                    disableBtn.innerHTML = 'üîî';
                    disableBtn.title = '–û—Ç–∫–ª—é—á–∏—Ç—å –∑–≤–æ–Ω–∫–∏';
                }
            }
        }
    }

    function updateCallButtonsVisibility() {
        if (!currentChat) return;
        
        if (currentChat.isGroup || currentChat.isChannel || isCallDisabled) {
            document.getElementById('callBtn').style.display = 'none';
            document.getElementById('videoCallBtn').style.display = 'none';
        } else {
            document.getElementById('callBtn').style.display = 'flex';
            document.getElementById('videoCallBtn').style.display = 'flex';
        }
    }

    function showCallTypeModal() {
        if (!currentChat || currentChat.isGroup || currentChat.isChannel) {
            showNotification('–ó–≤–æ–Ω–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö', 'error');
            return;
        }

        if (activeCall) {
            showNotification('–£–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫', 'warning');
            return;
        }

        document.querySelectorAll('.call-type-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        selectedCallType = 'audio';
        document.getElementById('audioCallOption').classList.add('selected');
        
        document.getElementById('callTypeModal').classList.remove('hidden');
    }

    async function startCall() {
        if (!currentChat || !currentChat.otherUser) return;
        
        if (isCallDisabled) {
            showNotification('–ó–≤–æ–Ω–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã. –í–∫–ª—é—á–∏—Ç–µ –∏—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.', 'warning');
            return;
        }

        try {
            showLoading(true);

            const constraints = selectedCallType === 'video' 
                ? { audio: true, video: true } 
                : { audio: true };
            
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            
            if (selectedCallType === 'video') {
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
                document.getElementById('videoContainer').style.display = 'block';
                document.getElementById('audioCallContainer').style.display = 'none';
            } else {
                document.getElementById('videoContainer').style.display = 'none';
                document.getElementById('audioCallContainer').style.display = 'block';
            }

            const callId = generateCallId();
            currentCallId = callId;

            const callMessage = {
                chatId: currentChat.id,
                senderId: currentUser.id,
                senderName: currentUser.name,
                type: 'call',
                callType: selectedCallType,
                callId: callId,
                text: selectedCallType === 'video' ? 
                    `üìπ ${currentUser.name} –Ω–∞—á–∞–ª –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫` : 
                    `üìû ${currentUser.name} –Ω–∞—á–∞–ª –∞—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫`,
                createdAt: serverTimestamp(),
                callActive: true,
                recipientId: currentChat.otherUser.id
            };

            const callRef = await addDoc(collection(db, 'messages'), callMessage);

            activeCall = {
                id: callId,
                chatId: currentChat.id,
                userId: currentChat.otherUser.id,
                userName: getUserDisplayName(currentChat.otherUser),
                isIncoming: false,
                callType: selectedCallType,
                startTime: new Date(),
                messageId: callRef.id,
                stream: localStream
            };

            setupPeerConnection(true);

            showActiveCallScreen(activeCall);
            startCallTimer();

            await updateDoc(doc(db, 'chats', currentChat.id), {
                lastMessage: selectedCallType === 'video' ? 'üìπ –ò—Å—Ö–æ–¥—è—â–∏–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫' : 'üìû –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫',
                updatedAt: serverTimestamp()
            });

            showLoading(false);
            showNotification('–ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç', 'success');

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞:', error);
            showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            showLoading(false);
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
        }
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ù–ê–°–¢–†–û–ô–ö–ò PEER CONNECTION –° –ù–û–†–ú–ê–õ–¨–ù–´–ú–ò ICE –°–ï–†–í–ï–†–ê–ú–ò
    function setupPeerConnection(isInitiator) {
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
                // –î–æ–±–∞–≤–ª—è–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ TURN —Å–µ—Ä–≤–µ—Ä—ã (–¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
                {
                    urls: 'turn:openrelay.metered.ca:80',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                },
                {
                    urls: 'turn:openrelay.metered.ca:443',
                    username: 'openrelayproject',
                    credential: 'openrelayproject'
                }
            ],
            iceCandidatePoolSize: 10
        };

        if (peerConnection) {
            peerConnection.close();
        }
        peerConnection = new RTCPeerConnection(configuration);

        if (localStream) {
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        peerConnection.onicecandidate = async (event) => {
            if (event.candidate && activeCall) {
                console.log('üìû –ù–æ–≤—ã–π ICE –∫–∞–Ω–¥–∏–¥–∞—Ç');
                try {
                    await addDoc(collection(db, 'call_signals'), {
                        callId: activeCall.id,
                        candidate: event.candidate.toJSON(),
                        from: currentUser.id,
                        to: activeCall.userId,
                        timestamp: serverTimestamp()
                    });
                } catch (err) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:', err);
                }
            }
        };

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ (–≤–∏–¥–µ–æ/–∞—É–¥–∏–æ)
        peerConnection.ontrack = (event) => {
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo) {
                remoteVideo.srcObject = event.streams[0];
                remoteStream = event.streams[0];
                console.log('üìû –£–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω');
            }
        };

        // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        peerConnection.onconnectionstatechange = () => {
            console.log('üìû –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', peerConnection.connectionState);
            if (peerConnection.connectionState === 'connected') {
                console.log('üìû –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
                showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            } else if (peerConnection.connectionState === 'disconnected' || 
                       peerConnection.connectionState === 'failed') {
                console.log('üìû –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');
                showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ', 'error');
                endCall();
            }
        };

        peerConnection.oniceconnectionstatechange = () => {
            console.log('üìû ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', peerConnection.iceConnectionState);
            updateConnectionQuality();
        };

        peerConnection.onsignalingstatechange = () => {
            console.log('üìû –°–∏–≥–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', peerConnection.signalingState);
        };

        if (isInitiator) {
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    return addDoc(collection(db, 'call_signals'), {
                        callId: activeCall.id,
                        offer: peerConnection.localDescription.toJSON(),
                        from: currentUser.id,
                        to: activeCall.userId,
                        timestamp: serverTimestamp()
                    });
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ñ—Ñ–µ—Ä–∞:', error));
        }

        listenForSignals();
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–†–û–°–õ–£–®–ö–ò –°–ò–ì–ù–ê–õ–û–í
    async function listenForSignals() {
        if (!activeCall) return;

        // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è
        if (callListeners.has('signals')) {
            callListeners.get('signals')();
            callListeners.delete('signals');
        }

        const signalsQuery = query(
            collection(db, 'call_signals'),
            where('callId', '==', activeCall.id),
            orderBy('timestamp', 'asc')
        );

        const unsubscribe = onSnapshot(signalsQuery, async (snapshot) => {
            snapshot.docChanges().forEach(async (change) => {
                if (change.type === 'added') {
                    const signal = change.doc.data();
                    
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–≤–æ–∏ —Å–∏–≥–Ω–∞–ª—ã
                    if (signal.from === currentUser.id) return;

                    try {
                        if (signal.offer && !peerConnection.currentRemoteDescription) {
                            console.log('üìû –ü–æ–ª—É—á–µ–Ω offer, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º...');
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(signal.offer));
                            
                            const answer = await peerConnection.createAnswer();
                            await peerConnection.setLocalDescription(answer);
                            
                            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º answer
                            await addDoc(collection(db, 'call_signals'), {
                                callId: activeCall.id,
                                answer: peerConnection.localDescription.toJSON(),
                                from: currentUser.id,
                                to: signal.from,
                                timestamp: serverTimestamp()
                            });
                            console.log('üìû Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                        }
                        
                        else if (signal.answer && !peerConnection.currentRemoteDescription) {
                            console.log('üìû –ü–æ–ª—É—á–µ–Ω answer, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º...');
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(signal.answer));
                            console.log('üìû –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
                        }
                        
                        else if (signal.candidate) {
                            console.log('üìû –ü–æ–ª—É—á–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç');
                            try {
                                await peerConnection.addIceCandidate(new RTCIceCandidate(signal.candidate));
                            } catch (e) {
                                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:', e);
                            }
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–∞:', error);
                    }
                }
            });
        }, (error) => {
            console.error('–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è —Å–∏–≥–Ω–∞–ª–æ–≤:', error);
        });
        
        callListeners.set('signals', unsubscribe);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    async function updateConnectionQuality() {
        if (!peerConnection) return;
        
        try {
            const stats = await peerConnection.getStats();
            stats.forEach(report => {
                if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                    const rtt = report.currentRoundTripTime;
                    const qualityEl = document.getElementById('connectionQuality');
                    
                    if (rtt < 0.1) {
                        qualityEl.className = 'connection-quality good';
                        qualityEl.innerHTML = 'üì∂ –û—Ç–ª–∏—á–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ';
                    } else if (rtt < 0.3) {
                        qualityEl.className = 'connection-quality fair';
                        qualityEl.innerHTML = 'üì∂ –°—Ä–µ–¥–Ω–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ';
                    } else {
                        qualityEl.className = 'connection-quality poor';
                        qualityEl.innerHTML = 'üì∂ –ü–ª–æ—Ö–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ';
                    }
                }
            });
        } catch (error) {
            console.warn('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', error);
        }
    }

    async function answerCall(callData) {
        try {
            showLoading(true);

            const constraints = callData.callType === 'video' 
                ? { audio: true, video: true } 
                : { audio: true };
            
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            
            if (callData.callType === 'video') {
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
                document.getElementById('videoContainer').style.display = 'block';
                document.getElementById('audioCallContainer').style.display = 'none';
            } else {
                document.getElementById('videoContainer').style.display = 'none';
                document.getElementById('audioCallContainer').style.display = 'block';
            }

            currentCallId = callData.callId;

            await updateDoc(doc(db, 'messages', callData.id), {
                answered: true,
                answeredAt: serverTimestamp(),
                callActive: true
            });

            activeCall = {
                id: callData.callId,
                chatId: callData.chatId,
                userId: callData.senderId,
                userName: callData.senderName,
                isIncoming: true,
                callType: callData.callType,
                startTime: new Date(),
                messageId: callData.id,
                stream: localStream
            };

            setupPeerConnection(false);

            document.getElementById('callNotification').classList.add('hidden');
            stopRingtone();
            hideCallRingingIndicator();

            showActiveCallScreen(activeCall);
            startCallTimer();

            await updateDoc(doc(db, 'chats', callData.chatId), {
                lastMessage: callData.callType === 'video' ? 'üìπ –ü—Ä–∏–Ω—è—Ç—ã–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫' : 'üìû –ü—Ä–∏–Ω—è—Ç—ã–π –∑–≤–æ–Ω–æ–∫',
                updatedAt: serverTimestamp()
            });

            showLoading(false);
            showNotification('–ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç', 'success');

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞', 'error');
            showLoading(false);
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
        }
    }

    async function rejectCall(callData) {
        try {
            await updateDoc(doc(db, 'messages', callData.id), {
                callActive: false,
                rejected: true,
                rejectedAt: serverTimestamp()
            });

            await updateDoc(doc(db, 'chats', callData.chatId), {
                lastMessage: callData.callType === 'video' ? 'üìπ –û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫' : 'üìû –û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫',
                updatedAt: serverTimestamp()
            });

            document.getElementById('callNotification').classList.add('hidden');
            stopRingtone();
            hideCallRingingIndicator();
            incomingCallData = null;

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:', error);
        }
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ò–Ø –ó–í–û–ù–ö–ê (–î–û–ë–ê–í–õ–ï–ù–ê –û–ß–ò–°–¢–ö–ê –°–ò–ì–ù–ê–õ–û–í)
    async function endCall() {
        if (!activeCall) return;

        try {
            // –û—á–∏—â–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é cleanup –ø–æ–∑–∂–µ)
            if (activeCall.id) {
                try {
                    const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
                    const oldSignalsQuery = query(
                        collection(db, 'call_signals'),
                        where('callId', '==', activeCall.id),
                        where('timestamp', '<', oneHourAgo)
                    );
                    
                    const snapshot = await getDocs(oldSignalsQuery);
                    const deletePromises = [];
                    snapshot.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                    await Promise.all(deletePromises);
                } catch (error) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–∏–≥–Ω–∞–ª—ã:', error);
                }
            }

            if (speakingIndicatorInterval) {
                clearInterval(speakingIndicatorInterval);
                speakingIndicatorInterval = null;
            }

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            if (activeCall.messageId) {
                try {
                    await updateDoc(doc(db, 'messages', activeCall.messageId), {
                        callActive: false,
                        endedAt: serverTimestamp(),
                        duration: Math.floor((Date.now() - activeCall.startTime.getTime()) / 1000)
                    });
                } catch (error) {
                    console.log('–ó–≤–æ–Ω–æ–∫ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω –∏–ª–∏ —É–¥–∞–ª–µ–Ω');
                }
            }

            if (activeCall.chatId) {
                try {
                    await updateDoc(doc(db, 'chats', activeCall.chatId), {
                        lastMessage: activeCall.callType === 'video' ? 
                            `üìπ –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ (${formatCallDuration(activeCall.startTime)})` :
                            `üìû –ó–≤–æ–Ω–æ–∫ (${formatCallDuration(activeCall.startTime)})`,
                        updatedAt: serverTimestamp()
                    });
                } catch (error) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç:', error);
                }
            }

            document.getElementById('callActiveScreen').classList.add('hidden');
            
            if (currentChat) {
                showScreen('chatScreen');
            } else {
                showScreen('chatsScreen');
            }

            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }

            activeCall = null;
            currentCallId = null;
            isMuted = false;
            isSpeakerOn = false;
            isVideoOn = true;

            // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ –∑–≤–æ–Ω–∫–æ–≤
            if (callListeners.size > 0) {
                callListeners.forEach(unsubscribe => {
                    if (typeof unsubscribe === 'function') unsubscribe();
                });
                callListeners.clear();
            }

            loadChats();

            showNotification('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'info');

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞', 'error');
        }
    }

    async function checkCallStatus() {
        if (!activeCall || !activeCall.messageId) return;
        
        try {
            const callDoc = await getDoc(doc(db, 'messages', activeCall.messageId));
            if (callDoc.exists()) {
                const callData = callDoc.data();
                if (!callData.callActive) {
                    await endCall();
                    showNotification('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∑–≤–æ–Ω–æ–∫', 'info');
                }
            } else {
                await endCall();
                showNotification('–ó–≤–æ–Ω–æ–∫ –±—ã–ª –∑–∞–≤–µ—Ä—à–µ–Ω', 'info');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–≤–æ–Ω–∫–∞:', error);
        }
    }

    function showActiveCallScreen(call) {
        document.getElementById('callActiveName').textContent = call.userName;
        document.getElementById('callActiveStatus').textContent = call.isIncoming ? 
            '–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫' : '–ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫';
        document.getElementById('callActiveTimer').textContent = '00:00';

        const avatar = document.getElementById('callActiveAvatar');
        avatar.style.background = getRandomColor();
        avatar.textContent = call.userName.charAt(0).toUpperCase();

        if (call.callType === 'video') {
            document.getElementById('videoContainer').style.display = 'block';
            document.getElementById('audioCallContainer').style.display = 'none';
            document.getElementById('callTypeIcon').textContent = 'üìπ';
        } else {
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('audioCallContainer').style.display = 'block';
            document.getElementById('callTypeIcon').textContent = 'üìû';
        }

        startSpeakingIndicator();

        document.getElementById('callActiveScreen').classList.remove('hidden');
        
        updateCallButtons();
        
        if (call.checkInterval) {
            clearInterval(call.checkInterval);
        }
        call.checkInterval = setInterval(checkCallStatus, 5000);
    }

    function startSpeakingIndicator() {
        if (speakingIndicatorInterval) {
            clearInterval(speakingIndicatorInterval);
        }
        
        speakingIndicatorInterval = setInterval(() => {
            const indicator = document.getElementById('speakingIndicator');
            const isSpeaking = Math.random() > 0.7;
            
            if (isSpeaking) {
                indicator.classList.add('speaking-active');
            } else {
                indicator.classList.remove('speaking-active');
            }
        }, 1000);
    }

    function updateCallButtons() {
        const callBtn = document.getElementById('callBtn');
        const videoCallBtn = document.getElementById('videoCallBtn');
        
        if (activeCall) {
            if (activeCall.callType === 'video') {
                videoCallBtn.classList.add('active-call');
                videoCallBtn.innerHTML = 'üìû';
                videoCallBtn.title = '–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫';
                callBtn.style.display = 'none';
            } else {
                callBtn.classList.add('active-call');
                callBtn.innerHTML = 'üìû';
                callBtn.title = '–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫';
                videoCallBtn.style.display = 'none';
            }
        } else {
            callBtn.classList.remove('active-call');
            videoCallBtn.classList.remove('active-call');
            callBtn.innerHTML = 'üìû';
            videoCallBtn.innerHTML = 'üìπ';
            callBtn.title = '–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫';
            videoCallBtn.title = '–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫';
            
            updateCallButtonsVisibility();
        }
    }

    function startCallTimer() {
        callStartTime = new Date();
        
        if (callTimer) {
            clearInterval(callTimer);
        }
        
        callTimer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - callStartTime.getTime()) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('callActiveTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
            updateConnectionQuality();
        }, 1000);
    }

    function formatCallDuration(startTime) {
        const elapsed = Math.floor((Date.now() - startTime.getTime()) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function generateCallId() {
        return 'call_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // ==================== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û –ó–í–û–ù–ö–ê–• ====================
    async function setupCallListeners() {
        if (!currentUser || authError) return;

        try {
            const callsQuery = query(
                collection(db, 'messages'),
                where('type', '==', 'call'),
                where('recipientId', '==', currentUser.id),
                where('callActive', '==', true)
            );

            const unsubscribe = onSnapshot(callsQuery, async (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added' && !activeCall) {
                        const callData = {
                            id: change.doc.id,
                            ...change.doc.data()
                        };

                        if (callData.senderId === currentUser.id) return;
                        if (callData.callActive !== true) return;
                        if (incomingCallData && incomingCallData.id === callData.id) return;

                        incomingCallData = callData;

                        if (currentChat && currentChat.id === callData.chatId) {
                            showCallRingingIndicator(callData);
                        } else {
                            showIncomingCallNotification(callData);
                        }
                    }
                });
            }, (error) => {
                console.warn('–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –∑–≤–æ–Ω–∫–æ–≤:', error);
            });

            callListeners.set('main', unsubscribe);
            return unsubscribe;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª—É—à–∞—Ç–µ–ª—è –∑–≤–æ–Ω–∫–æ–≤:', error);
        }
    }

    function showIncomingCallNotification(callData) {
        const notificationElement = document.getElementById('callNotification');
        if (!notificationElement) return;
        
        document.getElementById('callerName').textContent = callData.senderName;
        
        if (callData.callType === 'video') {
            document.getElementById('callNotificationIcon').textContent = 'üìπ –í—Ö–æ–¥—è—â–∏–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫';
            document.getElementById('callTypeText').textContent = '–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫';
            notificationElement.classList.add('video');
        } else {
            document.getElementById('callNotificationIcon').textContent = 'üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫';
            document.getElementById('callTypeText').textContent = '–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫';
            notificationElement.classList.remove('video');
        }
        
        notificationElement.classList.remove('hidden');
        
        playRingtone();
        
        setTimeout(() => {
            if (notificationElement && !notificationElement.classList.contains('hidden')) {
                notificationElement.classList.add('hidden');
                stopRingtone();
                if (incomingCallData) {
                    rejectCall(incomingCallData);
                }
            }
        }, 30000);
    }

    function playRingtone() {
        const ringtone = document.getElementById('ringtone');
        ringtone.volume = 0.3;
        ringtone.currentTime = 0;
        ringtone.play().catch(e => {
            console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ä–∏–Ω–≥—Ç–æ–Ω–∞:', e);
            const callerName = document.getElementById('callerName')?.textContent || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–±–æ–Ω–µ–Ω—Ç';
            showPushNotification('–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫', callerName + ' –∑–≤–æ–Ω–∏—Ç –≤–∞–º');
        });
    }

    function stopRingtone() {
        const ringtone = document.getElementById('ringtone');
        ringtone.pause();
        ringtone.currentTime = 0;
    }

    // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ó–ê–ì–†–£–ó–ö–ò –§–ê–ô–õ–û–í ====================
    function createUploadProgress(fileId, fileName, fileSize) {
        const progressContainer = document.createElement('div');
        progressContainer.className = 'upload-progress-container';
        progressContainer.id = `upload-progress-${fileId}`;
        
        const progressBar = document.createElement('div');
        progressBar.className = 'upload-progress-bar';
        
        const progress = document.createElement('div');
        progress.className = 'upload-progress';
        progress.appendChild(progressBar);
        
        const progressText = document.createElement('div');
        progressText.className = 'upload-progress-text';
        progressText.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: 0%`;
        
        progressContainer.appendChild(progress);
        progressContainer.appendChild(progressText);
        
        return {
            container: progressContainer,
            progressBar: progressBar,
            text: progressText
        };
    }

    async function uploadFileWithProgress(file, messageElementId = null) {
        const fileId = 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const chunkSize = 1 * 1024 * 1024; // 1MB —á–∞–Ω–∫–∏
        const totalChunks = Math.ceil(file.size / chunkSize);
        let uploadedChunks = 0;
        
        let progressUI = null;
        if (messageElementId) {
            const messageElement = document.getElementById(messageElementId);
            if (messageElement) {
                progressUI = createUploadProgress(fileId, file.name, file.size);
                messageElement.appendChild(progressUI.container);
            }
        }
        
        if (file.size > 1 * 1024 * 1024) { // –î–ª—è —Ñ–∞–π–ª–æ–≤ –±–æ–ª—å—à–µ 1MB
            showNotification(`–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞ ${file.name} (${formatFileSize(file.size)})`, 'info');
            
            const chunks = [];
            for (let start = 0; start < file.size; start += chunkSize) {
                const chunk = file.slice(start, start + chunkSize);
                chunks.push(chunk);
            }
            
            const uploadedData = [];
            
            for (let i = 0; i < chunks.length; i++) {
                const chunk = chunks[i];
                const chunkReader = new FileReader();
                
                await new Promise((resolve, reject) => {
                    chunkReader.onload = async (event) => {
                        try {
                            uploadedData.push(event.target.result);
                            uploadedChunks++;
                            
                            const progressPercent = Math.floor((uploadedChunks / totalChunks) * 100);
                            if (progressUI) {
                                progressUI.progressBar.style.width = `${progressPercent}%`;
                                progressUI.text.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${progressPercent}%`;
                            }
                            
                            setTimeout(resolve, 100);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    chunkReader.onerror = reject;
                    chunkReader.readAsDataURL(chunk);
                });
            }
            
            const completeFile = new Blob(chunks, { type: file.type });
            return await readFileAsBase64(completeFile);
        } else {
            return await readFileAsBase64(file);
        }
    }

    // ==================== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
    function initEventListeners() {
        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('registerBtn').addEventListener('click', register);
        document.getElementById('showRegisterBtn').addEventListener('click', showRegister);
        document.getElementById('showLoginBtn').addEventListener('click', showLogin);

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        document.getElementById('profileBtn').addEventListener('click', showProfile);
        document.getElementById('newChatBtn').addEventListener('click', showNewChatModal);
        document.getElementById('backToChatsBtn').addEventListener('click', backToChats);
        document.getElementById('backToChatsBtn2').addEventListener('click', backToChats);
        document.getElementById('backFromUserProfileBtn').addEventListener('click', () => {
            showScreen('chatScreen');
        });

        // –ü–æ–∏—Å–∫
        document.getElementById('searchUsersInput').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            searchTimeout = setTimeout(() => {
                searchUsers(query);
            }, 300);
        });

        document.getElementById('singleSearchInput').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            searchTimeout = setTimeout(() => {
                searchUsersForChat(query, 'single');
            }, 300);
        });

        document.getElementById('groupSearchInput').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            searchTimeout = setTimeout(() => {
                searchUsersForChat(query, 'group');
            }, 300);
        });

        // –°–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        document.getElementById('attachBtn').addEventListener('click', () => {
            document.getElementById('fileUpload').click();
        });

        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            
            const sendBtn = document.getElementById('sendMessageBtn');
            sendBtn.disabled = this.value.trim() === '';
            
            if (currentChat && !currentChat.isGroup && !currentChat.isChannel && !authError) {
                if (typingTimeouts.has('current')) {
                    clearTimeout(typingTimeouts.get('current'));
                }
                
                updateTypingStatus(this.value.trim() !== '');
                
                const timeout = setTimeout(() => {
                    updateTypingStatus(false);
                }, 3000);
                typingTimeouts.set('current', timeout);
            }
        });

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
                
                if (currentChat && !currentChat.isGroup && !currentChat.isChannel && !authError) {
                    updateTypingStatus(false);
                }
            }
        });

        // –í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('videoMessageBtn').addEventListener('click', startVideoRecording);
        document.getElementById('recordStartBtn').addEventListener('click', startRecordingVideo);
        document.getElementById('recordStopBtn').addEventListener('click', stopRecordingVideo);
        document.getElementById('cameraSwitchBtn').addEventListener('click', switchCamera);
        document.getElementById('cancelVideoRecordingBtn').addEventListener('click', closeVideoRecordingModal);
        document.getElementById('sendVideoMessageBtn').addEventListener('click', sendVideoMessage);

        // –ü—Ä–æ—Ñ–∏–ª—å
        document.getElementById('editNameBtn').addEventListener('click', editName);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('showAvatarModalBtn').addEventListener('click', showAvatarModal);

        // –ê–≤–∞—Ç–∞—Ä–∫–∞
        document.getElementById('avatarUpload').addEventListener('change', function(e) {
            handleAvatarUpload(e.target.files[0]);
        });

        // –§–∞–π–ª—ã
        document.getElementById('fileUpload').addEventListener('change', function(e) {
            handleFileUpload(e.target.files);
        });

        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        document.getElementById('cancelAvatarBtn').addEventListener('click', closeAvatarModal);
        document.getElementById('saveAvatarBtn').addEventListener('click', saveAvatar);
        document.getElementById('uploadAvatarBtn').addEventListener('click', () => {
            document.getElementById('avatarUpload').click();
        });

        document.querySelectorAll('.avatar-option').forEach(option => {
            option.addEventListener('click', function() {
                selectAvatar(this.dataset.color);
            });
        });

        // –ì—Ä—É–ø–ø—ã
        document.getElementById('createGroupBtn').addEventListener('click', createGroup);
        document.getElementById('createChannelBtn').addEventListener('click', createChannel);
        document.getElementById('cancelGroupBtn').addEventListener('click', closeGroupModal);
        document.getElementById('groupInfoBtn').addEventListener('click', showGroupInfo);
        document.getElementById('channelInfoBtn').addEventListener('click', showChannelInfo);
        document.getElementById('closeGroupInfoBtn').addEventListener('click', closeGroupInfoModal);
        document.getElementById('closeChannelInfoBtn').addEventListener('click', closeChannelInfoModal);

        document.querySelectorAll('.modal-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabType = this.dataset.tab;
                switchTab(tabType);
            });
        });

        // –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        const voiceBtn = document.getElementById('voiceBtn');
        voiceBtn.addEventListener('mousedown', startVoiceRecording);
        voiceBtn.addEventListener('touchstart', startVoiceRecording);
        voiceBtn.addEventListener('mouseup', stopVoiceRecording);
        voiceBtn.addEventListener('touchend', stopVoiceRecording);
        voiceBtn.addEventListener('mouseleave', stopVoiceRecording);

        document.getElementById('disableCallBtn').addEventListener('click', toggleCallsDisabled);

        // –ó–≤–æ–Ω–∫–∏
        document.getElementById('callBtn').addEventListener('click', () => {
            if (isCallDisabled) {
                showNotification('–ó–≤–æ–Ω–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã. –í–∫–ª—é—á–∏—Ç–µ –∏—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.', 'warning');
                return;
            }
            showCallTypeModal();
        });

        document.getElementById('videoCallBtn').addEventListener('click', () => {
            if (isCallDisabled) {
                showNotification('–ó–≤–æ–Ω–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã. –í–∫–ª—é—á–∏—Ç–µ –∏—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.', 'warning');
                return;
            }
            selectedCallType = 'video';
            showCallTypeModal();
        });

        document.querySelectorAll('.call-type-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.call-type-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                selectedCallType = this.dataset.type;
            });
        });

        document.getElementById('startCallWithTypeBtn').addEventListener('click', async () => {
            if (!currentChat || currentChat.isGroup || currentChat.isChannel) {
                showNotification('–ó–≤–æ–Ω–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö', 'error');
                return;
            }

            document.getElementById('callTypeModal').classList.add('hidden');
            await startCall();
        });

        document.getElementById('cancelCallTypeBtn').addEventListener('click', () => {
            document.getElementById('callTypeModal').classList.add('hidden');
        });

        document.getElementById('acceptCallBtn').addEventListener('click', async () => {
            if (incomingCallData) {
                await answerCall(incomingCallData);
                stopRingtone();
            }
        });

        document.getElementById('rejectCallBtn').addEventListener('click', async () => {
            if (incomingCallData) {
                await rejectCall(incomingCallData);
                stopRingtone();
            }
        });

        document.getElementById('endCallActiveBtnVideo').addEventListener('click', endCall);
        document.getElementById('endCallActiveBtnAudio').addEventListener('click', endCall);

        document.addEventListener('click', async function(e) {
            if (e.target.classList.contains('join-call-message-btn') || 
                e.target.closest('.join-call-message-btn')) {
                const btn = e.target.classList.contains('join-call-message-btn') ? 
                    e.target : e.target.closest('.join-call-message-btn');
                const callId = btn.dataset.callId;
                
                if (callId && !activeCall) {
                    await joinExistingCall(callId);
                }
            }
        });

        document.getElementById('contactOptionsBtn').addEventListener('click', function(e) {
            showContextMenu(e);
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#contextMenu') && !e.target.closest('#contactOptionsBtn')) {
                document.getElementById('contextMenu').classList.add('hidden');
            }
        });

        document.getElementById('viewProfileBtn').addEventListener('click', viewUserProfile);
        document.getElementById('editNicknameBtn').addEventListener('click', editContactNickname);
        document.getElementById('clearChatBtn').addEventListener('click', clearChat);
        document.getElementById('deleteChatBtn').addEventListener('click', deleteChat);

        document.getElementById('allowNotificationsBtn').addEventListener('click', async () => {
            const permission = await Notification.requestPermission();
            
            if (permission === "granted") {
                setupMessageNotifications();
                setupCallListeners();
                showPushNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã', '–¢–µ–ø–µ—Ä—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏ –∑–≤–æ–Ω–∫–∞—Ö');
            }
            
            document.getElementById('notificationPermission').classList.add('hidden');
        });

        document.getElementById('laterNotificationsBtn').addEventListener('click', () => {
            document.getElementById('notificationPermission').classList.add('hidden');
            setTimeout(() => {
                notificationPermissionAsked = false;
            }, 24 * 60 * 60 * 1000);
        });

        document.getElementById('closeImagePreviewBtn').addEventListener('click', () => {
            document.getElementById('imagePreviewModal').classList.add('hidden');
        });

        document.getElementById('closeVideoPreviewBtn').addEventListener('click', () => {
            const video = document.getElementById('previewedVideo');
            video.pause();
            document.getElementById('videoPreviewModal').classList.add('hidden');
        });

        document.getElementById('closeVideoMessagePreviewBtn').addEventListener('click', () => {
            const video = document.getElementById('videoMessagePreview');
            video.pause();
            document.getElementById('videoMessagePreviewModal').classList.add('hidden');
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.add('hidden');
            }
        });

        // –ù–û–í–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò: –ø–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
        const searchInput = document.getElementById('searchMessagesInput');
        searchInput.addEventListener('input', (e) => {
            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchMessages(e.target.value);
            }, 500);
        });
        document.getElementById('prevSearchBtn').addEventListener('click', prevSearchResult);
        document.getElementById('nextSearchBtn').addEventListener('click', nextSearchResult);

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª—ã
        document.getElementById('channelSubscribeBtn')?.addEventListener('click', async () => {
            const channelId = currentChat?.id;
            if (channelId) await subscribeToChannel(channelId);
        });
        document.getElementById('channelUnsubscribeBtn')?.addEventListener('click', async () => {
            const channelId = currentChat?.id;
            if (channelId) await unsubscribeFromChannel(channelId);
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞–º–∏
        document.getElementById('muteCallBtnVideo').addEventListener('click', toggleMute);
        document.getElementById('muteCallBtnAudio').addEventListener('click', toggleMute);
        document.getElementById('speakerCallBtnVideo').addEventListener('click', toggleSpeaker);
        document.getElementById('speakerCallBtnAudio').addEventListener('click', toggleSpeaker);
        document.getElementById('videoToggleBtn').addEventListener('click', toggleVideo);
    }

    function toggleMute() {
        if (!localStream) return;
        
        isMuted = !isMuted;
        const audioTracks = localStream.getAudioTracks();
        
        audioTracks.forEach(track => {
            track.enabled = !isMuted;
        });
        
        const muteBtn = document.querySelector('.mute-call-btn');
        if (isMuted) {
            muteBtn.innerHTML = 'üîá';
            muteBtn.style.background = 'linear-gradient(135deg, #F44336 0%, #D32F2F 100%)';
        } else {
            muteBtn.innerHTML = 'üé§';
            muteBtn.style.background = 'linear-gradient(135deg, #666 0%, #444 100%)';
        }
    }

    function toggleSpeaker() {
        isSpeakerOn = !isSpeakerOn;
        
        const speakerBtn = document.querySelectorAll('.speaker-call-btn');
        speakerBtn.forEach(btn => {
            if (isSpeakerOn) {
                btn.innerHTML = 'üîä';
                btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #388E3C 100%)';
            } else {
                btn.innerHTML = 'üîà';
                btn.style.background = 'linear-gradient(135deg, #666 0%, #444 100%)';
            }
        });
        
        showNotification(isSpeakerOn ? '–í–∫–ª—é—á–µ–Ω–∞ –≥—Ä–æ–º–∫–∞—è —Å–≤—è–∑—å' : '–í—ã–∫–ª—é—á–µ–Ω–∞ –≥—Ä–æ–º–∫–∞—è —Å–≤—è–∑—å', 'info');
    }

    function toggleVideo() {
        if (!localStream) return;
        
        isVideoOn = !isVideoOn;
        const videoTracks = localStream.getVideoTracks();
        
        videoTracks.forEach(track => {
            track.enabled = isVideoOn;
        });
        
        const videoBtn = document.getElementById('videoToggleBtn');
        if (isVideoOn) {
            videoBtn.innerHTML = 'üìπ';
            videoBtn.style.background = 'linear-gradient(135deg, #E91E63 0%, #C2185B 100%)';
        } else {
            videoBtn.innerHTML = 'üö´';
            videoBtn.style.background = 'linear-gradient(135deg, #F44336 0%, #D32F2F 100%)';
        }
    }

    function showContextMenu(e) {
        const menu = document.getElementById('contextMenu');
        const buttonRect = e.target.getBoundingClientRect();
        const menuHeight = 200;
        const menuWidth = 250;
        
        let top = buttonRect.bottom + 5;
        let left = buttonRect.left;
        
        if (top + menuHeight > window.innerHeight) {
            top = buttonRect.top - menuHeight - 5;
        }
        
        if (left + menuWidth > window.innerWidth) {
            left = window.innerWidth - menuWidth - 10;
        }
        
        menu.style.top = top + 'px';
        menu.style.left = left + 'px';
        menu.classList.remove('hidden');
    }

    async function viewUserProfile() {
        if (!currentChat || !currentChat.otherUser) return;
        
        try {
            showLoading(true);
            
            const userDoc = await getDoc(doc(db, 'users', currentChat.otherUser.id));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                viewedUserProfile = {
                    id: currentChat.otherUser.id,
                    ...userData
                };
                
                const container = document.getElementById('userProfileContent');
                const displayName = getUserDisplayName(viewedUserProfile);
                const lastActive = userData.lastActive ? 
                    (userData.lastActive.toDate ? userData.lastActive.toDate() : new Date(userData.lastActive)) : 
                    new Date(0);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
                
                let statusHTML = '';
                if (diffMinutes < 2) {
                    statusHTML = '<span class="user-status real-online">üü¢ online</span>';
                } else if (diffMinutes < 5) {
                    statusHTML = '<span class="user-status recently-active">üü° –±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ</span>';
                } else {
                    statusHTML = `<span class="user-status real-offline">‚ö´ –±—ã–ª(–∞) ${formatLastSeen(lastActive)}</span>`;
                }
                
                container.innerHTML = `
                    <div class="profile-header">
                        <div class="profile-avatar-container">
                            <div class="profile-avatar" style="background: ${userData.avatarColor || getRandomColor()}; 
                                 ${userData.avatar ? `background-image: url('${userData.avatar}')` : ''}">
                                ${userData.avatar ? '' : (userData.name || '?').charAt(0).toUpperCase()}
                            </div>
                        </div>
                        <div class="profile-name">${displayName}</div>
                        <div class="profile-username">@${userData.username}</div>
                        <div class="profile-status">
                            ${statusHTML}
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                        <div class="info-item">
                            <div class="info-label">–ò–º—è</div>
                            <div class="info-value">${userData.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">–ù–∏–∫–Ω–µ–π–º</div>
                            <div class="info-value">@${userData.username}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                            <div class="info-value">${viewedUserProfile.id.substring(0, 8)}...</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
                            <div class="info-value">${formatDate(userData.createdAt)}</div>
                        </div>
                    </div>
                    
                    <button class="btn" style="width: 100%; margin-top: 20px;" id="changeNicknameBtn">
                        ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è –¥–ª—è —Å–µ–±—è
                    </button>
                `;
                
                document.getElementById('changeNicknameBtn').addEventListener('click', () => {
                    editContactNickname();
                });
                
                showScreen('userProfileScreen');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è', 'error');
        } finally {
            showLoading(false);
        }
    }

    function editContactNickname() {
        if (!currentChat || !currentChat.otherUser) return;
        
        document.getElementById('contextMenu').classList.add('hidden');
        
        const currentNickname = getUserDisplayName(currentChat.otherUser);
        const newNickname = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞—Å):', currentNickname);
        
        if (newNickname === null) return;
        
        if (newNickname.trim() === '') {
            saveUserNickname(currentChat.otherUser.id, null);
            showNotification('–ò–º—è —É–¥–∞–ª–µ–Ω–æ, –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è', 'info');
        } else {
            saveUserNickname(currentChat.otherUser.id, newNickname.trim());
            showNotification('–ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ', 'success');
        }
        
        if (currentChat) {
            document.getElementById('chatTitle').textContent = getUserDisplayName(currentChat.otherUser);
        }
        
        if (viewedUserProfile) {
            viewUserProfile();
        }
        
        loadChats();
    }

    async function clearChat() {
        document.getElementById('contextMenu').classList.add('hidden');
        
        if (!currentChat || !confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
        
        try {
            showLoading(true);
            
            const messagesQuery = query(
                collection(db, 'messages'),
                where('chatId', '==', currentChat.id)
            );
            
            const snapshot = await getDocs(messagesQuery);
            const deletePromises = [];
            
            snapshot.forEach(doc => {
                deletePromises.push(deleteDoc(doc.ref));
            });
            
            await Promise.all(deletePromises);
            
            await updateDoc(doc(db, 'chats', currentChat.id), {
                lastMessage: '–ß–∞—Ç –æ—á–∏—â–µ–Ω',
                updatedAt: serverTimestamp()
            });
            
            showNotification('–ß–∞—Ç –æ—á–∏—â–µ–Ω', 'success');
            
            loadMessages(currentChat.id);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞', 'error');
        } finally {
            showLoading(false);
        }
    }

    async function deleteChat() {
        document.getElementById('contextMenu').classList.add('hidden');
        
        if (!currentChat || !confirm('–£–¥–∞–ª–∏—Ç—å —á–∞—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
        
        try {
            showLoading(true);
            
            const messagesQuery = query(
                collection(db, 'messages'),
                where('chatId', '==', currentChat.id)
            );
            
            const snapshot = await getDocs(messagesQuery);
            const deletePromises = [];
            
            snapshot.forEach(doc => {
                deletePromises.push(deleteDoc(doc.ref));
            });
            
            deletePromises.push(deleteDoc(doc(db, 'chats', currentChat.id)));
            
            await Promise.all(deletePromises);
            
            showNotification('–ß–∞—Ç —É–¥–∞–ª–µ–Ω', 'success');
            
            backToChats();
            loadChats();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞', 'error');
        } finally {
            showLoading(false);
        }
    }

    async function joinExistingCall(callId) {
        if (!callId) {
            showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π ID –∑–≤–æ–Ω–∫–∞', 'error');
            return;
        }
        
        if (activeCall) {
            showNotification('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫', 'warning');
            return;
        }
        
        try {
            showLoading(true);
            
            const callsQuery = query(
                collection(db, 'messages'),
                where('callId', '==', callId),
                where('type', '==', 'call'),
                limit(1)
            );
            
            const snapshot = await getDocs(callsQuery);
            if (snapshot.empty) {
                throw new Error('–ó–≤–æ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            const callDoc = snapshot.docs[0];
            const callData = { id: callDoc.id, ...callDoc.data() };
            
            if (!callData.callActive) {
                throw new Error('–≠—Ç–æ—Ç –∑–≤–æ–Ω–æ–∫ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω');
            }
            
            if (callData.senderId === currentUser.id) {
                showNotification('–≠—Ç–æ –≤–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫', 'info');
                return;
            }
            
            const constraints = callData.callType === 'video' 
                ? { audio: true, video: true } 
                : { audio: true };
            
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            
            if (callData.callType === 'video') {
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
                document.getElementById('videoContainer').style.display = 'block';
                document.getElementById('audioCallContainer').style.display = 'none';
            } else {
                document.getElementById('videoContainer').style.display = 'none';
                document.getElementById('audioCallContainer').style.display = 'block';
            }
            
            currentCallId = callId;
            
            activeCall = {
                id: callId,
                chatId: callData.chatId,
                userId: callData.senderId,
                userName: callData.senderName,
                isIncoming: true,
                callType: callData.callType,
                startTime: new Date(),
                messageId: callData.id,
                stream: localStream
            };
            
            setupPeerConnection(false);
            
            showActiveCallScreen(activeCall);
            startCallTimer();
            
            await updateDoc(doc(db, 'messages', callData.id), {
                answered: true,
                answeredAt: serverTimestamp(),
                callActive: true
            });
            
            showNotification('–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∑–≤–æ–Ω–∫—É', 'success');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∑–≤–æ–Ω–∫—É:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∑–≤–æ–Ω–∫—É: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    async function getUserById(userId) {
        try {
            const userDoc = await getDoc(doc(db, 'users', userId));
            if (userDoc.exists()) {
                return { id: userId, ...userDoc.data() };
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        }
        return { id: userId, name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π' };
    }

    function switchTab(tabType) {
        document.querySelectorAll('.modal-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.modal-tab[data-tab="${tabType}"]`).classList.add('active');

        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabType + 'Tab').classList.add('active');

        if (tabType === 'group') {
            groupMembers.clear();
            updateGroupMembersList();
        }
    }

    async function loadAllUsersForSearch() {
        if (!currentUser) return;
        
        try {
            console.log("üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–æ–∏—Å–∫–∞...");
            const usersRef = collection(db, 'users');
            const snapshot = await getDocs(usersRef);
            
            allUsersCache.clear();
            snapshot.forEach(doc => {
                if (doc.id !== currentUser.id) {
                    const userData = doc.data();
                    allUsersCache.set(doc.id, {
                        id: doc.id,
                        ...userData
                    });
                    
                    allUsers.set(doc.id, {
                        id: doc.id,
                        ...userData
                    });
                }
            });
            
            console.log("‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–æ–∏—Å–∫–∞:", allUsersCache.size);
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        }
    }

    function showRegister() {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('registerForm').classList.remove('hidden');
    }

    function showLogin() {
        document.getElementById('registerForm').classList.add('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
    }

    async function login() {
        const username = document.getElementById('loginUsername').value.trim().toLowerCase();
        const password = document.getElementById('loginPassword').value;
        
        if (!username || !password) {
            showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
            return;
        }

        const btn = document.getElementById('loginBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<div class="loading"></div>';
        btn.disabled = true;

        try {
            console.log("üîë –ü—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏:", username);
            
            const usersQuery = query(collection(db, 'users'), where('username', '==', username));
            const querySnapshot = await getDocs(usersQuery);
            
            if (querySnapshot.empty) {
                throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            const userDoc = querySnapshot.docs[0];
            const userData = userDoc.data();
            const userEmail = userData.email;
            
            await signInWithEmailAndPassword(auth, userEmail, password);
            console.log("‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω");
            
            localStorage.setItem('absgram_user', JSON.stringify({
                username: username,
                timestamp: Date.now()
            }));
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
            let message = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
            switch (error.code) {
                case 'auth/user-not-found':
                    message = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
                    break;
                case 'auth/wrong-password':
                    message = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                    break;
                case 'auth/invalid-email':
                    message = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç';
                    break;
                default:
                    if (error.message.includes('–Ω–µ –Ω–∞–π–¥–µ–Ω')) {
                        message = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
                    }
            }
            showNotification(message, 'error');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function register() {
        const name = document.getElementById('registerName').value.trim();
        const username = document.getElementById('registerUsername').value.trim().toLowerCase();
        const password = document.getElementById('registerPassword').value;
        
        if (!name || !username || !password) {
            showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
            return;
        }

        if (password.length < 6) {
            showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
            return;
        }

        if (!/^[a-z0-9_]+$/.test(username)) {
            showNotification('–ù–∏–∫–Ω–µ–π–º –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –Ω–∏–∂–Ω–µ–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ', 'error');
            return;
        }

        const btn = document.getElementById('registerBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<div class="loading"></div>';
        btn.disabled = true;

        try {
            console.log("üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", username);
            
            const usersQuery = query(collection(db, 'users'), where('username', '==', username));
            const querySnapshot = await getDocs(usersQuery);
            
            if (!querySnapshot.empty) {
                throw new Error('–≠—Ç–æ—Ç –Ω–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç');
            }
            
            const email = `${username}@absgram.com`;
            
            console.log("üîê –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firebase Auth...");
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            console.log("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω –≤ Auth:", user.uid);
            
            if (!auth.currentUser || auth.currentUser.uid !== user.uid) {
                console.log("üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –ø—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏...");
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (loginError) {
                    console.log("‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Ö–æ–¥–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º:", loginError);
                }
            }
            
            console.log("üíæ –°–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –≤ Firestore...");
            const userData = {
                name: name,
                username: username,
                email: email,
                avatar: null,
                avatarColor: getRandomColor(),
                isOnline: true,
                lastActive: serverTimestamp(),
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                searchName: name.toLowerCase(),
                searchUsername: username.toLowerCase()
            };
            
            console.log("üìù –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", userData);
            
            if (!auth.currentUser) {
                console.log("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, —Å–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç —Å UID:", user.uid);
                await setDoc(doc(db, 'users', user.uid), userData);
            } else {
                await setDoc(doc(db, 'users', auth.currentUser.uid), userData);
            }
            
            console.log("‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–∑–¥–∞–Ω –≤ Firestore");
            
            currentUser = {
                id: auth.currentUser ? auth.currentUser.uid : user.uid,
                ...userData
            };
            
            localStorage.setItem('absgram_user', JSON.stringify({
                username: username,
                timestamp: Date.now()
            }));
            
            updateProfile();
            showScreen('chatsScreen');
            
            await loadChats();
            await loadAllUsersForSearch();
            loadAllNicknames();
            setupOnlineStatusListener();
            requestNotificationPermission();
            setupCallListeners();
            updateUnreadCounts();
            
            btn.innerHTML = originalText;
            btn.disabled = false;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
            
            let message = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
            
            if (error.message.includes('—É–∂–µ –∑–∞–Ω—è—Ç')) {
                message = '–≠—Ç–æ—Ç –Ω–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç';
            } else if (error.code === 'auth/weak-password') {
                message = '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.';
            } else if (error.code === 'auth/email-already-in-use') {
                message = '–≠—Ç–æ—Ç email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
            } else if (error.code === 'permission-denied') {
                message = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Firestore. –û–ë–ù–û–í–ò–¢–ï –ü–†–ê–í–ò–õ–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò!';
            } else if (error.message.includes('–Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω')) {
                message = '–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
            } else {
                message = `–û—à–∏–±–∫–∞: ${error.message}`;
            }
            
            showNotification(message, 'error');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function loadUserData(userId) {
        try {
            console.log("üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Firestore:", userId);
            
            if (authError) {
                const savedUser = localStorage.getItem('absgram_user_local');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage:", currentUser);
                    updateProfile();
                }
                return;
            }
            
            const userDoc = await getDoc(doc(db, 'users', userId));
            
            if (userDoc.exists()) {
                const userData = userDoc.data();
                currentUser = {
                    id: userId,
                    ...userData
                };
                
                const lastActive = userData.lastActive ? 
                    (userData.lastActive.toDate ? userData.lastActive.toDate() : new Date(userData.lastActive)) : 
                    new Date(0);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
                
                currentUser.realIsOnline = diffMinutes < 2;
                
                console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", currentUser);
                updateProfile();
                
                try {
                    await updateDoc(doc(db, 'users', userId), {
                        isOnline: true,
                        lastActive: serverTimestamp()
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–ª–∞–π–Ω:', error);
                }
            } else {
                console.error("‚ùå –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Firestore!");
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                await signOut(auth);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        }
    }

    function updateProfile() {
        if (!currentUser) return;
        
        console.log("üë§ –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å:", currentUser.name);
        document.getElementById('profileName').textContent = currentUser.name;
        document.getElementById('profileUsername').textContent = '@' + currentUser.username;
        document.getElementById('profileUsernameValue').textContent = '@' + currentUser.username;
        document.getElementById('profileId').textContent = currentUser.id.substring(0, 8) + '...';
        document.getElementById('profileDate').textContent = formatDate(currentUser.createdAt);
        
        const avatar = document.getElementById('profileAvatar');
        if (currentUser.avatar) {
            avatar.style.backgroundImage = `url('${currentUser.avatar}')`;
            avatar.textContent = '';
            avatar.style.backgroundColor = '';
        } else {
            avatar.style.backgroundImage = '';
            avatar.textContent = currentUser.name.charAt(0).toUpperCase();
            avatar.style.backgroundColor = currentUser.avatarColor || getRandomColor();
        }
        
        loadUserChatsCount();
    }

    async function loadUserChatsCount() {
        if (!currentUser) return;
        
        try {
            const chatsQuery = query(
                collection(db, 'chats'),
                where('participants', 'array-contains', currentUser.id)
            );
            const chatsSnapshot = await getDocs(chatsQuery);
            document.getElementById('profileChatsCount').textContent = chatsSnapshot.size;
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–∞—Ç–æ–≤:', error);
            document.getElementById('profileChatsCount').textContent = '0';
        }
    }

    async function editName() {
        const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:', currentUser.name);
        if (!newName || newName.trim() === '' || newName === currentUser.name) return;
        
        const name = newName.trim();
        
        showLoading(true);
        try {
            if (!authError) {
                await updateDoc(doc(db, 'users', currentUser.id), {
                    name: name,
                    searchName: name.toLowerCase(),
                    updatedAt: serverTimestamp()
                });
            }
            
            currentUser.name = name;
            currentUser.searchName = name.toLowerCase();
            
            if (authError) {
                localStorage.setItem('absgram_user_local', JSON.stringify(currentUser));
            }
            
            updateProfile();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏:', error);
            showNotification('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏', 'error');
        } finally {
            showLoading(false);
        }
    }

    function logout() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            if (currentUser && !authError) {
                try {
                    updateDoc(doc(db, 'users', currentUser.id), {
                        isOnline: false,
                        lastActive: serverTimestamp()
                    }).catch(console.error);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
                }
            }
            
            if (unsubscribeChats) unsubscribeChats();
            if (unsubscribeMessages) unsubscribeMessages();
            if (callListeners.size > 0) {
                callListeners.forEach(unsubscribe => unsubscribe());
                callListeners.clear();
            }
            if (onlineStatusInterval) {
                clearInterval(onlineStatusInterval);
                onlineStatusInterval = null;
            }
            if (typingListeners.size > 0) {
                typingListeners.forEach(unsubscribe => unsubscribe());
                typingListeners.clear();
            }
            if (callRingingListeners.size > 0) {
                callRingingListeners.forEach(unsubscribe => unsubscribe());
                callRingingListeners.clear();
            }
            
            signOut(auth).then(() => {
                currentUser = null;
                currentChat = null;
                allUsers.clear();
                allUsersCache.clear();
                userNicknames.clear();
                authError = false;
                localStorage.removeItem('absgram_user_local');
                showScreen('authScreen');
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞', 'error');
            });
        }
    }

    function backToChats() {
        if (unsubscribeMessages) {
            unsubscribeMessages();
            unsubscribeMessages = null;
        }
        
        if (typingListeners.has('current')) {
            clearTimeout(typingListeners.get('current'));
            typingListeners.delete('current');
            updateTypingStatus(false);
        }
        
        document.getElementById('messageInput').value = '';
        document.getElementById('messageInput').style.height = 'auto';
        document.getElementById('sendMessageBtn').disabled = true;
        showScreen('chatsScreen');
        
        updateUnreadCounts();
    }

    function showProfile() {
        updateProfile();
        showScreen('profileScreen');
    }

    function showNewChatModal() {
        groupMembers.clear();
        updateGroupMembersList();
        
        document.getElementById('newChatModal').classList.remove('hidden');
        switchTab('single');
        
        document.getElementById('singleSearchInput').focus();
    }

    function closeGroupModal() {
        document.getElementById('newChatModal').classList.add('hidden');
        document.getElementById('groupName').value = '';
        document.getElementById('channelName').value = '';
        document.getElementById('channelDescription').value = '';
        document.getElementById('groupSearchInput').value = '';
        document.getElementById('singleSearchInput').value = '';
        groupMembers.clear();
        document.getElementById('singleSearchResults').innerHTML = '';
        document.getElementById('groupSearchResults').innerHTML = '';
    }

    async function searchUsers(searchQuery) {
        if (!currentUser || !searchQuery.trim()) {
            const searchHint = document.querySelector('.search-hint');
            if (searchHint) searchHint.style.display = 'block';
            return;
        }
        
        console.log("üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", searchQuery);
        const searchHint = document.querySelector('.search-hint');
        if (searchHint) searchHint.style.display = 'none';
        
        if (authError) {
            const localUsers = JSON.parse(localStorage.getItem('absgram_all_users') || '[]');
            const users = localUsers.filter(user => {
                const query = searchQuery.toLowerCase();
                const userName = user.name ? user.name.toLowerCase() : '';
                const userUsername = user.username ? user.username.toLowerCase() : '';
                
                return userName.includes(query) || 
                       userUsername.includes(query);
            });
            
            renderSearchResults(users);
            return;
        }
        
        const users = Array.from(allUsersCache.values()).filter(user => {
            const query = searchQuery.toLowerCase();
            const userName = user.name ? user.name.toLowerCase() : '';
            const userUsername = user.username ? user.username.toLowerCase() : '';
            
            return userName.includes(query) || 
                   userUsername.includes(query);
        });
        
        if (users.length > 0) {
            console.log("‚úÖ –ù–∞–π–¥–µ–Ω–æ –≤ –∫—ç—à–µ:", users.length);
            renderSearchResults(users);
            return;
        }
        
        try {
            const usersRef = collection(db, 'users');
            const queryLower = searchQuery.toLowerCase();
            
            const nameQuery = query(
                usersRef,
                where('searchName', '>=', queryLower),
                where('searchName', '<=', queryLower + '\uf8ff')
            );
            
            const usernameQuery = query(
                usersRef,
                where('searchUsername', '>=', queryLower),
                where('searchUsername', '<=', queryLower + '\uf8ff')
            );
            
            const [nameSnapshot, usernameSnapshot] = await Promise.all([
                getDocs(nameQuery),
                getDocs(usernameQuery)
            ]);
            
            const foundUsers = new Map();
            
            nameSnapshot.forEach(doc => {
                if (doc.id !== currentUser.id) {
                    const userData = doc.data();
                    const lastActive = userData.lastActive ? 
                        (userData.lastActive.toDate ? userData.lastActive.toDate() : new Date(userData.lastActive)) : 
                        new Date(0);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
                    
                    foundUsers.set(doc.id, {
                        id: doc.id,
                        ...userData,
                        realIsOnline: diffMinutes < 2,
                        lastActive: userData.lastActive || null
                    });
                }
            });
            
            usernameSnapshot.forEach(doc => {
                if (doc.id !== currentUser.id) {
                    const userData = doc.data();
                    const lastActive = userData.lastActive ? 
                        (userData.lastActive.toDate ? userData.lastActive.toDate() : new Date(userData.lastActive)) : 
                        new Date(0);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
                    
                    foundUsers.set(doc.id, {
                        id: doc.id,
                        ...userData,
                        realIsOnline: diffMinutes < 2,
                        lastActive: userData.lastActive || null
                    });
                }
            });
            
            const usersArray = Array.from(foundUsers.values());
            
            if (usersArray.length > 0) {
                usersArray.forEach(user => {
                    if (!allUsersCache.has(user.id)) {
                        allUsersCache.set(user.id, user);
                    }
                });
                
                console.log("‚úÖ –ù–∞–π–¥–µ–Ω–æ –≤ Firestore:", usersArray.length);
                renderSearchResults(usersArray);
            } else {
                console.log("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
                renderSearchResults([]);
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            
            const allUsersArray = Array.from(allUsersCache.values());
            if (allUsersArray.length > 0) {
                console.log("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏:", allUsersArray.length);
                const filteredUsers = allUsersArray.filter(user => {
                    const query = searchQuery.toLowerCase();
                    const userName = user.name ? user.name.toLowerCase() : '';
                    const userUsername = user.username ? user.username.toLowerCase() : '';
                    
                    return userName.includes(query) || 
                           userUsername.includes(query);
                });
                renderSearchResults(filteredUsers);
            } else {
                renderSearchResults([]);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
            }
        }
    }

    async function searchUsersForChat(query, type) {
        if (!query.trim()) {
            if (type === 'single') {
                document.getElementById('singleSearchResults').innerHTML = '';
            } else {
                document.getElementById('groupSearchResults').innerHTML = '';
            }
            return;
        }
        
        if (authError) {
            const localUsers = JSON.parse(localStorage.getItem('absgram_all_users') || '[]');
            const users = localUsers.filter(user => {
                const searchQuery = query.toLowerCase();
                const userName = user.name ? user.name.toLowerCase() : '';
                const userUsername = user.username ? user.username.toLowerCase() : '';
                
                return userName.includes(searchQuery) || 
                       userUsername.includes(searchQuery);
            });
            
            if (type === 'single') {
                renderSingleChatResults(users);
            } else {
                renderGroupChatResults(users);
            }
            return;
        }
        
        const users = Array.from(allUsersCache.values()).filter(user => {
            const searchQuery = query.toLowerCase();
            const userName = user.name ? user.name.toLowerCase() : '';
            const userUsername = user.username ? user.username.toLowerCase() : '';
            
            return userName.includes(searchQuery) || 
                   userUsername.includes(searchQuery);
        });
        
        if (type === 'single') {
            renderSingleChatResults(users);
        } else {
            renderGroupChatResults(users);
        }
    }

    function renderSearchResults(users) {
        const container = document.getElementById('chatsList');
        
        if (users.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon">üë§</div>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    <p style="font-size: 14px; margin-top: 10px; color: var(--text-secondary);">
                        –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ
                    </p>
                    <p style="font-size: 12px; margin-top: 5px; color: var(--text-secondary);">
                        üîç –ú–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º—É
                    </p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        
        users.sort((a, b) => {
            if (a.realIsOnline && !b.realIsOnline) return -1;
            if (!a.realIsOnline && b.realIsOnline) return 1;
            
            return a.name.localeCompare(b.name);
        });
        
        users.forEach(user => {
            const div = document.createElement('div');
            div.className = 'user-item';
            div.onclick = () => createChatWithUser(user);
            
            const displayName = getUserDisplayName(user);
            const query = document.getElementById('searchUsersInput').value.trim().toLowerCase();
            let finalDisplayName = displayName;
            
            if (query && displayName.toLowerCase().includes(query)) {
                const regex = new RegExp(`(${query})`, 'gi');
                finalDisplayName = displayName.replace(regex, '<mark style="background: rgba(255,107,53,0.3); color: var(--primary); font-weight: bold; padding: 2px 0; border-radius: 3px;">$1</mark>');
            }
            
            let statusHTML = '';
            if (user.realIsOnline === true) {
                statusHTML = '<span class="user-status real-online">üü¢ online</span>';
            } else if (user.lastActive) {
                const lastActive = user.lastActive.toDate ? user.lastActive.toDate() : new Date(user.lastActive);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
                
                if (diffMinutes < 5) {
                    statusHTML = '<span class="user-status recently-active">üü° –±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ</span>';
                } else {
                    statusHTML = `<span class="user-status real-offline">‚ö´ –±—ã–ª(–∞) ${formatLastSeen(lastActive)}</span>`;
                }
            } else {
                statusHTML = '<span class="user-status real-offline">‚ö´ –Ω–µ –≤ —Å–µ—Ç–∏</span>';
            }
            
            div.innerHTML = `
                <div class="user-avatar" style="background: ${user.avatarColor || getRandomColor()}; 
                     ${user.avatar ? `background-image: url('${user.avatar}')` : ''}">
                    ${user.avatar ? '' : user.name.charAt(0).toUpperCase()}
                </div>
                <div class="user-info">
                    <div class="user-name">${finalDisplayName}</div>
                    <div class="user-username">@${user.username}</div>
                    <div class="user-status">
                        ${statusHTML}
                    </div>
                </div>
            `;
            
            container.appendChild(div);
        });
        
        const onlineCount = users.filter(u => u.realIsOnline === true).length;
        const stats = document.createElement('div');
        stats.className = 'search-hint';
        stats.innerHTML = `–ù–∞–π–¥–µ–Ω–æ: ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (${onlineCount} –æ–Ω–ª–∞–π–Ω)`;
        container.appendChild(stats);
    }

    function renderSingleChatResults(users) {
        const container = document.getElementById('singleSearchResults');
        container.innerHTML = '';
        
        if (users.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="height: 200px;">
                    <div class="icon">üë§</div>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                </div>
            `;
            return;
        }
        
        users.forEach(user => {
            const div = document.createElement('div');
            div.className = 'user-item';
            div.onclick = () => createChatWithUser(user);
            
            const displayName = getUserDisplayName(user);
            
            let statusHTML = '';
            if (user.realIsOnline === true) {
                statusHTML = '<span class="user-status real-online">üü¢ online</span>';
            } else if (user.lastActive) {
                const lastActive = user.lastActive.toDate ? user.lastActive.toDate() : new Date(user.lastActive);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
                
                if (diffMinutes < 5) {
                    statusHTML = '<span class="user-status recently-active">üü° –±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ</span>';
                } else {
                    statusHTML = `<span class="user-status real-offline">‚ö´ –±—ã–ª(–∞) ${formatLastSeen(lastActive)}</span>`;
                }
            } else {
                statusHTML = '<span class="user-status real-offline">‚ö´ –Ω–µ –≤ —Å–µ—Ç–∏</span>';
            }
            
            div.innerHTML = `
                <div class="user-avatar" style="background: ${user.avatarColor || getRandomColor()}; 
                     ${user.avatar ? `background-image: url('${user.avatar}')` : ''}">
                    ${user.avatar ? '' : user.name.charAt(0).toUpperCase()}
                </div>
                <div class="user-info">
                    <div class="user-name">${displayName}</div>
                    <div class="user-username">@${user.username}</div>
                    <div class="user-status">
                        ${statusHTML}
                    </div>
                </div>
            `;
            
            container.appendChild(div);
        });
    }

    function renderGroupChatResults(users) {
        const container = document.getElementById('groupSearchResults');
        container.innerHTML = '';
        
        if (users.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="height: 150px;">
                    <div class="icon">üë§</div>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                </div>
            `;
            return;
        }
        
        users.forEach(user => {
            if (groupMembers.has(user.id) || user.id === currentUser.id) return;
            
            const div = document.createElement('div');
            div.className = 'user-item';
            div.onclick = () => addToGroup(user);
            
            const displayName = getUserDisplayName(user);
            
            let statusHTML = '';
            if (user.realIsOnline === true) {
                statusHTML = '<span class="user-status real-online">üü¢ online</span>';
            } else if (user.lastActive) {
                const lastActive = user.lastActive.toDate ? user.lastActive.toDate() : new Date(user.lastActive);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
                
                if (diffMinutes < 5) {
                    statusHTML = '<span class="user-status recently-active">üü° –±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ</span>';
                } else {
                    statusHTML = `<span class="user-status real-offline">‚ö´ –±—ã–ª(–∞) ${formatLastSeen(lastActive)}</span>`;
                }
            } else {
                statusHTML = '<span class="user-status real-offline">‚ö´ –Ω–µ –≤ —Å–µ—Ç–∏</span>';
            }
            
            div.innerHTML = `
                <div class="user-avatar" style="background: ${user.avatarColor || getRandomColor()}; 
                     ${user.avatar ? `background-image: url('${user.avatar}')` : ''}">
                    ${user.avatar ? '' : user.name.charAt(0).toUpperCase()}
                </div>
                <div class="user-info">
                    <div class="user-name">${displayName}</div>
                    <div class="user-username">@${user.username}</div>
                    <div class="user-status">
                        ${statusHTML}
                    </div>
                </div>
            `;
            
            container.appendChild(div);
        });
    }

    async function createChatWithUser(user) {
        if (!currentUser) return;
        
        showLoading(true);
        try {
            if (authError) {
                const chats = JSON.parse(localStorage.getItem('absgram_chats') || '[]');
                const existingChat = chats.find(chat => 
                    !chat.isGroup && !chat.isChannel &&
                    chat.participants && 
                    chat.participants.includes(user.id) && 
                    chat.participants.includes(currentUser.id)
                );
                
                if (existingChat) {
                    openChat({
                        ...existingChat,
                        otherUser: user
                    });
                    showScreen('chatScreen');
                } else {
                    const chatId = 'chat_' + Date.now();
                    const chat = {
                        id: chatId,
                        participants: [currentUser.id, user.id],
                        isGroup: false,
                        isChannel: false,
                        createdAt: new Date(),
                        updatedAt: new Date(),
                        lastMessage: '',
                        unreadCount: 0
                    };
                    
                    chats.push(chat);
                    localStorage.setItem('absgram_chats', JSON.stringify(chats));
                    
                    openChat({
                        ...chat,
                        otherUser: user
                    });
                    
                    showScreen('chatScreen');
                }
                
                closeGroupModal();
                showLoading(false);
                return;
            }
            
            const chatsQuery = query(
                collection(db, 'chats'),
                where('participants', 'array-contains', currentUser.id)
            );
            
            const existingChats = await getDocs(chatsQuery);
            let existingChatId = null;
            
            existingChats.forEach(doc => {
                const chat = doc.data();
                if (chat.participants && chat.participants.includes(user.id) && !chat.isGroup && !chat.isChannel) {
                    existingChatId = doc.id;
                }
            });
            
            if (existingChatId) {
                const chatDoc = await getDoc(doc(db, 'chats', existingChatId));
                openChat({
                    id: existingChatId,
                    ...chatDoc.data(),
                    otherUser: user
                });
                showScreen('chatScreen');
            } else {
                const chatData = {
                    participants: [currentUser.id, user.id],
                    isGroup: false,
                    isChannel: false,
                    groupName: null,
                    groupAdmin: null,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    lastMessage: '',
                    unreadCount: 0
                };
                
                const chatRef = await addDoc(collection(db, 'chats'), chatData);
                
                openChat({
                    id: chatRef.id,
                    ...chatData,
                    otherUser: user
                });
                
                showScreen('chatScreen');
            }
            
            closeGroupModal();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞', 'error');
        } finally {
            showLoading(false);
        }
    }

    function showAvatarModal() {
        selectedAvatar = currentUser.avatar;
        selectedAvatarColor = currentUser.avatarColor;
        
        const preview = document.getElementById('avatarPreview');
        if (selectedAvatar) {
            preview.style.backgroundImage = `url('${selectedAvatar}')`;
            preview.textContent = '';
            preview.style.backgroundColor = '';
        } else {
            preview.style.backgroundImage = '';
            preview.textContent = currentUser.name.charAt(0).toUpperCase();
            preview.style.backgroundColor = selectedAvatarColor || getRandomColor();
        }
        
        document.getElementById('avatarModal').classList.remove('hidden');
    }

    function closeAvatarModal() {
        document.getElementById('avatarModal').classList.add('hidden');
        selectedAvatar = null;
        selectedAvatarColor = null;
        document.getElementById('avatarUpload').value = '';
    }

    function selectAvatar(color) {
        selectedAvatar = null;
        selectedAvatarColor = color;
        
        const preview = document.getElementById('avatarPreview');
        preview.style.backgroundImage = '';
        preview.textContent = currentUser.name.charAt(0).toUpperCase();
        preview.style.backgroundColor = color;
        
        document.querySelectorAll('.avatar-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        event.target.classList.add('selected');
    }

    function handleAvatarUpload(file) {
        if (!file) return;
        
        if (!file.type.match('image/(jpeg|jpg|png|gif|webp)')) {
            showNotification('–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            showNotification('–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–Ω—å—à–µ 10MB', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(event) {
            selectedAvatar = event.target.result;
            selectedAvatarColor = null;
            
            const preview = document.getElementById('avatarPreview');
            preview.style.backgroundImage = `url('${selectedAvatar}')`;
            preview.textContent = '';
            preview.style.backgroundColor = '';
        };
        reader.readAsDataURL(file);
    }

    async function saveAvatar() {
        if (!selectedAvatar && !selectedAvatarColor) {
            showNotification('–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ', 'error');
            return;
        }

        showLoading(true);
        try {
            if (!authError) {
                await updateDoc(doc(db, 'users', currentUser.id), {
                    avatar: selectedAvatar || null,
                    avatarColor: selectedAvatarColor || null,
                    updatedAt: serverTimestamp()
                });
            }
            
            currentUser.avatar = selectedAvatar;
            currentUser.avatarColor = selectedAvatarColor;
            
            if (authError) {
                localStorage.setItem('absgram_user_local', JSON.stringify(currentUser));
            }
            
            updateProfile();
            closeAvatarModal();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏', 'error');
        } finally {
            showLoading(false);
        }
    }

    function addToGroup(user) {
        if (!groupMembers.has(user.id)) {
            groupMembers.set(user.id, user);
            updateGroupMembersList();
        }
    }

    function removeFromGroup(userId) {
        groupMembers.delete(userId);
        updateGroupMembersList();
    }

    function updateGroupMembersList() {
        const container = document.getElementById('groupMembersList');
        const memberCount = document.getElementById('memberCount');
        
        container.innerHTML = '';
        
        if (groupMembers.size === 0) {
            container.innerHTML = `
                <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                    –î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ
                </div>
            `;
            memberCount.textContent = '0';
            return;
        }
        
        groupMembers.forEach(user => {
            const tag = document.createElement('div');
            tag.className = 'member-tag';
            tag.innerHTML = `
                ${getUserDisplayName(user)}
                <span class="remove" onclick="removeFromGroup('${user.id}')">√ó</span>
            `;
            container.appendChild(tag);
        });
        
        memberCount.textContent = groupMembers.size;
        document.getElementById('createGroupBtn').disabled = groupMembers.size < 2;
    }

    async function createGroup() {
        const groupName = document.getElementById('groupName').value.trim();
        
        if (!groupName) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã', 'error');
            return;
        }
        
        if (groupMembers.size < 2) {
            showNotification('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞', 'error');
            return;
        }
        
        showLoading(true);
        try {
            const participants = [currentUser.id, ...Array.from(groupMembers.keys())];
            
            if (authError) {
                const groupId = 'group_' + Date.now();
                const group = {
                    id: groupId,
                    participants: participants,
                    isGroup: true,
                    isChannel: false,
                    groupName: groupName,
                    groupAdmin: currentUser.id,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    lastMessage: '–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞',
                    unreadCount: 0
                };
                
                const chats = JSON.parse(localStorage.getItem('absgram_chats') || '[]');
                chats.push(group);
                localStorage.setItem('absgram_chats', JSON.stringify(chats));
                
                closeGroupModal();
                loadChats();
                showLoading(false);
                return;
            }
            
            const groupData = {
                participants: participants,
                isGroup: true,
                isChannel: false,
                groupName: groupName,
                groupAdmin: currentUser.id,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                lastMessage: '–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞',
                unreadCount: 0
            };
            
            console.log("–°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É —Å –¥–∞–Ω–Ω—ã–º–∏:", groupData);
            
            const groupRef = await addDoc(collection(db, 'chats'), groupData);
            console.log("–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å ID:", groupRef.id);
            
            closeGroupModal();
            loadChats();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã:', error);
            console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', error.message);
            showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    function showGroupInfo() {
        if (!currentChat || !currentChat.isGroup) return;
        
        document.getElementById('groupInfoName').textContent = currentChat.groupName;
        document.getElementById('groupInfoMembers').textContent = currentChat.participants?.length + ' —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤';
        
        const membersList = document.getElementById('groupInfoMembersList');
        membersList.innerHTML = '';
        
        loadGroupMembers().then(() => {
            document.getElementById('groupInfoModal').classList.remove('hidden');
        });
    }

    async function showChannelInfo() {
        if (!currentChat || !currentChat.isChannel) return;
        
        document.getElementById('channelInfoName').textContent = currentChat.channelName;
        document.getElementById('channelInfoDescription').textContent = currentChat.channelDesc || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
        document.getElementById('channelInfoSubscribers').innerHTML = `üë• ${currentChat.subscriberCount || 1} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤`;
        
        let postsCount = 0;
        if (!authError) {
            const postsQuery = query(
                collection(db, 'messages'),
                where('chatId', '==', currentChat.id)
            );
            const postsSnapshot = await getDocs(postsQuery);
            postsCount = postsSnapshot.size;
        } else {
            const messages = JSON.parse(localStorage.getItem('absgram_messages') || '[]');
            postsCount = messages.filter(m => m.chatId === currentChat.id).length;
        }
        document.getElementById('channelInfoPosts').innerHTML = `üìù ${postsCount} –ø–æ—Å—Ç–æ–≤`;
        
        const isOwner = currentChat.channelOwner === currentUser.id;
        const isSubscribed = currentChat.participants?.includes(currentUser.id);
        
        document.getElementById('channelAdminSection').style.display = isOwner ? 'block' : 'none';
        document.getElementById('channelSubscribeBtn').style.display = isOwner || isSubscribed ? 'none' : 'inline-block';
        document.getElementById('channelUnsubscribeBtn').style.display = isOwner || !isSubscribed ? 'none' : 'inline-block';
        
        document.getElementById('channelInfoModal').classList.remove('hidden');
    }

    function closeChannelInfoModal() {
        document.getElementById('channelInfoModal').classList.add('hidden');
    }

    async function loadGroupMembers() {
        if (!currentChat || !currentChat.participants) return;
        
        const membersList = document.getElementById('groupInfoMembersList');
        membersList.innerHTML = '';
        
        if (authError) {
            currentChat.participants.forEach(userId => {
                if (userId === currentUser.id) {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'group-member-item';
                    memberItem.innerHTML = `
                        <div class="group-member-avatar" style="background: ${currentUser.avatarColor || getRandomColor()}; 
                             ${currentUser.avatar ? `background-image: url('${currentUser.avatar}')` : ''}">
                            ${currentUser.avatar ? '' : currentUser.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="group-member-name">
                            ${currentUser.name}
                            ${userId === currentChat.groupAdmin ? '<span class="admin-badge">üëë</span>' : ''}
                        </div>
                    `;
                    membersList.appendChild(memberItem);
                } else {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'group-member-item';
                    memberItem.innerHTML = `
                        <div class="group-member-avatar" style="background: ${getRandomColor()}">
                            ?
                        </div>
                        <div class="group-member-name">
                            –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π
                        </div>
                    `;
                    membersList.appendChild(memberItem);
                }
            });
            return;
        }
        
        for (const userId of currentChat.participants) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const user = userDoc.data();
                    const isAdmin = userId === currentChat.groupAdmin;
                    
                    const memberItem = document.createElement('div');
                    memberItem.className = 'group-member-item';
                    memberItem.innerHTML = `
                        <div class="group-member-avatar" style="background: ${user.avatarColor || getRandomColor()}; 
                             ${user.avatar ? `background-image: url('${user.avatar}')` : ''}">
                            ${user.avatar ? '' : user.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="group-member-name">
                            ${getUserDisplayName(user)}
                            ${isAdmin ? '<span class="admin-badge">üëë</span>' : ''}
                        </div>
                    `;
                    
                    membersList.appendChild(memberItem);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞:', error);
            }
        }
    }

    function closeGroupInfoModal() {
        document.getElementById('groupInfoModal').classList.add('hidden');
    }

    async function loadChats() {
        if (!currentUser) return;
        
        if (unsubscribeChats) unsubscribeChats();
        
        if (authError) {
            const chats = JSON.parse(localStorage.getItem('absgram_chats') || '[]');
            const userChats = chats.filter(chat => 
                chat.participants && chat.participants.includes(currentUser.id)
            );
            
            userChats.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            
            const chatPromises = userChats.map(async (chat) => {
                await loadChatInfo(chat);
                return chat;
            });
            
            const chatsWithInfo = await Promise.all(chatPromises);
            renderChats(chatsWithInfo);
            return;
        }
        
        try {
            const chatsQuery = query(
                collection(db, 'chats'),
                where('participants', 'array-contains', currentUser.id)
            );
            
            unsubscribeChats = onSnapshot(chatsQuery, 
                async (snapshot) => {
                    const chats = [];
                    const chatPromises = [];
                    
                    snapshot.forEach(doc => {
                        const chat = {
                            id: doc.id,
                            ...doc.data()
                        };
                        chats.push(chat);
                        chatPromises.push(loadChatInfo(chat));
                    });
                    
                    await Promise.all(chatPromises);
                    chats.sort((a, b) => {
                        const dateA = a.updatedAt ? (a.updatedAt.toDate ? a.updatedAt.toDate() : new Date(a.updatedAt)) : new Date(0);
                        const dateB = b.updatedAt ? (b.updatedAt.toDate ? b.updatedAt.toDate() : new Date(b.updatedAt)) : new Date(0);
                        return dateB - dateA;
                    });
                    renderChats(chats);
                },
                (error) => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
                }
            );
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
        }
    }

    async function loadChatInfo(chat) {
        if (chat.isGroup) {
            chat.displayName = chat.groupName;
            chat.isGroupChat = true;
            return;
        }
        
        if (chat.isChannel) {
            chat.displayName = chat.channelName;
            chat.isChannel = true;
            return;
        }
        
        if (!chat.participants || chat.participants.length !== 2) return;
        
        const otherUserId = chat.participants.find(id => id !== currentUser.id);
        if (!otherUserId) return;
        
        if (authError) {
            const allUsers = JSON.parse(localStorage.getItem('absgram_all_users') || '[]');
            const otherUser = allUsers.find(u => u.id === otherUserId);
            if (otherUser) {
                chat.otherUser = otherUser;
                chat.displayName = getUserDisplayName(otherUser);
            } else {
                chat.displayName = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
            }
            return;
        }
        
        if (allUsers.has(otherUserId)) {
            chat.otherUser = allUsers.get(otherUserId);
            chat.displayName = getUserDisplayName(chat.otherUser);
            return;
        }
        
        try {
            const userDoc = await getDoc(doc(db, 'users', otherUserId));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                
                const lastActive = userData.lastActive ? 
                    (userData.lastActive.toDate ? userData.lastActive.toDate() : new Date(userData.lastActive)) : 
                    new Date(0);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
                
                chat.otherUser = {
                    id: otherUserId,
                    ...userData,
                    realIsOnline: diffMinutes < 2
                };
                allUsers.set(otherUserId, chat.otherUser);
                chat.displayName = getUserDisplayName(chat.otherUser);
                
                if (!allUsersCache.has(otherUserId)) {
                    allUsersCache.set(otherUserId, chat.otherUser);
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —á–∞—Ç–∞:', error);
        }
    }

    function renderChats(chats) {
        const container = document.getElementById('chatsList');
        
        if (!chats || chats.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon">üí¨</div>
                    <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</p>
                    <p style="font-size: 14px; margin-top: 10px; color: var(--text-secondary);">
                        –ù–∞—á–Ω–∏—Ç–µ –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ
                    </p>
                    <p style="font-size: 12px; margin-top: 5px; color: var(--text-secondary);">
                        üîç –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "+" –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –≤ –ø–æ–∏—Å–∫–µ
                    </p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        
        chats.forEach(chat => {
            const div = document.createElement('div');
            div.className = `chat-item ${chat.isGroup ? 'group-chat' : ''} ${chat.isChannel ? 'channel' : ''}`;
            div.dataset.chatId = chat.id;
            if (currentChat && currentChat.id === chat.id) {
                div.classList.add('active');
            }
            div.onclick = () => openChat(chat);
            
            const displayName = chat.displayName || (chat.isGroup ? chat.groupName : chat.isChannel ? chat.channelName : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π');
            const lastMessage = chat.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
            const lastTime = chat.updatedAt ? formatTime(chat.updatedAt) : '';
            const isGroup = chat.isGroup;
            const isChannel = chat.isChannel;
            const avatarColor = isGroup ? getRandomColor() : isChannel ? getRandomColor() : (chat.otherUser?.avatarColor || getRandomColor());
            const avatarText = isGroup ? 'üë•' : isChannel ? 'üì¢' : (chat.otherUser?.name?.charAt(0).toUpperCase() || '?');
            
            let lastMessageIcon = '';
            if (lastMessage.includes('[–§–∞–π–ª]') || lastMessage.includes('üìé')) {
                lastMessageIcon = 'üìé ';
            } else if (lastMessage.includes('[–ì–æ–ª–æ—Å–æ–≤–æ–µ]') || lastMessage.includes('üé§')) {
                lastMessageIcon = 'üé§ ';
            } else if (lastMessage.includes('[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]') || lastMessage.includes('üñºÔ∏è')) {
                lastMessageIcon = 'üñºÔ∏è ';
            } else if (lastMessage.includes('[–í–∏–¥–µ–æ]') || lastMessage.includes('üé¨')) {
                lastMessageIcon = 'üé¨ ';
            } else if (lastMessage.includes('[–ê—É–¥–∏–æ]') || lastMessage.includes('üéµ')) {
                lastMessageIcon = 'üéµ ';
            } else if (lastMessage.includes('üìû')) {
                lastMessageIcon = 'üìû ';
            }
            
            div.innerHTML = `
                <div class="chat-avatar ${isGroup ? 'group-avatar' : isChannel ? 'channel-avatar' : ''}" style="background: ${avatarColor}; 
                     ${!isGroup && !isChannel && chat.otherUser?.avatar ? `background-image: url('${chat.otherUser.avatar}')` : ''}">
                    ${(!isGroup && !isChannel && chat.otherUser?.avatar) ? '' : avatarText}
                </div>
                <div class="chat-info">
                    <div class="chat-name">${displayName} ${isGroup ? 'üë•' : ''} ${isChannel ? 'üì¢' : ''}</div>
                    <div class="chat-last">${lastMessageIcon}${lastMessage.length > 30 ? lastMessage.substring(0, 30) + '...' : lastMessage}</div>
                    ${lastTime ? `<div class="chat-time">${lastTime}</div>` : ''}
                </div>
            `;
            
            const unreadCount = unreadCounts.get(chat.id) || 0;
            if (unreadCount > 0) {
                const badge = document.createElement('div');
                badge.className = 'chat-unread-badge';
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                const infoDiv = div.querySelector('.chat-info');
                infoDiv.appendChild(badge);
            }
            
            container.appendChild(div);
        });
    }

    async function openChat(chat) {
        if (!currentUser) return;
        
        currentChat = chat;
        
        await markMessagesAsRead(chat.id);
        
        if (chat.isGroup) {
            document.getElementById('chatTitle').textContent = chat.groupName + ' üë•';
            document.getElementById('chatStatus').textContent = chat.participants?.length + ' —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤';
            document.getElementById('chatStatus').style.color = '#FFB347';
            document.getElementById('groupInfoBtn').style.display = 'block';
            document.getElementById('channelInfoBtn').style.display = 'none';
            document.getElementById('contactOptionsBtn').style.display = 'none';
            document.getElementById('callBtn').style.display = 'none';
            document.getElementById('videoCallBtn').style.display = 'none';
            document.getElementById('disableCallBtn').style.display = 'none';
            document.getElementById('videoMessageBtn').style.display = 'flex';
        } else if (chat.isChannel) {
            document.getElementById('chatTitle').textContent = chat.channelName + ' üì¢';
            document.getElementById('chatStatus').textContent = `${chat.subscriberCount || 1} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤`;
            document.getElementById('chatStatus').style.color = '#8BC34A';
            document.getElementById('groupInfoBtn').style.display = 'none';
            document.getElementById('channelInfoBtn').style.display = 'block';
            document.getElementById('contactOptionsBtn').style.display = 'none';
            document.getElementById('callBtn').style.display = 'none';
            document.getElementById('videoCallBtn').style.display = 'none';
            document.getElementById('disableCallBtn').style.display = 'none';
            document.getElementById('videoMessageBtn').style.display = chat.channelOwner === currentUser.id ? 'flex' : 'none';
        } else {
            const otherUser = chat.otherUser || {};
            const displayName = getUserDisplayName(otherUser);
            document.getElementById('chatTitle').textContent = displayName;
            
            if (otherUser.realIsOnline === true) {
                document.getElementById('chatStatus').innerHTML = '<span class="user-status real-online">üü¢ online</span>';
                document.getElementById('chatStatus').style.color = '#4CAF50';
            } else {
                document.getElementById('chatStatus').innerHTML = '<span class="user-status real-offline">‚ö´ –Ω–µ –≤ —Å–µ—Ç–∏</span>';
                document.getElementById('chatStatus').style.color = '#aaa';
            }
            
            document.getElementById('groupInfoBtn').style.display = 'none';
            document.getElementById('channelInfoBtn').style.display = 'none';
            document.getElementById('contactOptionsBtn').style.display = 'flex';
            document.getElementById('disableCallBtn').style.display = 'flex';
            document.getElementById('videoMessageBtn').style.display = 'flex';
            
            updateCallButtonsVisibility();
            
            checkActiveCallsInChat();
            
            setupChatUserStatusListener();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
            setupTypingListener(chat.id);
            setupCallRingingListener(chat.id);
        }
        
        showScreen('chatScreen');
        
        const container = document.getElementById('messagesContainer');
        container.innerHTML = '<div class="empty-state"><div class="loading"></div><p style="margin-top: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</p></div>';
        
        document.getElementById('sendMessageBtn').disabled = true;
        document.getElementById('messageInput').focus();
        
        loadMessages(chat.id);
    }

    async function checkActiveCallsInChat() {
        if (!currentChat || currentChat.isGroup || currentChat.isChannel) return;
        
        try {
            const callsQuery = query(
                collection(db, 'messages'),
                where('chatId', '==', currentChat.id),
                where('type', '==', 'call'),
                where('callActive', '==', true)
            );
            
            const snapshot = await getDocs(callsQuery);
            if (!snapshot.empty) {
                const callDoc = snapshot.docs.find(doc => doc.data().callActive === true);
                if (callDoc) {
                    const callData = callDoc.data();
                    currentCallId = callData.callId;
                    
                    if (callData.senderId !== currentUser.id && !activeCall) {
                        showNotification('–í —ç—Ç–æ–º —á–∞—Ç–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏.', 'info');
                    }
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤:', error);
        }
    }

    function loadMessages(chatId) {
        if (unsubscribeMessages) unsubscribeMessages();
        
        if (authError) {
            const messages = JSON.parse(localStorage.getItem('absgram_messages') || '[]')
                .filter(msg => msg.chatId === chatId)
                .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            
            const container = document.getElementById('messagesContainer');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üí≠</div>
                        <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</p>
                        <p style="font-size: 14px; margin-top: 10px; color: var(--text-secondary);">
                            –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        </p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            messages.forEach(msg => {
                addMessageToChat(msg);
            });
            
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
            
            return;
        }
        
        try {
            const messagesQuery = query(
                collection(db, 'messages'),
                where('chatId', '==', chatId),
                orderBy('createdAt', 'asc')
            );
            
            unsubscribeMessages = onSnapshot(messagesQuery, 
                (snapshot) => {
                    const container = document.getElementById('messagesContainer');
                    const messages = [];
                    
                    snapshot.forEach(doc => {
                        const messageData = doc.data();
                        messages.push({
                            id: doc.id,
                            ...messageData
                        });
                    });
                    
                    if (messages.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">üí≠</div>
                                <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</p>
                                <p style="font-size: 14px; margin-top: 10px; color: var(--text-secondary);">
                                    –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                </p>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = '';
                    
                    const senderPromises = messages.map(async msg => {
                        if (msg.senderId === currentUser.id) {
                            msg.senderName = currentUser.name;
                        } else if (msg.senderId === 'system') {
                            msg.senderName = 'System';
                        } else {
                            if (allUsers.has(msg.senderId)) {
                                const user = allUsers.get(msg.senderId);
                                msg.senderName = getUserDisplayName(user);
                            } else {
                                try {
                                    const userDoc = await getDoc(doc(db, 'users', msg.senderId));
                                    if (userDoc.exists()) {
                                        const userData = userDoc.data();
                                        allUsers.set(msg.senderId, userData);
                                        msg.senderName = getUserDisplayName(userData);
                                    } else {
                                        msg.senderName = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
                                    }
                                } catch (error) {
                                    msg.senderName = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
                                }
                            }
                        }
                        return msg;
                    });
                    
                    Promise.all(senderPromises).then(messagesWithSenders => {
                        messagesWithSenders.forEach(msg => {
                            addMessageToChat(msg);
                        });
                        
                        setTimeout(() => {
                            container.scrollTop = container.scrollHeight;
                        }, 100);
                    });
                    
                },
                (error) => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                    
                    const container = document.getElementById('messagesContainer');
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">‚ö†Ô∏è</div>
                            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                            <p style="font-size: 12px; margin-top: 10px; color: var(--error);">
                                –ö–æ–¥ –æ—à–∏–±–∫–∏: ${error.code || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                            </p>
                        </div>
                    `;
                }
            );
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        }
    }

    function addMessageToChat(message) {
        const container = document.getElementById('messagesContainer');
        const isOwn = message.senderId === currentUser.id;
        const isSystem = message.senderId === 'system';
        const messageId = message.id || 'msg_' + Date.now();
        
        if (document.getElementById(`message-${messageId}`)) {
            return;
        }
        
        const div = document.createElement('div');
        div.id = `message-${messageId}`;
        
        if (message.type === 'call') {
            if (isCallDisabled && !isOwn) {
                div.className = 'message call-disabled-message';
                div.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 10px;">üîï</div>
                        <div>–ó–≤–æ–Ω–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (–∑–≤–æ–Ω–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã)</div>
                        <div style="font-size: 12px; margin-top: 5px;">${message.senderName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'} –ø—ã—Ç–∞–ª—Å—è –ø–æ–∑–≤–æ–Ω–∏—Ç—å</div>
                    </div>
                `;
            } else {
                div.className = 'message call-message';
            }
        } else if (message.type === 'call_end') {
            div.className = 'message call-message';
        } else if (message.type === 'video' && message.isVideoCircle) {
            div.className = `message ${isOwn ? 'message-out' : 'message-in'} fade-in`;
            
            let content = '';
            
            if (message.fileData && message.fileData.startsWith('video_')) {
                content = `
                    <div>üé¨ –í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                    <div class="video-circle-message" onclick="playVideoMessage('${message.fileData}', ${message.duration || 0})">
                        <div class="video-circle-play-btn">‚ñ∂Ô∏è</div>
                        <div class="video-circle-duration">${message.duration || 0}s</div>
                        <div class="video-circle-progress">
                            <div class="video-circle-progress-bar" id="video-progress-${messageId}"></div>
                        </div>
                    </div>
                    <div class="video-chunk-info">
                        <div>–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ —á–∞—Å—Ç—è–º (${formatFileSize(message.fileSize || 0)})</div>
                        <div class="video-chunk-progress">
                            <div class="video-chunk-progress-bar">
                                <div class="video-chunk-progress-fill" style="width: 100%"></div>
                            </div>
                            <div class="video-chunk-text">–°–æ–±—Ä–∞–Ω–æ</div>
                        </div>
                    </div>
                    <button class="file-download-btn" onclick="downloadLargeVideo('${message.fileData}')">
                        ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ
                    </button>
                `;
            } else {
                content = `
                    <div>üé¨ –í–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                    <div class="video-circle-message" onclick="playVideoMessage('${message.fileData || ''}', ${message.duration || 0})">
                        <video id="video-${messageId}" style="display: none;"></video>
                        <div class="video-circle-play-btn">‚ñ∂Ô∏è</div>
                        <div class="video-circle-duration">${message.duration || 0}s</div>
                        <div class="video-circle-progress">
                            <div class="video-circle-progress-bar" id="video-progress-${messageId}"></div>
                        </div>
                    </div>
                    <button class="file-download-btn" onclick="downloadFileFromMessage('${message.fileData || ''}', '${message.fileName || 'videomessage.webm'}', '${message.fileType || 'video/webm'}')">
                        ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ
                    </button>
                `;
            }
            
            div.innerHTML = content;
            
        } else if (message.type === 'file' || message.type === 'image' || (message.type === 'video' && !message.isVideoCircle)) {
            div.className = `message ${isOwn ? 'message-out' : 'message-in'} fade-in`;
            
            if (isOwn && currentFileUploads.has(messageId)) {
                const uploadData = currentFileUploads.get(messageId);
                const sendingIndicator = document.createElement('div');
                sendingIndicator.className = 'sending-indicator';
                sendingIndicator.innerHTML = '<div class="loading"></div>';
                
                const progressContainer = createUploadProgress(messageId, uploadData.fileName, uploadData.fileSize);
                progressContainer.container.style.position = 'relative';
                progressContainer.container.style.marginTop = '10px';
                
                div.appendChild(sendingIndicator);
                div.appendChild(progressContainer.container);
                
                if (uploadData.progress > 0) {
                    progressContainer.progressBar.style.width = `${uploadData.progress}%`;
                    progressContainer.text.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${uploadData.progress}%`;
                }
            }
        } else {
            div.className = `message ${isOwn ? 'message-out' : 'message-in'} fade-in`;
            
            if (isOwn && message.sending) {
                const sendingIndicator = document.createElement('div');
                sendingIndicator.className = 'sending-indicator';
                sendingIndicator.innerHTML = '<div class="loading"></div>';
                div.appendChild(sendingIndicator);
            }
        }
        
        const time = message.createdAt ? formatTime(message.createdAt) : '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        
        let statusIcon = '';
        if (isOwn) {
            if (message.read) {
                statusIcon = '<span class="message-status status-read">‚úì‚úì</span>';
            } else {
                statusIcon = '<span class="message-status status-sent">‚úì</span>';
            }
        }
        
        let content = '';
        let reactionsHTML = '';
        
        if (message.reactions) {
            const reactions = [];
            for (const [emoji, users] of Object.entries(message.reactions)) {
                if (users && users.length > 0) {
                    const count = users.length;
                    const isOwnReaction = users.includes(currentUser.id);
                    reactions.push(`
                        <div class="reaction-badge ${isOwnReaction ? 'own-reaction' : ''}" onclick="addReaction('${messageId}', '${emoji}')">
                            ${emoji} ${count}
                        </div>
                    `);
                }
            }
            if (reactions.length > 0) {
                reactionsHTML = `<div class="message-reactions">${reactions.join('')}</div>`;
            }
        }
        
        if (message.type === 'call' && !(isCallDisabled && !isOwn)) {
            const isActive = message.callActive === true;
            const canJoin = isActive && 
                          (message.senderId !== currentUser.id || 
                           (currentCallId === message.callId && activeCall));
            
            content = `
                <div style="text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 10px;">${message.callType === 'video' ? 'üìπ' : 'üìû'}</div>
                    <div>${message.text}</div>
                    ${canJoin ? `
                        <button class="join-call-message-btn" data-call-id="${message.callId}" style="margin-top: 15px;">
                            üìû –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∑–≤–æ–Ω–∫—É
                        </button>
                    ` : ''}
                </div>
            `;
        } else if (message.type === 'call_end') {
            content = `
                <div style="text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 10px;">${message.text.includes('–≤–∏–¥–µ–æ') ? 'üìπ' : 'üìû'}</div>
                    <div>${message.text}</div>
                </div>
            `;
        } else if (message.type === 'file') {
            content = `
                <div>${message.text || '–§–∞–π–ª'}</div>
                <div class="file-message" onclick="downloadFileFromMessage('${message.fileData}', '${message.fileName}', '${message.fileType}')">
                    <div class="file-icon">${getFileIcon(message.fileType)}</div>
                    <div class="file-info">
                        <div class="file-name">${message.fileName}</div>
                        <div class="file-size">${formatFileSize(message.fileSize)}</div>
                    </div>
                </div>
                <button class="file-download-btn" onclick="downloadFileFromMessage('${message.fileData}', '${message.fileName}', '${message.fileType}')">
                    ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                </button>
            `;
        } else if (message.type === 'image') {
            content = `
                <div>${message.text || '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'}</div>
                <div class="image-message" onclick="previewImage('${message.fileData}', '${message.fileName}')">
                    <img src="${message.fileData}" alt="${message.fileName}" 
                         style="max-height: 400px; cursor: zoom-in;">
                </div>
                <button class="file-download-btn" onclick="downloadFileFromMessage('${message.fileData}', '${message.fileName}', '${message.fileType}')">
                    ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                </button>
            `;
        } else if (message.type === 'video' && !message.isVideoCircle) {
            content = `
                <div>${message.text || '–í–∏–¥–µ–æ'}</div>
                <div class="video-message" onclick="previewVideo('${message.fileData}', '${message.fileName}')">
                    <video style="width: 100%; max-height: 400px; border-radius: 10px;">
                        <source src="${message.fileData}" type="${message.fileType}">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                    </video>
                    <div class="video-play-btn">‚ñ∂Ô∏è</div>
                </div>
                <button class="file-download-btn" onclick="downloadFileFromMessage('${message.fileData}', '${message.fileName}', '${message.fileType}')">
                    ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ
                </button>
            `;
        } else if (message.type === 'audio') {
            content = `
                <div>${message.text || '–ê—É–¥–∏–æ'}</div>
                <div class="file-message" onclick="downloadFileFromMessage('${message.fileData}', '${message.fileName}', '${message.fileType}')">
                    <div class="file-icon">üéµ</div>
                    <div class="file-info">
                        <div class="file-name">${message.fileName}</div>
                        <div class="file-size">${formatFileSize(message.fileSize)}</div>
                    </div>
                </div>
                <button class="file-download-btn" onclick="downloadFileFromMessage('${message.fileData}', '${message.fileName}', '${message.fileType}')">
                    ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ
                </button>
            `;
        } else if (message.type === 'voice') {
            const duration = message.duration ? Math.round(message.duration) : 0;
            content = `
                <div>–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                <div class="voice-message" onclick="playVoiceMessage('${message.voiceData}')">
                    <div class="voice-icon">üé§</div>
                    <div class="voice-duration">${duration}s</div>
                    <div class="voice-wave"></div>
                </div>
                <button class="file-download-btn" onclick="downloadVoiceMessage('${message.voiceData}', '${duration}')">
                    ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ
                </button>
            `;
        } else {
            const text = message.text.replace(/\n/g, '<br>');
            const edited = message.edited ? ' <span style="font-size: 10px; opacity: 0.6;">(—Ä–µ–¥.)</span>' : '';
            content = `<div>${text}${edited}</div>`;
        }
        
        const actionsHTML = isOwn ? `
            <div class="message-actions">
                <button class="message-action-btn" onclick="showEditMessageModal('${messageId}', '${message.text.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                <button class="message-action-btn" onclick="addReaction('${messageId}', 'üëç')">üëç</button>
                <button class="message-action-btn" onclick="addReaction('${messageId}', '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                <button class="message-action-btn" onclick="addReaction('${messageId}', 'üòÇ')">üòÇ</button>
            </div>
        ` : `
            <div class="message-actions">
                <button class="message-action-btn" onclick="addReaction('${messageId}', 'üëç')">üëç</button>
                <button class="message-action-btn" onclick="addReaction('${messageId}', '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                <button class="message-action-btn" onclick="addReaction('${messageId}', 'üòÇ')">üòÇ</button>
            </div>
        `;
        
        if (!div.innerHTML.includes(content) && !(message.type === 'video' && message.isVideoCircle)) {
            if (currentChat && currentChat.isGroup && !isOwn && !isSystem) {
                div.innerHTML = `
                    <div class="message-sender">${message.senderName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}</div>
                    ${content}
                    ${reactionsHTML}
                    <div class="message-time">${time} ${statusIcon}</div>
                    ${actionsHTML}
                `;
            } else {
                div.innerHTML = `
                    ${content}
                    ${reactionsHTML}
                    <div class="message-time">${time} ${statusIcon}</div>
                    ${actionsHTML}
                `;
            }
        }
        
        container.appendChild(div);
        
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }

    async function sendMessage() {
        if (isSendingMessage) return;
        
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        
        if (!text || !currentChat || !currentUser) return;
        
        isSendingMessage = true;
        const btn = document.getElementById('sendMessageBtn');
        const btnText = btn.innerHTML;
        btn.innerHTML = '<div class="loading"></div>';
        btn.disabled = true;
        
        try {
            const messageId = 'msg_' + Date.now();
            
            if (authError) {
                const message = {
                    id: messageId,
                    chatId: currentChat.id,
                    senderId: currentUser.id,
                    text: text,
                    type: 'text',
                    createdAt: new Date(),
                    read: false,
                    senderName: currentUser.name,
                    sending: true
                };
                
                addMessageToChat(message);
                
                const messages = JSON.parse(localStorage.getItem('absgram_messages') || '[]');
                messages.push(message);
                localStorage.setItem('absgram_messages', JSON.stringify(messages));
                
                const chats = JSON.parse(localStorage.getItem('absgram_chats') || '[]');
                const chatIndex = chats.findIndex(c => c.id === currentChat.id);
                if (chatIndex !== -1) {
                    chats[chatIndex].lastMessage = text.length > 50 ? text.substring(0, 50) + '...' : text;
                    chats[chatIndex].updatedAt = new Date();
                    localStorage.setItem('absgram_chats', JSON.stringify(chats));
                }
                
                setTimeout(() => {
                    const messageElement = document.getElementById(`message-${messageId}`);
                    if (messageElement) {
                        const sendingIndicator = messageElement.querySelector('.sending-indicator');
                        if (sendingIndicator) {
                            sendingIndicator.remove();
                        }
                    }
                }, 1000);
                
                input.value = '';
                input.style.height = 'auto';
                
                loadChats();
                
                btn.innerHTML = btnText;
                btn.disabled = true;
                isSendingMessage = false;
                input.focus();
                return;
            }
            
            const tempMessage = {
                id: messageId,
                chatId: currentChat.id,
                senderId: currentUser.id,
                text: text,
                type: 'text',
                createdAt: new Date(),
                senderName: currentUser.name,
                sending: true
            };
            
            addMessageToChat(tempMessage);
            
            const messageData = {
                chatId: currentChat.id,
                senderId: currentUser.id,
                text: text,
                type: 'text',
                createdAt: serverTimestamp(),
                read: false
            };
            
            const docRef = await addDoc(collection(db, 'messages'), messageData);
            
            await updateDoc(doc(db, 'chats', currentChat.id), {
                lastMessage: text.length > 50 ? text.substring(0, 50) + '...' : text,
                updatedAt: serverTimestamp()
            });
            
            const messageElement = document.getElementById(`message-${messageId}`);
            if (messageElement) {
                const sendingIndicator = messageElement.querySelector('.sending-indicator');
                if (sendingIndicator) {
                    sendingIndicator.remove();
                }
            }
            
            input.value = '';
            input.style.height = 'auto';
            
            loadChats();
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
            
            const messageElement = document.getElementById(`message-${messageId}`);
            if (messageElement) {
                const sendingIndicator = messageElement.querySelector('.sending-indicator');
                if (sendingIndicator) {
                    sendingIndicator.remove();
                }
            }
            
            btn.innerHTML = btnText;
            btn.disabled = false;
            isSendingMessage = false;
            return;
        }
        
        btn.innerHTML = btnText;
        btn.disabled = true;
        isSendingMessage = false;
        
        input.focus();
    }

    async function handleFileUpload(files) {
        if (!files || !currentChat || !currentUser) return;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            try {
                const maxFileSize = 500 * 1024 * 1024; // 500MB
                if (file.size > maxFileSize) {
                    showNotification(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${formatFileSize(file.size)}). –ú–∞–∫—Å–∏–º—É–º 500MB.`, 'error');
                    continue;
                }
                
                const fileType = file.type || 'application/octet-stream';
                const fileName = file.name;
                const fileSize = file.size;
                
                if (file.size > 500 * 1024) {
                    showNotification(`–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –±–æ–ª—å—à–æ–≥–æ —Ñ–∞–π–ª–∞ ${fileName} (${formatFileSize(fileSize)})...`, 'info');
                    
                    const messageType = fileType.startsWith('image/') ? 'image' : 
                                      fileType.startsWith('video/') ? 'video' : 'file';
                    
                    const success = await sendLargeFile(file, currentChat.id, messageType);
                    
                    if (success) {
                        loadMessages(currentChat.id);
                        loadChats();
                    }
                    
                } else {
                    const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    
                    const base64Data = await readFileAsBase64(file);
                    
                    const messageType = fileType.startsWith('image/') ? 'image' : 
                                      fileType.startsWith('video/') ? 'video' : 
                                      fileType.startsWith('audio/') ? 'audio' : 'file';
                    
                    const messageText = fileType.startsWith('image/') ? '[–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]' :
                                      fileType.startsWith('video/') ? '[–í–∏–¥–µ–æ]' : 
                                      fileType.startsWith('audio/') ? '[–ê—É–¥–∏–æ]' : '[–§–∞–π–ª]';
                    
                    const messageData = {
                        chatId: currentChat.id,
                        senderId: currentUser.id,
                        text: messageText,
                        type: messageType,
                        fileData: base64Data,
                        fileName: fileName,
                        fileType: fileType,
                        fileSize: fileSize,
                        createdAt: serverTimestamp(),
                        read: false
                    };
                    
                    await addDoc(collection(db, 'messages'), messageData);
                    
                    let lastMessage = messageText;
                    if (messageType === 'image') {
                        lastMessage = 'üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                    } else if (messageType === 'video') {
                        lastMessage = 'üé¨ –í–∏–¥–µ–æ';
                    } else if (messageType === 'audio') {
                        lastMessage = 'üéµ –ê—É–¥–∏–æ';
                    } else {
                        lastMessage = `üìé ${fileName.substring(0, 20)}${fileName.length > 20 ? '...' : ''}`;
                    }
                    
                    await updateDoc(doc(db, 'chats', currentChat.id), {
                        lastMessage: lastMessage,
                        updatedAt: serverTimestamp()
                    });
                    
                    showNotification('–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞:', error);
                showNotification(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ "${file.name}": ${error.message}`, 'error');
            }
        }
        
        document.getElementById('fileUpload').value = '';
    }

    function startVoiceRecording() {
        if (isRecording) return;
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ', 'error');
            return;
        }
        
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    sendVoiceMessage(audioBlob);
                    
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();
                
                document.getElementById('voiceBtn').classList.add('recording');
                document.getElementById('recordingTime').style.display = 'block';
                
                recordingTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('recordingTime').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (elapsed >= 120) {
                        stopVoiceRecording();
                    }
                }, 1000);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
            });
    }

    function stopVoiceRecording() {
        if (!isRecording || !mediaRecorder) return;
        
        mediaRecorder.stop();
        isRecording = false;
        
        if (recordingTimer) {
            clearInterval(recordingTimer);
            recordingTimer = null;
        }
        
        document.getElementById('voiceBtn').classList.remove('recording');
        document.getElementById('recordingTime').style.display = 'none';
    }

    async function sendVoiceMessage(audioBlob) {
        if (!currentChat || !currentUser) return;
        
        showLoading(true);
        
        try {
            const reader = new FileReader();
            reader.onload = async function(event) {
                const base64Audio = event.target.result;
                const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                
                if (authError) {
                    const messageId = 'msg_' + Date.now();
                    const message = {
                        id: messageId,
                        chatId: currentChat.id,
                        senderId: currentUser.id,
                        text: '[–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]',
                        type: 'voice',
                        voiceData: base64Audio,
                        duration: duration,
                        createdAt: new Date(),
                        read: false,
                        senderName: currentUser.name
                    };
                    
                    const messages = JSON.parse(localStorage.getItem('absgram_messages') || '[]');
                    messages.push(message);
                    localStorage.setItem('absgram_messages', JSON.stringify(messages));
                    
                    const chats = JSON.parse(localStorage.getItem('absgram_chats') || '[]');
                    const chatIndex = chats.findIndex(c => c.id === currentChat.id);
                    if (chatIndex !== -1) {
                        chats[chatIndex].lastMessage = 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
                        chats[chatIndex].updatedAt = new Date();
                        localStorage.setItem('absgram_chats', JSON.stringify(chats));
                    }
                    
                    addMessageToChat(message);
                    loadChats();
                    showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                    showLoading(false);
                    return;
                }
                
                const messageData = {
                    chatId: currentChat.id,
                    senderId: currentUser.id,
                    text: '[–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]',
                    type: 'voice',
                    voiceData: base64Audio,
                    duration: duration,
                    createdAt: serverTimestamp(),
                    read: false
                };
                
                await addDoc(collection(db, 'messages'), messageData);
                
                await updateDoc(doc(db, 'chats', currentChat.id), {
                    lastMessage: 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                    updatedAt: serverTimestamp()
                });
                
                showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                loadChats();
                showLoading(false);
            };
            
            reader.readAsDataURL(audioBlob);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
            showLoading(false);
        }
    }

    function playVoiceMessage(base64Data) {
        const audioPlayer = document.getElementById('audioPlayer');
        audioPlayer.src = base64Data;
        audioPlayer.play();
    }

    function downloadVoiceMessage(base64Data, duration) {
        downloadFileFromMessage(base64Data, `–≥–æ–ª–æ—Å–æ–≤–æ–µ_—Å–æ–æ–±—â–µ–Ω–∏–µ_${duration}—Å.webm`, 'audio/webm');
    }

    function previewImage(base64Data, fileName) {
        document.getElementById('previewedImage').src = base64Data;
        document.getElementById('imagePreviewModal').classList.remove('hidden');
    }

    function previewVideo(base64Data, fileName) {
        const video = document.getElementById('previewedVideo');
        video.src = base64Data;
        document.getElementById('videoPreviewModal').classList.remove('hidden');
        video.play();
    }

    function playVideoMessage(base64Data, duration) {
        const video = document.getElementById('videoMessagePreview');
        video.src = base64Data;
        document.getElementById('videoMessagePreviewModal').classList.remove('hidden');
        video.play();
    }

    function requestNotificationPermission() {
        if (notificationPermissionAsked) return;
        
        if (!("Notification" in window)) {
            console.log("–≠—Ç–æ—Ç –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.");
            return;
        }
        
        if (Notification.permission === "default") {
            setTimeout(() => {
                if (!notificationPermissionAsked) {
                    document.getElementById('notificationPermission').classList.remove('hidden');
                    notificationPermissionAsked = true;
                }
            }, 5000);
        } else if (Notification.permission === "granted") {
            setupMessageNotifications();
            setupCallListeners();
        }
    }

    function setupMessageNotifications() {
        if (!currentUser || authError) return;
        
        try {
            const notificationsQuery = query(
                collection(db, 'messages'),
                where('read', '==', false)
            );
            
            onSnapshot(notificationsQuery, (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added') {
                        const message = change.doc.data();
                        
                        if (message.senderId === currentUser.id) return;
                        if (message.type === 'call') return;
                        if (currentChat && message.chatId === currentChat.id) return;
                        
                        let chatName = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
                        if (message.chatId) {
                            try {
                                const chatDoc = await getDoc(doc(db, 'chats', message.chatId));
                                if (chatDoc.exists()) {
                                    const chatData = chatDoc.data();
                                    if (chatData.isGroup) {
                                        chatName = chatData.groupName + ' üë•';
                                    } else if (chatData.isChannel) {
                                        chatName = chatData.channelName + ' üì¢';
                                    } else {
                                        const otherUserId = chatData.participants.find(id => id !== currentUser.id);
                                        if (otherUserId) {
                                            const userDoc = await getDoc(doc(db, 'users', otherUserId));
                                            if (userDoc.exists()) {
                                                const userData = userDoc.data();
                                                chatName = getUserDisplayName(userData);
                                            }
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ:', error);
                            }
                        }
                        
                        let notificationText = message.text || '';
                        if (message.type === 'image') {
                            notificationText = 'üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                        } else if (message.type === 'video') {
                            notificationText = 'üé¨ –í–∏–¥–µ–æ';
                        } else if (message.type === 'audio') {
                            notificationText = 'üéµ –ê—É–¥–∏–æ';
                        } else if (message.type === 'file') {
                            notificationText = `üìé –§–∞–π–ª: ${message.fileName || '–§–∞–π–ª'}`;
                        } else if (message.type === 'voice') {
                            notificationText = 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
                        }
                        
                        showPushNotification(chatName, notificationText);
                    }
                });
            }, (error) => {
                console.error('–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
        }
    }

    function setupChatUserStatusListener() {
        if (!currentChat || currentChat.isGroup || currentChat.isChannel || !currentChat.otherUser) return;
        
        try {
            const userRef = doc(db, 'users', currentChat.otherUser.id);
            
            const unsubscribe = onSnapshot(userRef, (doc) => {
                if (doc.exists()) {
                    const userData = doc.data();
                    const lastActive = userData.lastActive ? 
                        (userData.lastActive.toDate ? userData.lastActive.toDate() : new Date(userData.lastActive)) : 
                        new Date(0);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastActive) / (1000 * 60));
                    
                    const isOnline = diffMinutes < 2;
                    
                    if (isOnline) {
                        document.getElementById('chatStatus').innerHTML = '<span class="user-status real-online">üü¢ online</span>';
                        document.getElementById('chatStatus').style.color = '#4CAF50';
                    } else {
                        document.getElementById('chatStatus').innerHTML = '<span class="user-status real-offline">‚ö´ –Ω–µ –≤ —Å–µ—Ç–∏</span>';
                        document.getElementById('chatStatus').style.color = '#aaa';
                    }
                }
            });
            
            return unsubscribe;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
        }
    }

    function setupOnlineStatusListener() {
        if (!currentUser || authError) return;
        
        try {
            const userRef = doc(db, 'users', currentUser.id);
            
            onlineStatusInterval = setInterval(() => {
                if (!authError) {
                    updateDoc(userRef, {
                        isOnline: true,
                        lastActive: serverTimestamp()
                    }).catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–ª–∞–π–Ω:', error);
                    });
                }
            }, 30000);
            
            window.addEventListener('beforeunload', () => {
                if (!authError) {
                    updateDoc(userRef, {
                        isOnline: false,
                        lastActive: serverTimestamp()
                    }).catch(console.error);
                }
            });
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª—É—à–∞—Ç–µ–ª—è —Å—Ç–∞—Ç—É—Å–∞:', error);
        }
    }

    // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
    function init() {
        console.log("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AbSgram 7.0...");
        initEventListeners();
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω:", user.uid);
                await loadUserData(user.uid);
                
                if (currentUser) {
                    console.log("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ");
                    showScreen('chatsScreen');
                    await loadAllUsersForSearch();
                    await loadChats();
                    loadAllNicknames();
                    setupOnlineStatusListener();
                    requestNotificationPermission();
                    setupCallListeners();
                    updateUnreadCounts();
                    loadCallsDisabledState();
                }
            } else {
                console.log("üîí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω");
                
                const savedUser = localStorage.getItem('absgram_user');
                if (savedUser) {
                    const userData = JSON.parse(savedUser);
                    const now = Date.now();
                    const savedTime = userData.timestamp;
                    
                    if (now - savedTime < 24 * 60 * 60 * 1000) {
                        console.log("üì± –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
                        authError = true;
                        
                        const localUser = localStorage.getItem('absgram_user_local');
                        if (localUser) {
                            currentUser = JSON.parse(localUser);
                            showScreen('chatsScreen');
                            await loadChats();
                            loadAllNicknames();
                            updateUnreadCounts();
                            loadCallsDisabledState();
                        } else {
                            showScreen('authScreen');
                        }
                    } else {
                        showScreen('authScreen');
                    }
                } else {
                    showScreen('authScreen');
                }
            }
        });
        
        console.log("‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
    }

    window.removeFromGroup = removeFromGroup;
    window.playVoiceMessage = playVoiceMessage;
    window.downloadVoiceMessage = downloadVoiceMessage;
    window.downloadFileFromMessage = downloadFileFromMessage;
    window.previewImage = previewImage;
    window.previewVideo = previewVideo;
    window.playVideoMessage = playVideoMessage;
    window.downloadLargeFile = downloadLargeFile;
    window.downloadLargeVideo = downloadLargeVideo;
    window.showEditMessageModal = showEditMessageModal;
    window.addReaction = addReaction;

    init();
    </script>
</body>
</html>